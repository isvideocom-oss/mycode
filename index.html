<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Core Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #050816;
      --bg-elevated: #0b1220;
      --card: #111827;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.15);
      --accent-strong: #16a34a;
      --danger: #f97373;
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --border-soft: #1f2937;
      --tag-bg: #111827;
      --tag-border: #1f2937;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      font-family: -apple-system, system-ui, BlinkMacSystemFont, "SF Pro Text",
        sans-serif;
      background: radial-gradient(circle at top, #0b1120 0, #020617 45%, #000 100%);
      color: var(--text-main);
      display: flex;
      justify-content: center;
    }

    .app {
      width: 100%;
      max-width: 480px;
      min-height: 100vh;
      padding: 16px 12px 24px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      gap: 8px;
    }

    .app-title {
      font-weight: 700;
      letter-spacing: 0.03em;
      font-size: 18px;
    }

    .app-subtitle {
      font-size: 11px;
      color: var(--text-muted);
    }

    .settings-btn {
      width: 30px;
      height: 30px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-muted);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      cursor: pointer;
      user-select: none;
      padding: 0;
    }

    .settings-btn:active {
      transform: scale(0.96);
      background: #020617;
    }

    .nav-tabs {
      display: flex;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 999px;
      padding: 4px;
      border: 1px solid var(--border-soft);
      margin-bottom: 8px;
    }

    .nav-tab {
      flex: 1;
      padding: 8px 0;
      border-radius: 999px;
      text-align: center;
      font-size: 13px;
      cursor: pointer;
      user-select: none;
      transition: background 0.15s ease, color 0.15s ease;
      color: var(--text-muted);
    }

    .nav-tab.active {
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: #0b1120;
      font-weight: 600;
    }

    .content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding-bottom: 16px;
    }

    .card {
      background: linear-gradient(145deg, #020617, #020617);
      border-radius: 18px;
      padding: 14px 14px 12px;
      border: 1px solid var(--border-soft);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.9);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      gap: 8px;
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      padding: 3px 7px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
    }

    .card-subtitle {
      font-size: 11px;
      color: var(--text-muted);
    }

    .balance-value {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .balance-label {
      font-size: 11px;
      color: var(--text-muted);
    }

    .btn-row {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      margin-bottom: 4px;
      flex-wrap: wrap;
    }

    .btn {
      flex: 1;
      border-radius: 999px;
      padding: 8px 10px;
      border: 1px solid var(--border-soft);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-main);
      font-size: 12px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      user-select: none;
      transition: background 0.12s ease, border-color 0.12s ease,
        transform 0.05s ease;
    }

    .btn:active {
      transform: scale(0.98);
      background: #020617;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      border-color: transparent;
      color: #020617;
      font-weight: 600;
    }

    .btn-ghost {
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-main);
    }

    .btn-small {
      padding: 4px 8px;
      font-size: 11px;
      border-radius: 999px;
      flex: 0;
    }

    .btn-outline {
      border-color: var(--border-soft);
      background: transparent;
      color: var(--text-muted);
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid var(--tag-border);
      background: var(--tag-bg);
      font-size: 10px;
      color: var(--text-muted);
    }

    .tag-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--accent);
    }

    .section-title {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .section-subtitle {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .list {
      max-height: 180px;
      overflow-y: auto;
      padding-right: 2px;
      margin: 0;
    }

    .list::-webkit-scrollbar {
      width: 3px;
    }

    .list::-webkit-scrollbar-thumb {
      background: #1f2937;
      border-radius: 999px;
    }

    .tx-item,
    .goal-item,
    .payment-item {
      padding: 6px 0;
      border-bottom: 1px dashed rgba(31, 41, 55, 0.9);
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .tx-main {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      gap: 8px;
    }

    .tx-amount {
      font-weight: 600;
      white-space: nowrap;
    }

    .tx-amount.income {
      color: var(--accent);
    }

    .tx-amount.expense {
      color: var(--danger);
    }

    .tx-meta {
      font-size: 10px;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .muted {
      color: var(--text-muted);
      font-size: 11px;
    }

    .empty {
      font-size: 11px;
      color: var(--text-muted);
      font-style: italic;
      margin-top: 4px;
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 2px;
    }

    .chip {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid var(--border-soft);
      color: var(--text-muted);
    }

    .pill-small {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(34, 197, 94, 0.12);
      color: var(--accent);
    }

    /* Forms (bottom sheet) */

    .sheet-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.65);
      backdrop-filter: blur(8px);
      display: none;
      justify-content: flex-end;
      z-index: 30;
    }

    .sheet-backdrop.visible {
      display: flex;
    }

    .sheet {
      width: 100%;
      max-width: 480px;
      background: #020617;
      border-radius: 18px 18px 0 0;
      border-top: 1px solid var(--border-soft);
      padding: 10px 14px 14px;
      box-shadow: 0 -22px 40px rgba(0, 0, 0, 0.8);
    }

    .sheet-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .sheet-title {
      font-size: 14px;
      font-weight: 600;
    }

    .sheet-close {
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-muted);
      font-size: 11px;
      padding: 4px 8px;
      cursor: pointer;
    }

    .field-group {
      margin-bottom: 8px;
    }

    .field-label {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 3px;
    }

    .field-input,
    .field-textarea,
    .field-select {
      width: 100%;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-main);
      padding: 7px 9px;
      font-size: 12px;
      outline: none;
    }

    .field-input:focus,
    .field-textarea:focus,
    .field-select:focus {
      border-color: var(--accent);
    }

    .field-textarea {
      min-height: 48px;
      resize: vertical;
    }

    .field-row {
      display: flex;
      gap: 8px;
    }

    .helper-text {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    /* Short goal schedule */

    .schedule-list {
      max-height: 160px;
      overflow-y: auto;
      padding-right: 2px;
      margin-top: 4px;
    }

    .schedule-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 4px 0;
      border-bottom: 1px dashed rgba(31, 41, 55, 0.9);
      font-size: 11px;
      gap: 6px;
    }

    .sched-left {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .sched-date {
      font-weight: 500;
    }

    .sched-plan {
      color: var(--text-muted);
      font-size: 10px;
    }

    .sched-status {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-muted);
      white-space: nowrap;
    }

    .sched-status.done {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(34, 197, 94, 0.1);
    }

    .sched-status.skipped {
      border-color: var(--danger);
      color: var(--danger);
      background: rgba(248, 113, 113, 0.08);
    }

    .sched-btn-row {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .sched-btn {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-main);
      cursor: pointer;
      white-space: nowrap;
    }

    .sched-btn-primary {
      border-color: var(--accent);
      color: var(--accent);
    }

    /* Goals lists */

    .goal-type-pill {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-muted);
      white-space: nowrap;
    }

    .goal-type-pill[data-type="day"] {
      color: #f97316;
      border-color: #f97316;
      background: rgba(248, 148, 62, 0.08);
    }

    .goal-type-pill[data-type="week"] {
      color: #38bdf8;
      border-color: #38bdf8;
      background: rgba(56, 189, 248, 0.08);
    }

    .goal-type-pill[data-type="month"] {
      color: #a855f7;
      border-color: #a855f7;
      background: rgba(168, 85, 247, 0.08);
    }

    .goal-type-pill[data-type="none"] {
      color: var(--text-muted);
    }

    .badge-link {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(34, 197, 94, 0.08);
      color: var(--accent);
      border: 1px solid rgba(34, 197, 94, 0.3);
      white-space: nowrap;
    }

    .small-inline {
      font-size: 10px;
      color: var(--text-muted);
    }

    .mono {
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      width: 100%;
      min-height: 90px;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-main);
      padding: 6px 8px;
      resize: vertical;
    }

    .mono:focus {
      border-color: var(--accent);
      outline: none;
    }

    /* Analytics */

    .analytics-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px 10px;
      margin-top: 4px;
    }

    .analytics-item {
      font-size: 11px;
      color: var(--text-muted);
    }

    .analytics-label {
      font-size: 10px;
      color: var(--text-muted);
    }

    .analytics-value {
      font-size: 12px;
      color: var(--text-main);
      font-weight: 500;
    }

    .day-row {
      margin-bottom: 6px;
    }

    .day-main {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
    }

    .day-label {
      color: var(--text-main);
    }

    .day-net {
      font-weight: 500;
    }

    .day-bar {
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: #020617;
      overflow: hidden;
      margin: 3px 0;
    }

    .day-bar-fill {
      height: 100%;
      float: left;
    }

    .day-bar-fill.done {
      background: var(--accent-strong);
    }

    .day-bar-fill.skipped {
      background: var(--danger);
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: #020617;
      overflow: hidden;
      margin: 4px 0;
    }

    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent-strong));
    }

    /* Subtasks */

    .subtask-list {
      list-style: none;
      padding-left: 0;
      margin: 4px 0 0;
    }

    .subtask-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .subtask-item label {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    .subtask-toggle {
      accent-color: var(--accent);
    }

    /* Calendar for non-working dates */

    .calendar-chip {
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-muted);
      cursor: pointer;
    }

    .calendar-chip.selected {
      border-color: var(--danger);
      color: var(--danger);
      background: rgba(248, 113, 113, 0.12);
    }

    .achievements-list {
      list-style: none;
      padding-left: 0;
      margin: 4px 0 0;
      font-size: 11px;
      color: var(--text-muted);
    }

    .achievement-item {
      padding: 4px 0;
      border-bottom: 1px dashed rgba(31, 41, 55, 0.7);
    }

    .achievement-title {
      color: var(--text-main);
      font-weight: 500;
      font-size: 11px;
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="app-header">
      <div>
        <div class="app-title">Core Tracker</div>
        <div class="app-subtitle">финансы · цели · дисциплина</div>
      </div>
      <button class="settings-btn" id="btn-backup" aria-label="настройки">⚙</button>
    </header>

    <nav class="nav-tabs">
      <div class="nav-tab active" data-tab="finance">Финансы</div>
      <div class="nav-tab" data-tab="goals">Цели</div>
      <div class="nav-tab" data-tab="analytics">Аналитика</div>
    </nav>

    <main class="content" id="content"></main>
  </div>

  <!-- Bottom sheets (modals) -->
  <div class="sheet-backdrop" id="sheet-backdrop">
    <div class="sheet" id="sheet">
      <div class="sheet-header">
        <div class="sheet-title" id="sheet-title"></div>
        <button class="sheet-close" id="sheet-close">закрыть</button>
      </div>
      <div id="sheet-body"></div>
    </div>
  </div>

  <script>
    // ====== STATE & STORAGE ======

    const STORAGE_KEY = "core_tracker_state_v1";

    const defaultState = {
      balance: 0,
      transactions: [], // {id, type, amount, note, tags[], dateISO}
      monthlyPayments: [], // {id,title,amount,dayOfMonth,description,tags[]}
      shortGoals: [], // {id,title,amount,totalAmount,remaining,deadlineISO,createdISO,nonWorkingDates[], schedule:[{dateISO,planned,status}],tags[]}
      goals: [], // {id,title,description,type,createdISO,deadlineISO|null,tags[],linkedShortGoalId|null,subtasks:[]}
      allocations: [] // {id,goalType,goalId,amount,dateISO}
    };

    let state = loadState();

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return structuredClone(defaultState);
        const parsed = JSON.parse(raw);
        const merged = { ...structuredClone(defaultState), ...parsed };

        // ensure structures
        merged.shortGoals = (merged.shortGoals || []).map((g) => {
          const total =
            typeof g.totalAmount === "number"
              ? g.totalAmount
              : typeof g.amount === "number"
              ? g.amount
              : typeof g.remaining === "number"
              ? g.remaining
              : 0;
          const remaining =
            typeof g.remaining === "number" ? g.remaining : total;
          return {
            nonWorkingDates: [],
            schedule: [],
            tags: [],
            ...g,
            totalAmount: total,
            remaining
          };
        });

        merged.goals = (merged.goals || []).map((g) => ({
          subtasks: [],
          ...g
        }));

        merged.allocations = merged.allocations || [];

        return merged;
      } catch (e) {
        console.error("Failed to load state", e);
        return structuredClone(defaultState);
      }
    }

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      render();
    }

    // ====== UTILITIES ======

    function uuid() {
      return Math.random().toString(36).slice(2) + Date.now().toString(36);
    }

    function formatDate(dateISO) {
      const d = new Date(dateISO);
      if (Number.isNaN(d.getTime())) return "";
      const day = String(d.getDate()).padStart(2, "0");
      const month = String(d.getMonth() + 1).padStart(2, "0");
      return `${day}.${month}`;
    }

    function todayISO() {
      return new Date().toISOString().slice(0, 10);
    }

    function parseTags(str) {
      if (!str) return [];
      return str
        .split(",")
        .map((t) => t.trim())
        .filter(Boolean);
    }

    function tagsToHTML(tags) {
      if (!tags || !tags.length) return "";
      return (
        `<div class="chip-row">` +
        tags.map((t) => `<span class="chip">#${t}</span>`).join("") +
        `</div>`
      );
    }

    function compareDateISO(a, b) {
      if (a < b) return -1;
      if (a > b) return 1;
      return 0;
    }

    function addDaysISO(dateISO, days) {
      const d = new Date(dateISO);
      d.setDate(d.getDate() + days);
      return d.toISOString().slice(0, 10);
    }

    function weekdayShort(dateISO) {
      const d = new Date(dateISO);
      if (Number.isNaN(d.getTime())) return "";
      const idx = d.getDay(); // 0 = вс
      const map = ["вс", "пн", "вт", "ср", "чт", "пт", "сб"];
      return map[idx] || "";
    }

    // allocations
    function allocationsFor(goalType, goalId) {
      return (state.allocations || []).filter(
        (a) => a.goalType === goalType && a.goalId === goalId
      );
    }

    function allocatedTotal(goalType, goalId) {
      return allocationsFor(goalType, goalId).reduce(
        (sum, a) => sum + (a.amount || 0),
        0
      );
    }

    // schedule generator
    function generateSchedule(createdISO, deadlineISO, totalAmount, nonWorkingDates) {
      const skipSet = new Set(nonWorkingDates || []);
      const scheduleDates = [];
      let cursor = createdISO;
      while (compareDateISO(cursor, deadlineISO) <= 0) {
        if (!skipSet.has(cursor)) {
          scheduleDates.push(cursor);
        }
        cursor = addDaysISO(cursor, 1);
      }
      const workDaysCount = scheduleDates.length || 1;
      const perDayRaw = totalAmount / workDaysCount;
      const perDay = Math.floor(perDayRaw);
      const remainder = Math.round(totalAmount - perDay * workDaysCount);

      return scheduleDates.map((d, idx) => ({
        dateISO: d,
        planned: perDay + (idx === 0 ? remainder : 0),
        status: "pending"
      }));
    }

    // progress helpers
    function shortGoalProgressPercent(g) {
      if (!g || !g.totalAmount) return 0;
      const done = g.totalAmount - g.remaining;
      return Math.min(100, Math.max(0, Math.round((done / g.totalAmount) * 100)));
    }

    function monthlyPaymentProgressPercent(p) {
      if (!p || !p.amount) return 0;
      const alloc = allocatedTotal("monthly", p.id);
      return Math.min(100, Math.max(0, Math.round((alloc / p.amount) * 100)));
    }

    function taskGoalProgressPercent(goal) {
      const subs = goal.subtasks || [];
      if (!subs.length) return 0;
      const done = subs.filter((s) => s.done).length;
      return Math.round((done / subs.length) * 100);
    }

    // ====== ANALYTICS HELPERS ======

    function computeFinanceAnalytics() {
      const today = todayISO();
      const [y, m] = today.split("-");
      const monthPrefix = `${y}-${m}`;
      const txMonth = state.transactions.filter(
        (tx) => tx.dateISO && tx.dateISO.startsWith(monthPrefix)
      );

      let monthIncome = 0;
      let monthExpense = 0;
      const tagStats = {};

      txMonth.forEach((tx) => {
        const sign = tx.type === "income" ? 1 : -1;
        if (tx.type === "income") monthIncome += tx.amount;
        else monthExpense += tx.amount;
        (tx.tags || []).forEach((tag) => {
          if (!tagStats[tag]) tagStats[tag] = 0;
          tagStats[tag] += sign * tx.amount;
        });
      });

      const tagEntries = Object.entries(tagStats).sort(
        (a, b) => Math.abs(b[1]) - Math.abs(a[1])
      );
      const topTags = tagEntries.slice(0, 3).map(([tag, val]) => ({
        tag,
        value: val
      }));

      const todayDate = new Date(today);
      const todayDay = todayDate.getDate();
      const upcomingPayments = state.monthlyPayments.filter((p) => {
        return p.dayOfMonth >= todayDay && p.dayOfMonth <= todayDay + 3;
      });

      const allShort = state.shortGoals.length;
      const completedShort = state.shortGoals.filter((g) => g.remaining <= 0)
        .length;
      const activeShort = allShort - completedShort;

      // текущие задачи по фин. целям на сегодня
      let tasksTodayCount = 0;
      let tasksTodayPlanned = 0;
      state.shortGoals.forEach((g) => {
        (g.schedule || []).forEach((d) => {
          if (d.dateISO === today && d.status === "pending") {
            tasksTodayCount += 1;
            tasksTodayPlanned += d.planned || 0;
          }
        });
      });

      // дни с транзакциями — серия
      const txDaysSet = new Set(
        state.transactions.map((tx) => tx.dateISO).filter(Boolean)
      );
      let currentStreak = 0;
      let cursor = today;
      for (let i = 0; i < 60; i++) {
        if (txDaysSet.has(cursor)) {
          currentStreak += 1;
          cursor = addDaysISO(cursor, -1);
        } else {
          break;
        }
      }
      const totalActiveDays = txDaysSet.size;

      let streakText = "можно начать серию с сегодняшнего дня";
      if (currentStreak >= 7) {
        streakText = "огонь: неделя без провалов по деньгам";
      } else if (currentStreak >= 3) {
        streakText = "есть серия: держишь ритм, не сбавляй";
      } else if (currentStreak >= 1) {
        streakText = "старт есть: важен не идеал, а продолжение";
      }

      // последние 7 дней
      const lastDays = [];
      for (let offset = 6; offset >= 0; offset--) {
        const dateISO = addDaysISO(today, -offset);
        const txDay = state.transactions.filter((tx) => tx.dateISO === dateISO);
        let net = 0;
        txDay.forEach((tx) => {
          net += tx.type === "income" ? tx.amount : -tx.amount;
        });

        let tasksTotal = 0;
        let tasksDone = 0;
        let tasksSkipped = 0;
        state.shortGoals.forEach((g) => {
          (g.schedule || []).forEach((d) => {
            if (d.dateISO === dateISO) {
              tasksTotal += 1;
              if (d.status === "done") tasksDone += 1;
              if (d.status === "skipped") tasksSkipped += 1;
            }
          });
        });

        lastDays.push({
          dateISO,
          net,
          tasksTotal,
          tasksDone,
          tasksSkipped
        });
      }

      return {
        monthIncome,
        monthExpense,
        monthNet: monthIncome - monthExpense,
        hasMonthData: txMonth.length > 0,
        topTags,
        upcomingPaymentsCount: upcomingPayments.length,
        allShort,
        completedShort,
        activeShort,
        tasksTodayCount,
        tasksTodayPlanned,
        currentStreak,
        totalActiveDays,
        streakText,
        lastDays
      };
    }

    function computeGoalsAnalytics() {
      const goalsByType = state.goals.reduce(
        (acc, g) => {
          acc[g.type] = (acc[g.type] || 0) + 1;
          return acc;
        },
        { day: 0, week: 0, month: 0, none: 0 }
      );

      let totalSubtasks = 0;
      let doneSubtasks = 0;
      state.goals.forEach((g) => {
        const subs = g.subtasks || [];
        totalSubtasks += subs.length;
        doneSubtasks += subs.filter((s) => s.done).length;
      });

      const progressSubtasks =
        totalSubtasks > 0 ? Math.round((doneSubtasks / totalSubtasks) * 100) : 0;

      const recentGoals = [...state.goals]
        .sort((a, b) => (a.createdISO < b.createdISO ? 1 : -1))
        .slice(0, 5)
        .map((g) => {
          const subs = g.subtasks || [];
          const done = subs.filter((s) => s.done).length;
          return {
            id: g.id,
            title: g.title,
            type: g.type,
            createdISO: g.createdISO,
            deadlineISO: g.deadlineISO,
            subtasksTotal: subs.length,
            subtasksDone: done
          };
        });

      return {
        goalsByType,
        totalSubtasks,
        doneSubtasks,
        progressSubtasks,
        recentGoals
      };
    }

    // ====== RENDER ROOT ======

    let activeTab = "finance";
    let analyticsMode = "finance"; // finance | goals

    const contentEl = document.getElementById("content");

    function render() {
      if (activeTab === "finance") {
        renderFinance();
      } else if (activeTab === "goals") {
        renderGoals();
      } else {
        renderAnalytics();
      }
    }

    // ====== RENDER FINANCE TAB ======

    function renderFinance() {
      contentEl.innerHTML = "";

      const today = todayISO();
      const todayDate = new Date(today);

      // Balance card (на руках)
      const balanceCard = document.createElement("section");
      balanceCard.className = "card";
      balanceCard.innerHTML = `
        <div class="card-header">
          <div>
            <div class="card-title">
              Баланс
              <span class="pill">
                <span class="tag-dot"></span>
                на руках
              </span>
            </div>
            <div class="card-subtitle">текущие свободные деньги</div>
          </div>
          <button class="btn btn-small btn-outline" id="btn-set-balance">править</button>
        </div>
        <div class="balance-value">${state.balance.toLocaleString("ru-RU")} ₽</div>
        <div class="balance-label">можно изменить баланс напрямую или через операции</div>
        <div class="btn-row">
          <button class="btn btn-primary" id="btn-add-income">+ доход</button>
          <button class="btn btn-ghost" id="btn-add-expense">− расход</button>
        </div>
        <div class="section-title">
          <span>История</span>
        </div>
        <div class="list" id="tx-list"></div>
      `;
      contentEl.appendChild(balanceCard);

      const txListEl = balanceCard.querySelector("#tx-list");
      if (!state.transactions.length) {
        txListEl.innerHTML = `<div class="empty">операций пока нет</div>`;
      } else {
        const sortedTx = [...state.transactions].sort((a, b) =>
          a.dateISO < b.dateISO ? 1 : -1
        );
        txListEl.innerHTML = sortedTx
          .map((tx) => {
            return `
            <div class="tx-item">
              <div class="tx-main">
                <span>${tx.note || "(без описания)"}</span>
                <span class="tx-amount ${tx.type}">
                  ${tx.type === "income" ? "+" : "−"}${tx.amount.toLocaleString(
              "ru-RU"
            )} ₽
                </span>
              </div>
              <div class="tx-meta">
                <span>${formatDate(tx.dateISO)}</span>
                <button class="btn btn-small btn-outline" data-del-tx="${
                  tx.id
                }">удалить</button>
              </div>
            </div>
          `;
          })
          .join("");
      }

      // Monthly payments
      const paymentsCard = document.createElement("section");
      paymentsCard.className = "card";
      paymentsCard.innerHTML = `
        <div class="card-header">
          <div>
            <div class="card-title">Ежемесячные платежи</div>
            <div class="card-subtitle">подписки, квартира, обязательства</div>
          </div>
          <button class="btn btn-small btn-outline" id="btn-add-monthly">+ добавить</button>
        </div>
        <div class="list" id="payments-list"></div>
      `;
      contentEl.appendChild(paymentsCard);

      const paymentsListEl = paymentsCard.querySelector("#payments-list");
      if (!state.monthlyPayments.length) {
        paymentsListEl.innerHTML =
          '<div class="empty">пока нет ежемесячных целей</div>';
      } else {
        const sorted = [...state.monthlyPayments].sort(
          (a, b) => a.dayOfMonth - b.dayOfMonth
        );
        paymentsListEl.innerHTML = sorted
          .map((p) => {
            let dueDate = new Date(
              todayDate.getFullYear(),
              todayDate.getMonth(),
              p.dayOfMonth
            );
            if (dueDate < todayDate) {
              dueDate = new Date(
                todayDate.getFullYear(),
                todayDate.getMonth() + 1,
                p.dayOfMonth
              );
            }
            const diffMs = dueDate - todayDate;
            const diffDays = Math.round(diffMs / (1000 * 60 * 60 * 24));

            const alloc = allocatedTotal("monthly", p.id);
            const remaining = Math.max(p.amount - alloc, 0);
            const perc = monthlyPaymentProgressPercent(p);

            return `
            <div class="payment-item">
              <div class="tx-main">
                <div style="display:flex;align-items:center;gap:6px;">
                  <div style="width:16px;height:16px;border-radius:50%;background:
                    conic-gradient(var(--accent) ${perc}%, rgba(255,255,255,0.1) ${perc}%);">
                  </div>
                  <span>${p.title}</span>
                </div>
                <span class="tx-amount expense">${p.amount.toLocaleString(
                  "ru-RU"
                )} ₽</span>
              </div>
              <div class="tx-meta">
                <span>${p.dayOfMonth}-го числа${
              diffDays === 0
                ? ", сегодня"
                : diffDays > 0
                ? `, через ${diffDays} дн.`
                : ""
            }</span>
                <span>собрано ${alloc.toLocaleString(
                  "ru-RU"
                )} / ${p.amount.toLocaleString("ru-RU")} ₽ · осталось ${remaining.toLocaleString(
              "ru-RU"
            )} ₽</span>
              </div>
              ${p.description ? `<div class="muted">${p.description}</div>` : ""}
              ${tagsToHTML(p.tags)}
            </div>
          `;
          })
          .join("");
      }

      // Short financial goals
      const goalsCard = document.createElement("section");
      goalsCard.className = "card";
      goalsCard.innerHTML = `
        <div class="card-header">
          <div>
            <div class="card-title">Краткосрочные фин. цели</div>
            <div class="card-subtitle">накопить к дате, расписание по дням</div>
          </div>
          <button class="btn btn-small btn-outline" id="btn-add-short-goal">+ цель</button>
        </div>
        <div class="list" id="short-goals-list"></div>
      `;
      contentEl.appendChild(goalsCard);

      const shortListEl = goalsCard.querySelector("#short-goals-list");
      if (!state.shortGoals.length) {
        shortListEl.innerHTML =
          '<div class="empty">краткосрочных целей пока нет</div>';
      } else {
        const sortedShort = [...state.shortGoals].sort((a, b) =>
          compareDateISO(a.deadlineISO, b.deadlineISO)
        );
        shortListEl.innerHTML = sortedShort
          .map((g) => {
            const daysLeft =
              (new Date(g.deadlineISO) - todayDate) /
              (1000 * 60 * 60 * 24);
            const perc = shortGoalProgressPercent(g);
            const done = g.totalAmount - g.remaining;
            return `
            <div class="goal-item">
              <div class="tx-main">
                <div style="display:flex;align-items:center;gap:6px;">
                  <div style="width:16px;height:16px;border-radius:50%;background:
                    conic-gradient(var(--accent) ${perc}%, rgba(255,255,255,0.1) ${perc}%);">
                  </div>
                  <span>${g.title}</span>
                </div>
                <span class="tx-amount income">${g.remaining.toLocaleString(
                  "ru-RU"
                )} ₽</span>
              </div>
              <div class="tx-meta">
                <span>дедлайн: ${formatDate(g.deadlineISO)}</span>
                <span>${
                  daysLeft >= 0
                    ? `осталось ~${Math.ceil(daysLeft)} дн`
                    : "дедлайн прошёл"
                }</span>
              </div>
              <div class="small-inline">
                прогресс: ${done.toLocaleString("ru-RU")} / ${g.totalAmount.toLocaleString(
              "ru-RU"
            )} ₽ (${perc}%)
              </div>
              <div class="chip-row">
                <span class="pill-small">план в день ~ ${(
                  g.remaining /
                  Math.max(
                    1,
                    g.schedule.filter((d) => d.status === "pending").length
                  )
                ).toFixed(0)} ₽</span>
                <button class="btn btn-small btn-outline" data-open-goal="${
                  g.id
                }">расписание</button>
              </div>
              ${tagsToHTML(g.tags)}
            </div>
          `;
          })
          .join("");
      }

      // Свободные деньги: распределение
      const spareCard = document.createElement("section");
      spareCard.className = "card";
      spareCard.innerHTML = `
        <div class="card-header">
          <div>
            <div class="card-title">Свободные деньги</div>
            <div class="card-subtitle">распределение на фин. цели</div>
          </div>
        </div>
        <div class="list" id="spare-list"></div>
      `;
      contentEl.appendChild(spareCard);

      const spareListEl = spareCard.querySelector("#spare-list");

      function collectFinGoals() {
        const arr = [];
        state.shortGoals.forEach((g) => arr.push({ kind: "short", goal: g }));
        state.monthlyPayments.forEach((g) =>
          arr.push({ kind: "monthly", goal: g })
        );
        return arr;
      }

      const finGoals = collectFinGoals();

      if (!finGoals.length) {
        spareListEl.innerHTML = `<div class="empty">пока нет финансовых целей для распределения</div>`;
      } else {
        spareListEl.innerHTML = finGoals
          .map(({ kind, goal }) => {
            let perc = 0;
            let collected = 0;
            let target = 0;
            let lineInfo = "";

            if (kind === "short") {
              perc = shortGoalProgressPercent(goal);
              collected = goal.totalAmount - goal.remaining;
              target = goal.totalAmount;
              const alloc = allocatedTotal("short", goal.id);
              lineInfo = `по плану собрано ${collected.toLocaleString(
                "ru-RU"
              )} / ${target.toLocaleString(
                "ru-RU"
              )} ₽ · из баланса выделено ${alloc.toLocaleString("ru-RU")} ₽`;
            } else {
              perc = monthlyPaymentProgressPercent(goal);
              const alloc = allocatedTotal("monthly", goal.id);
              collected = alloc;
              target = goal.amount;
              const remaining = Math.max(target - collected, 0);
              lineInfo = `собрано ${collected.toLocaleString(
                "ru-RU"
              )} / ${target.toLocaleString(
                "ru-RU"
              )} ₽ · осталось ${remaining.toLocaleString("ru-RU")} ₽`;
            }

            const goalTypeForAttr = kind === "short" ? "short" : "monthly";

            return `
            <div class="payment-item">
              <div class="tx-main">
                <div style="display:flex;align-items:center;gap:6px;">
                  <div style="width:16px;height:16px;border-radius:50%;background:
                    conic-gradient(var(--accent) ${perc}%, rgba(255,255,255,0.1) ${perc}%);">
                  </div>
                  <span>${goal.title}</span>
                </div>
                <span class="tx-amount income">${Math.max(
                  0,
                  collected
                ).toLocaleString("ru-RU")} ₽</span>
              </div>
              <div class="small-inline">${lineInfo}</div>
              <div class="chip-row" style="margin-top:4px;">
                <button class="btn btn-small btn-outline" data-alloc="${
                  goal.id
                }" data-alloc-type="${goalTypeForAttr}">+ выделить</button>
                <button class="btn btn-small" data-undo-alloc="${
                  goal.id
                }" data-alloc-type="${goalTypeForAttr}">отменить</button>
              </div>
            </div>
          `;
          })
          .join("");
      }

      // Attach handlers
      balanceCard
        .querySelector("#btn-add-income")
        .addEventListener("click", () => openTxSheet("income"));
      balanceCard
        .querySelector("#btn-add-expense")
        .addEventListener("click", () => openTxSheet("expense"));
      balanceCard
        .querySelector("#btn-set-balance")
        .addEventListener("click", () => openBalanceSheet());

      paymentsCard
        .querySelector("#btn-add-monthly")
        .addEventListener("click", () => openMonthlySheet());
      goalsCard
        .querySelector("#btn-add-short-goal")
        .addEventListener("click", () => openShortGoalSheet());

      goalsCard.querySelectorAll("[data-open-goal]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-open-goal");
          const goal = state.shortGoals.find((g) => g.id === id);
          if (goal) openShortGoalScheduleSheet(goal);
        });
      });

      // delete tx
      txListEl?.querySelectorAll("[data-del-tx]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-del-tx");
          const tx = state.transactions.find((t) => t.id === id);
          if (!tx) return;
          if (tx.type === "income") state.balance -= tx.amount;
          else state.balance += tx.amount;
          state.transactions = state.transactions.filter((t) => t.id !== id);
          saveState();
        });
      });

      // allocations
      spareCard.querySelectorAll("[data-alloc]").forEach((b) => {
        b.addEventListener("click", () => {
          const id = b.getAttribute("data-alloc");
          const type = b.getAttribute("data-alloc-type");
          const goal =
            type === "short"
              ? state.shortGoals.find((g) => g.id === id)
              : state.monthlyPayments.find((g) => g.id === id);
          if (goal) openAllocationSheet(goal, type);
        });
      });

      spareCard.querySelectorAll("[data-undo-alloc]").forEach((b) => {
        b.addEventListener("click", () => {
          const id = b.getAttribute("data-undo-alloc");
          const type = b.getAttribute("data-alloc-type");
          const goal =
            type === "short"
              ? state.shortGoals.find((g) => g.id === id)
              : state.monthlyPayments.find((g) => g.id === id);
          if (goal) openUndoAllocationSheet(goal, type);
        });
      });
    }

    // ====== RENDER GOALS TAB ======

    function renderGoals() {
      contentEl.innerHTML = "";

      const goalsCard = document.createElement("section");
      goalsCard.className = "card";
      goalsCard.innerHTML = `
        <div class="card-header">
          <div>
            <div class="card-title">Задачи и цели</div>
            <div class="card-subtitle">день · неделя · месяц · без срока</div>
          </div>
          <button class="btn btn-small btn-outline" id="btn-add-goal">+ цель</button>
        </div>
        <div class="section-title">Активные</div>
        <div class="list" id="goals-list"></div>
      `;
      contentEl.appendChild(goalsCard);

      const listEl = goalsCard.querySelector("#goals-list");
      if (!state.goals.length) {
        listEl.innerHTML = `<div class="empty">целей пока нет</div>`;
      } else {
        const sorted = [...state.goals].sort((a, b) => {
          const order = { day: 0, week: 1, month: 2, none: 3 };
          if (order[a.type] !== order[b.type]) {
            return order[a.type] - order[b.type];
          }
          return a.createdISO < b.createdISO ? 1 : -1;
        });

        listEl.innerHTML = sorted
          .map((g) => {
            const subs = g.subtasks || [];
            const tProgress = taskGoalProgressPercent(g);
            let finProgressText = "";
            if (g.linkedShortGoalId) {
              const sg = state.shortGoals.find(
                (x) => x.id === g.linkedShortGoalId
              );
              if (sg) {
                const p = shortGoalProgressPercent(sg);
                finProgressText = `фин. прогресс: ${p}%`;
              }
            }
            return `
            <div class="goal-item">
              <div class="tx-main">
                <div style="display:flex;align-items:center;gap:6px;">
                  <div style="width:16px;height:16px;border-radius:50%;background:
                    conic-gradient(var(--accent) ${tProgress}%, rgba(255,255,255,0.1) ${tProgress}%);">
                  </div>
                  <span>${g.title}</span>
                </div>
                <span class="goal-type-pill" data-type="${g.type}">
                  ${
                    g.type === "day"
                      ? "день"
                      : g.type === "week"
                      ? "неделя"
                      : g.type === "month"
                      ? "месяц"
                      : "без срока"
                  }
                </span>
              </div>
              <div class="tx-meta">
                <span>создано: ${formatDate(g.createdISO)}</span>
                <span>${
                  g.deadlineISO ? "до " + formatDate(g.deadlineISO) : ""
                }</span>
              </div>
              <div class="small-inline">
                прогресс по шагам: ${
                  subs.length
                    ? `${subs.filter((s) => s.done).length} / ${
                        subs.length
                      } (${tProgress}%)`
                    : "микроцели не заданы"
                }
              </div>
              ${
                finProgressText
                  ? `<div class="small-inline">${finProgressText}</div>`
                  : ""
              }
              ${
                g.linkedShortGoalId
                  ? `<div class="chip-row"><span class="badge-link">есть финансовая цель</span></div>`
                  : ""
              }
              <div class="muted">${g.description || ""}</div>
              ${
                subs.length
                  ? `<ul class="subtask-list">
                      ${subs
                        .map(
                          (s) => `
                        <li class="subtask-item">
                          <label>
                            <input type="checkbox"
                              class="subtask-toggle"
                              data-goal-id="${g.id}"
                              data-subtask-id="${s.id}"
                              ${s.done ? "checked" : ""} />
                            <span>${s.title}</span>
                          </label>
                        </li>`
                        )
                        .join("")}
                    </ul>`
                  : ""
              }
              <div class="chip-row" style="margin-top:6px;">
                <button class="btn btn-small btn-outline" data-edit-goal="${
                  g.id
                }">изменить</button>
              </div>
              ${tagsToHTML(g.tags)}
            </div>
          `;
          })
          .join("");
      }

      goalsCard
        .querySelector("#btn-add-goal")
        .addEventListener("click", () => openGoalSheet());

      // toggle subtasks
      goalsCard.addEventListener("change", (e) => {
        const checkbox = e.target.closest(".subtask-toggle");
        if (!checkbox) return;
        const goalId = checkbox.getAttribute("data-goal-id");
        const subId = checkbox.getAttribute("data-subtask-id");
        const goal = state.goals.find((g) => g.id === goalId);
        if (!goal) return;
        const sub = (goal.subtasks || []).find((s) => s.id === subId);
        if (!sub) return;
        sub.done = checkbox.checked;
        saveState();
      });

      goalsCard.querySelectorAll("[data-edit-goal]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-edit-goal");
          const goal = state.goals.find((g) => g.id === id);
          if (goal) openGoalEditSheet(goal);
        });
      });
    }

    // ====== RENDER ANALYTICS TAB ======

    function renderAnalytics() {
      contentEl.innerHTML = "";

      const card = document.createElement("section");
      card.className = "card";
      card.innerHTML = `
        <div class="card-header">
          <div>
            <div class="card-title">Аналитика</div>
            <div class="card-subtitle">визуальный срез по финансам и целям</div>
          </div>
          <div class="btn-row" style="gap:4px;margin:0;">
            <button class="btn btn-small ${
              analyticsMode === "finance" ? "btn-primary" : "btn-outline"
            }" data-analytics-mode="finance">финансы</button>
            <button class="btn btn-small ${
              analyticsMode === "goals" ? "btn-primary" : "btn-outline"
            }" data-analytics-mode="goals">цели</button>
          </div>
        </div>
        <div id="analytics-body"></div>
      `;
      contentEl.appendChild(card);

      const body = card.querySelector("#analytics-body");
      if (analyticsMode === "finance") {
        renderFinanceAnalytics(body);
      } else {
        renderGoalsAnalytics(body);
      }

      card.querySelectorAll("[data-analytics-mode]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const mode = btn.getAttribute("data-analytics-mode");
          if (mode && mode !== analyticsMode) {
            analyticsMode = mode;
            renderAnalytics();
          }
        });
      });
    }

    function renderFinanceAnalytics(container) {
      const a = computeFinanceAnalytics();

      let html = "";

      html += `
        <div class="section-title">
          <span>Текущий месяц</span>
        </div>
      `;

      if (a.hasMonthData) {
        html += `
          <div class="analytics-grid">
            <div class="analytics-item">
              <div class="analytics-label">доход</div>
              <div class="analytics-value">+${a.monthIncome.toLocaleString(
                "ru-RU"
              )} ₽</div>
            </div>
            <div class="analytics-item">
              <div class="analytics-label">расход</div>
              <div class="analytics-value">−${a.monthExpense.toLocaleString(
                "ru-RU"
              )} ₽</div>
            </div>
            <div class="analytics-item">
              <div class="analytics-label">итог месяца</div>
              <div class="analytics-value">${(a.monthNet >= 0 ? "+" : "−") +
                Math.abs(a.monthNet).toLocaleString("ru-RU")} ₽</div>
            </div>
            <div class="analytics-item">
              <div class="analytics-label">активные дни</div>
              <div class="analytics-value">${a.totalActiveDays}</div>
            </div>
          </div>
        `;
      } else {
        html += `<div class="empty">в этом месяце пока нет данных по операциям</div>`;
      }

      html += `
        <div class="section-title" style="margin-top:8px;">
          <span>Сегодня и ближайшие дни</span>
        </div>
        <div class="analytics-grid">
          <div class="analytics-item">
            <div class="analytics-label">задачи по целям на сегодня</div>
            <div class="analytics-value">${a.tasksTodayCount}</div>
            <div class="helper-text">${
              a.tasksTodayCount
                ? "план на сегодня ~ " +
                  a.tasksTodayPlanned.toLocaleString("ru-RU") +
                  " ₽"
                : "на сегодня нет запланированных сумм по целям"
            }</div>
          </div>
          <div class="analytics-item">
            <div class="analytics-label">платежи в ближайшие 3 дня</div>
            <div class="analytics-value">${a.upcomingPaymentsCount}</div>
          </div>
        </div>
        <div class="section-title" style="margin-top:8px;">
          <span>Краткосрочные цели</span>
        </div>
        <div class="analytics-grid">
          <div class="analytics-item">
            <div class="analytics-label">фин. цели</div>
            <div class="analytics-value">${a.activeShort} активных / ${
        a.allShort
      }</div>
          </div>
          <div class="analytics-item">
            <div class="analytics-label">серия по деньгам</div>
            <div class="analytics-value">${a.currentStreak} дн.</div>
            <div class="helper-text">${a.streakText}</div>
          </div>
        </div>
        <div class="section-title" style="margin-top:8px;">
          <span>Последние 7 дней</span>
        </div>
      ";

      if (!a.lastDays.length) {
        html += `<div class="empty">нет данных по дням</div>`;
      } else {
        html += a.lastDays
          .map((d) => {
            const total = d.tasksTotal || 0;
            const donePerc = total ? Math.round((d.tasksDone / total) * 100) : 0;
            const skipPerc = total
              ? Math.round((d.tasksSkipped / total) * 100)
              : 0;
            const netLabel =
              d.net === 0
                ? "0 ₽"
                : (d.net > 0 ? "+" : "−") +
                  Math.abs(d.net).toLocaleString("ru-RU") +
                  " ₽";
            return `
              <div class="day-row">
                <div class="day-main">
                  <span class="day-label">${formatDate(d.dateISO)}</span>
                  <span class="day-net">${netLabel}</span>
                </div>
                <div class="day-bar">
                  <div class="day-bar-fill done" style="width:${donePerc}%;"></div>
                  <div class="day-bar-fill skipped" style="width:${skipPerc}%;"></div>
                </div>
                <div class="small-inline">
                  целей: ${total}, сделано: ${d.tasksDone}, пропущено: ${
              d.tasksSkipped
            }
                </div>
              </div>
            `;
          })
          .join("");
      }

      html += `
        <div class="section-title" style="margin-top:8px;">
          <span>Теги</span>
        </div>
      `;

      if (a.topTags.length) {
        html += `<div class="chip-row">`;
        html += a.topTags
          .map(
            (t) => `
          <span class="chip">#${t.tag} · ${
              t.value >= 0 ? "+" : "−"
            }${Math.abs(t.value).toLocaleString("ru-RU")} ₽</span>
        `
          )
          .join("");
        html += `</div>`;
      } else {
        html += `<div class="empty">ещё нет статистики по тегам</div>`;
      }

      // achievements / gamification
      const achievements = [];

      if (a.currentStreak >= 3) {
        achievements.push({
          title: "Серия держится",
          text: "3+ дня подряд с учётом денег. Это уже режим, а не случайность."
        });
      }
      if (a.currentStreak >= 7) {
        achievements.push({
          title: "Железная неделя",
          text: "7 дней подряд ты держал денежный фокус. Это прям серьёзная заявка."
        });
      }
      if (a.monthNet > 0) {
        achievements.push({
          title: "Месяц в плюсе",
          text: "Расходы ниже доходов. Ты не просто выживаешь, а набираешь обороты."
        });
      }
      if (a.completedShort > 0) {
        achievements.push({
          title: "Финальные удары по целям",
          text: `Закрыл ${a.completedShort} краткосрочных фин. целей. Ты умеешь доводить до конца.`
        });
      }

      html += `
        <div class="section-title" style="margin-top:8px;">
          <span>Достижения</span>
        </div>
      `;

      if (!achievements.length) {
        html += `<div class="empty">достижения появятся, как только начнёшь двигать деньги осознанно</div>`;
      } else {
        html += `<ul class="achievements-list">`;
        html += achievements
          .map(
            (ach) => `
          <li class="achievement-item">
            <div class="achievement-title">${ach.title}</div>
            <div>${ach.text}</div>
          </li>
        `
          )
          .join("");
        html += `</ul>`;
      }

      container.innerHTML = html;
    }

    function renderGoalsAnalytics(container) {
      const a = computeGoalsAnalytics();

      let html = `
        <div class="section-title">
          <span>Общий срез</span>
        </div>
        <div class="analytics-grid">
          <div class="analytics-item">
            <div class="analytics-label">цели по типам</div>
            <div class="analytics-value">
              д: ${a.goalsByType.day} · н: ${a.goalsByType.week} · м: ${
        a.goalsByType.month
      } · б/с: ${a.goalsByType.none}
            </div>
          </div>
          <div class="analytics-item">
            <div class="analytics-label">микроцели всего</div>
            <div class="analytics-value">${a.totalSubtasks}</div>
          </div>
        </div>
        <div class="section-title" style="margin-top:8px;">
          <span>Прогресс по микроцелям</span>
        </div>
      `;

      if (a.totalSubtasks === 0) {
        html += `<div class="empty">микроцели пока не созданы</div>`;
      } else {
        html += `
          <div class="progress-bar">
            <div class="progress-bar-fill" style="width:${a.progressSubtasks}%;"></div>
          </div>
          <div class="small-inline">
            выполнено ${a.doneSubtasks} из ${a.totalSubtasks} (${a.progressSubtasks}%)
          </div>
        `;
      }

      html += `
        <div class="section-title" style="margin-top:8px;">
          <span>Последние цели</span>
        </div>
      `;

      if (!a.recentGoals.length) {
        html += `<div class="empty">целей пока нет</div>`;
      } else {
        html += a.recentGoals
          .map((g) => {
            return `
            <div class="goal-item">
              <div class="tx-main">
                <span>${g.title}</span>
                <span class="goal-type-pill" data-type="${g.type}">
                  ${
                    g.type === "day"
                      ? "день"
                      : g.type === "week"
                      ? "неделя"
                      : g.type === "month"
                      ? "месяц"
                      : "без срока"
                  }
                </span>
              </div>
              <div class="tx-meta">
                <span>создано: ${formatDate(g.createdISO)}</span>
                <span>${
                  g.deadlineISO ? "до " + formatDate(g.deadlineISO) : ""
                }</span>
              </div>
              <div class="small-inline">
                микроцели: ${g.subtasksDone} / ${g.subtasksTotal}
              </div>
            </div>
          `;
          })
          .join("");
      }

      const goalAchievements = [];
      if (a.totalSubtasks >= 5) {
        goalAchievements.push({
          title: "Разбил по шагам",
          text: "У тебя уже несколько микроцелей. Это не прокрастинация, а системный подход."
        });
      }
      if (a.progressSubtasks >= 50 && a.totalSubtasks > 0) {
        goalAchievements.push({
          title: "Больше половины сделано",
          text: "Бетон уже залит, осталось поднять этажи. Главное — не тормозить."
        });
      }

      html += `
        <div class="section-title" style="margin-top:8px;">
          <span>Достижения</span>
        </div>
      `;

      if (!goalAchievements.length) {
        html += `<div class="empty">как только начнёшь закрывать микроцели, тут появятся награды</div>`;
      } else {
        html += `<ul class="achievements-list">`;
        html += goalAchievements
          .map(
            (ach) => `
          <li class="achievement-item">
            <div class="achievement-title">${ach.title}</div>
            <div>${ach.text}</div>
          </li>
        `
          )
          .join("");
        html += `</ul>`;
      }

      container.innerHTML = html;
    }

    // ====== SHEET (MODAL) UTILS ======

    const backdropEl = document.getElementById("sheet-backdrop");
    const sheetTitleEl = document.getElementById("sheet-title");
    const sheetBodyEl = document.getElementById("sheet-body");
    const sheetCloseBtn = document.getElementById("sheet-close");

    sheetCloseBtn.addEventListener("click", closeSheet);
    backdropEl.addEventListener("click", (e) => {
      if (e.target === backdropEl) closeSheet();
    });

    function openSheet(title, innerHTML) {
      sheetTitleEl.textContent = title;
      sheetBodyEl.innerHTML = innerHTML;
      backdropEl.classList.add("visible");
    }

    function closeSheet() {
      backdropEl.classList.remove("visible");
      sheetBodyEl.innerHTML = "";
    }

    // ====== SHEETS IMPLEMENTATION ======

    // Add income/expense
    function openTxSheet(type) {
      openSheet(
        type === "income" ? "Добавить доход" : "Добавить расход",
        `
        <div class="field-group">
          <div class="field-label">Сумма</div>
          <input type="number" id="tx-amount" class="field-input" inputmode="decimal" />
        </div>
        <div class="field-group">
          <div class="field-label">Описание</div>
          <input type="text" id="tx-note" class="field-input" placeholder="зарплата, еда, транспорт..." />
        </div>
        <div class="field-group">
          <div class="field-label">Теги</div>
          <input type="text" id="tx-tags" class="field-input" placeholder="через запятую: работа, быт..." />
          <div class="helper-text">для удобной группировки (например: квартира, еда, психолог)</div>
        </div>
        <div class="field-group">
          <div class="field-label">Дата</div>
          <input type="date" id="tx-date" class="field-input" value="${todayISO()}" />
        </div>
        <button class="btn btn-primary" id="tx-save">сохранить</button>
      `
      );

      document.getElementById("tx-amount").focus();

      document.getElementById("tx-save").addEventListener("click", () => {
        const amountVal = parseFloat(
          document.getElementById("tx-amount").value.replace(",", ".")
        );
        if (!amountVal || amountVal <= 0) return;
        const note = document.getElementById("tx-note").value.trim();
        const tags = parseTags(document.getElementById("tx-tags").value);
        const dateISO = document.getElementById("tx-date").value || todayISO();

        const tx = {
          id: uuid(),
          type,
          amount: Math.round(amountVal),
          note,
          tags,
          dateISO
        };

        state.transactions.push(tx);
        if (type === "income") {
          state.balance += tx.amount;
        } else {
          state.balance -= tx.amount;
        }

        saveState();
        closeSheet();
      });
    }

    // Balance manual set
    function openBalanceSheet() {
      openSheet(
        "Настроить баланс",
        `
        <div class="field-group">
          <div class="field-label">Баланс на руках, ₽</div>
          <input type="number" id="bal-value" class="field-input" inputmode="decimal" value="${state.balance}" />
          <div class="helper-text">это не создаст транзакцию, просто обновит цифру баланса</div>
        </div>
        <button class="btn btn-primary" id="bal-save">сохранить</button>
      `
      );

      document.getElementById("bal-value").focus();

      document.getElementById("bal-save").addEventListener("click", () => {
        const val = parseFloat(
          document.getElementById("bal-value").value.replace(",", ".")
        );
        if (Number.isNaN(val)) return;
        state.balance = Math.round(val);
        saveState();
        closeSheet();
      });
    }

    // Add monthly payment
    function openMonthlySheet() {
      openSheet(
        "Добавить ежемесячный платёж",
        `
        <div class="field-group">
          <div class="field-label">Название</div>
          <input type="text" id="mp-title" class="field-input" placeholder="квартира, подписка, аделина..." />
        </div>
        <div class="field-group field-row">
          <div style="flex:1">
            <div class="field-label">Сумма, ₽</div>
            <input type="number" id="mp-amount" class="field-input" inputmode="decimal" />
          </div>
          <div style="width:40%">
            <div class="field-label">День месяца</div>
            <input type="number" id="mp-day" class="field-input" min="1" max="31" />
          </div>
        </div>
        <div class="field-group">
          <div class="field-label">Описание</div>
          <input type="text" id="mp-desc" class="field-input" placeholder="комментарий (опционально)" />
        </div>
        <div class="field-group">
          <div class="field-label">Теги</div>
          <input type="text" id="mp-tags" class="field-input" placeholder="жильё, подписки..." />
        </div>
        <button class="btn btn-primary" id="mp-save">сохранить</button>
      `
      );

      document.getElementById("mp-title").focus();

      document.getElementById("mp-save").addEventListener("click", () => {
        const title = document.getElementById("mp-title").value.trim();
        if (!title) return;
        const amountVal = parseFloat(
          document.getElementById("mp-amount").value.replace(",", ".")
        );
        if (!amountVal || amountVal <= 0) return;
        const day = parseInt(document.getElementById("mp-day").value, 10);
        if (!day || day < 1 || day > 31) return;
        const description = document
          .getElementById("mp-desc")
          .value.trim();
        const tags = parseTags(document.getElementById("mp-tags").value);

        state.monthlyPayments.push({
          id: uuid(),
          title,
          amount: Math.round(amountVal),
          dayOfMonth: day,
          description,
          tags
        });

        saveState();
        closeSheet();
      });
    }

    // Short goals undo history (in-memory)
    const lastGoalSnapshots = {}; // goalId -> JSON string

    // Add short financial goal
    function openShortGoalSheet(prefill = {}) {
      const today = todayISO();
      openSheet(
        "Краткосрочная финансовая цель",
        `
        <div class="field-group">
          <div class="field-label">Название цели</div>
          <input type="text" id="sg-title" class="field-input" placeholder="кроссовки, техника, поездка..." value="${
            prefill.title || ""
          }" />
        </div>
        <div class="field-group field-row">
          <div style="flex:1">
            <div class="field-label">Сумма, ₽</div>
            <input type="number" id="sg-amount" class="field-input" inputmode="decimal" value="${
              prefill.amount || ""
            }" />
          </div>
          <div style="flex:1">
            <div class="field-label">Дедлайн</div>
            <input type="date" id="sg-deadline" class="field-input" min="${today}" value="${
          prefill.deadlineISO || today
        }" />
          </div>
        </div>
        <div class="field-group">
          <div class="field-label">Дни без заработка (календарь)</div>
          <div class="helper-text">отметь даты между сегодня и дедлайном, когда точно не будешь работать</div>
          <div class="chip-row" id="sg-calendar"></div>
        </div>
        <div class="field-group">
          <div class="field-label">Теги</div>
          <input type="text" id="sg-tags" class="field-input" placeholder="одежда, техника, отдых..." />
        </div>
        <button class="btn btn-primary" id="sg-save">создать цель и расписание</button>
      `
      );

      const deadlineEl = document.getElementById("sg-deadline");
      const calendarEl = document.getElementById("sg-calendar");
      const nonWorkingDates = new Set();

      function rebuildCalendar() {
        const deadlineISO = deadlineEl.value || today;
        calendarEl.innerHTML = "";
        let cursor = today;
        while (compareDateISO(cursor, deadlineISO) <= 0) {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className =
            "chip calendar-chip" +
            (nonWorkingDates.has(cursor) ? " selected" : "");
          btn.textContent = `${formatDate(cursor)} ${weekdayShort(cursor)}`;
          btn.dataset.date = cursor;
          btn.addEventListener("click", () => {
            if (nonWorkingDates.has(cursor)) {
              nonWorkingDates.delete(cursor);
              btn.classList.remove("selected");
            } else {
              nonWorkingDates.add(cursor);
              btn.classList.add("selected");
            }
          });
          calendarEl.appendChild(btn);
          cursor = addDaysISO(cursor, 1);
        }
      }

      deadlineEl.addEventListener("change", rebuildCalendar);
      rebuildCalendar();

      document.getElementById("sg-title").focus();

      document.getElementById("sg-save").addEventListener("click", () => {
        const title = document.getElementById("sg-title").value.trim();
        if (!title) return;
        const amountVal = parseFloat(
          document.getElementById("sg-amount").value.replace(",", ".")
        );
        if (!amountVal || amountVal <= 0) return;
        const deadlineISO =
          document.getElementById("sg-deadline").value || today;
        const tags = parseTags(document.getElementById("sg-tags").value);
        const nonWorkingDatesArr = Array.from(nonWorkingDates);

        const createdISO = today;
        const total = Math.round(amountVal);
        const schedule = generateSchedule(
          createdISO,
          deadlineISO,
          total,
          nonWorkingDatesArr
        );

        const goal = {
          id: uuid(),
          title,
          amount: total,
          totalAmount: total,
          remaining: total,
          deadlineISO,
          createdISO,
          nonWorkingDates: nonWorkingDatesArr,
          schedule,
          tags
        };

        state.shortGoals.push(goal);
        saveState();
        closeSheet();
      });
    }

    // Schedule sheet for short goal
    function openShortGoalScheduleSheet(goal) {
      const today = todayISO();
      const pendingCount = goal.schedule.filter(
        (d) => d.status === "pending" && compareDateISO(d.dateISO, today) >= 0
      ).length;
      openSheet(
        `Цель: ${goal.title}`,
        `
        <div class="field-group">
          <div class="field-label">Остаток</div>
          <div class="balance-value" style="font-size:18px;">${goal.remaining.toLocaleString(
            "ru-RU"
          )} ₽</div>
          <div class="helper-text">дедлайн: ${formatDate(
            goal.deadlineISO
          )}, рабочих дней впереди: ${pendingCount}</div>
        </div>
        <div class="section-title">
          <span>Расписание по дням</span>
          <button class="btn btn-small btn-outline" id="btn-undo-goal">отменить последнее</button>
        </div>
        <div class="schedule-list" id="sched-list"></div>
      `
      );

      const listEl = document.getElementById("sched-list");
      const undoBtn = document.getElementById("btn-undo-goal");

      function updateHeader() {
        sheetBodyEl
          .querySelector(".balance-value")
          .innerHTML = `${goal.remaining.toLocaleString("ru-RU")} ₽`;
      }

      function renderScheduleListLocal() {
        const today = todayISO();
        const sorted = [...goal.schedule].sort((a, b) =>
          compareDateISO(a.dateISO, b.dateISO)
        );
        listEl.innerHTML = sorted
          .map((d) => {
            const isPast = compareDateISO(d.dateISO, today) < 0;
            const isToday = d.dateISO === today;
            const canAct = !isPast && d.status === "pending";
            return `
          <div class="schedule-item">
            <div class="sched-left">
              <span class="sched-date">${formatDate(d.dateISO)}${
              isToday ? " · сегодня" : ""
            }</span>
              <span class="sched-plan">план: ${d.planned.toLocaleString(
                "ru-RU"
              )} ₽</span>
            </div>
            <div class="sched-btn-row">
              ${
                d.status === "pending"
                  ? canAct
                    ? `
                  <button class="sched-btn sched-btn-primary" data-action="done" data-date="${
                    d.dateISO
                  }">сделал</button>
                  <button class="sched-btn" data-action="skip" data-date="${
                    d.dateISO
                  }">пропустить</button>
                `
                    : `<span class="sched-status">ожидание</span>`
                  : `<span class="sched-status ${d.status}">
                      ${
                        d.status === "done"
                          ? "выполнено"
                          : d.status === "skipped"
                          ? "пропущено"
                          : d.status
                      }
                    </span>`
              }
            </div>
          </div>
        `;
          })
          .join("");
      }

      renderScheduleListLocal();

      listEl.addEventListener("click", (e) => {
        const btn = e.target.closest("[data-action]");
        if (!btn) return;
        const action = btn.getAttribute("data-action");
        const dateISO = btn.getAttribute("data-date");
        if (!dateISO) return;

        const entry = goal.schedule.find((d) => d.dateISO === dateISO);
        if (!entry || entry.status !== "pending") return;

        // save snapshot for undo
        lastGoalSnapshots[goal.id] = JSON.stringify(goal);

        if (action === "done") {
          goal.remaining = Math.max(0, goal.remaining - entry.planned);
          entry.status = "done";
        } else if (action === "skip") {
          entry.status = "skipped";
          redistributeSkipped(goal, entry);
        }

        saveState();
        renderScheduleListLocal();
        updateHeader();
      });

      undoBtn.addEventListener("click", () => {
        const snap = lastGoalSnapshots[goal.id];
        if (!snap) return;
        const restored = JSON.parse(snap);
        const idx = state.shortGoals.findIndex((g) => g.id === goal.id);
        if (idx !== -1) {
          state.shortGoals[idx] = restored;
        }
        Object.assign(goal, restored);
        saveState();
        renderScheduleListLocal();
        updateHeader();
      });
    }

    function redistributeSkipped(goal, skippedEntry) {
      const extra = skippedEntry.planned;
      const today = todayISO();
      const pendingFuture = goal.schedule.filter(
        (d) =>
          d.status === "pending" &&
          compareDateISO(d.dateISO, today) >= 0 &&
          d.dateISO !== skippedEntry.dateISO
      );
      if (!pendingFuture.length || extra <= 0) return;

      const perDay = Math.floor(extra / pendingFuture.length);
      let remainder = extra - perDay * pendingFuture.length;

      pendingFuture.forEach((d) => {
        d.planned += perDay;
        if (remainder > 0) {
          d.planned += 1;
          remainder -= 1;
        }
      });
    }

    // Add goal (tasks)
    function openGoalSheet() {
      const today = todayISO();
      openSheet(
        "Новая цель/задача",
        `
        <div class="field-group">
          <div class="field-label">Название</div>
          <input type="text" id="g-title" class="field-input" placeholder="что именно хочешь сделать" />
        </div>
        <div class="field-group">
          <div class="field-label">Описание</div>
          <textarea id="g-desc" class="field-textarea" placeholder="детали, если нужно"></textarea>
        </div>
        <div class="field-group">
          <div class="field-label">Тип</div>
          <select id="g-type" class="field-select">
            <option value="day">на день</option>
            <option value="week">на неделю</option>
            <option value="month">на месяц</option>
            <option value="none">без срока</option>
          </select>
        </div>
        <div class="field-group">
          <div class="field-label">Дедлайн (опционально)</div>
          <input type="date" id="g-deadline" class="field-input" min="${today}" />
        </div>
        <div class="field-group">
          <div class="field-label">Теги</div>
          <input type="text" id="g-tags" class="field-input" placeholder="спорт, работа, развитие..." />
        </div>
        <div class="field-group">
          <label class="field-label">
            <input type="checkbox" id="g-has-fin" />
            есть финансовый расход
          </label>
          <div class="helper-text">если включишь, создастся ещё и финансовая цель в разделе "Финансы"</div>
        </div>
        <div id="g-fin-block" style="display:none;">
          <div class="field-group field-row">
            <div style="flex:1">
              <div class="field-label">Сумма, ₽</div>
              <input type="number" id="g-fin-amount" class="field-input" inputmode="decimal" />
            </div>
            <div style="flex:1">
              <div class="field-label">Дедлайн (финансовый)</div>
              <input type="date" id="g-fin-deadline" class="field-input" min="${today}" />
            </div>
          </div>
        </div>
        <div class="field-group">
          <div class="field-label">Микроцели (опционально)</div>
          <div id="subtasks-container"></div>
          <button class="btn btn-small btn-outline" type="button" id="add-subtask">+ микроцель</button>
          <div class="helper-text">можно разбить цель на несколько маленьких шагов</div>
        </div>
        <button class="btn btn-primary" id="g-save">создать</button>
      `
      );

      const hasFinEl = document.getElementById("g-has-fin");
      const finBlockEl = document.getElementById("g-fin-block");
      hasFinEl.addEventListener("change", () => {
        finBlockEl.style.display = hasFinEl.checked ? "block" : "none";
      });

      const subtasksContainer = document.getElementById("subtasks-container");
      const addSubBtn = document.getElementById("add-subtask");

      function addSubtaskRow(value = "") {
        const row = document.createElement("div");
        row.className = "field-row subtask-row";
        row.innerHTML = `
          <input type="text" class="field-input subtask-title" placeholder="например: записаться, собрать документы..." value="${value}" />
        `;
        subtasksContainer.appendChild(row);
      }

      addSubBtn.addEventListener("click", () => addSubtaskRow());

      document.getElementById("g-title").focus();

      document.getElementById("g-save").addEventListener("click", () => {
        const title = document.getElementById("g-title").value.trim();
        if (!title) return;
        const description = document
          .getElementById("g-desc")
          .value.trim();
        const type = document.getElementById("g-type").value;
        const deadlineISO =
          document.getElementById("g-deadline").value || null;
        const tags = parseTags(document.getElementById("g-tags").value);
        const hasFin = hasFinEl.checked;

        const subInputs = subtasksContainer.querySelectorAll(".subtask-title");
        const subtasks = Array.from(subInputs)
          .map((inp) => inp.value.trim())
          .filter(Boolean)
          .map((t) => ({
            id: uuid(),
            title: t,
            done: false
          }));

        let linkedShortGoalId = null;

        if (hasFin) {
          const finAmountVal = parseFloat(
            document
              .getElementById("g-fin-amount")
              .value.replace(",", ".")
          );
          const finDeadline =
            document.getElementById("g-fin-deadline").value || deadlineISO;
          if (!finAmountVal || finAmountVal <= 0 || !finDeadline) {
            return;
          }

          const createdISO = today;
          const nonWorkingDates = [];
          const total = Math.round(finAmountVal);
          const schedule = generateSchedule(
            createdISO,
            finDeadline,
            total,
            nonWorkingDates
          );

          const sg = {
            id: uuid(),
            title: title + " (фин.)",
            amount: total,
            totalAmount: total,
            remaining: total,
            deadlineISO: finDeadline,
            createdISO,
            nonWorkingDates,
            schedule,
            tags
          };
          state.shortGoals.push(sg);
          linkedShortGoalId = sg.id;
        }

        const goal = {
          id: uuid(),
          title,
          description,
          type,
          createdISO: today,
          deadlineISO,
          tags,
          linkedShortGoalId,
          subtasks
        };

        state.goals.push(goal);
        saveState();
        closeSheet();
      });
    }

    function openGoalEditSheet(goal) {
      const today = todayISO();
      const subtasks = goal.subtasks || [];
      openSheet(
        "Редактировать цель",
        `
        <div class="field-group">
          <div class="field-label">Название</div>
          <input type="text" id="eg-title" class="field-input" value="${
            goal.title || ""
          }" />
        </div>
        <div class="field-group">
          <div class="field-label">Описание</div>
          <textarea id="eg-desc" class="field-textarea">${
            goal.description || ""
          }</textarea>
        </div>
        <div class="field-group">
          <div class="field-label">Тип</div>
          <select id="eg-type" class="field-select">
            <option value="day" ${
              goal.type === "day" ? "selected" : ""
            }>на день</option>
            <option value="week" ${
              goal.type === "week" ? "selected" : ""
            }>на неделю</option>
            <option value="month" ${
              goal.type === "month" ? "selected" : ""
            }>на месяц</option>
            <option value="none" ${
              goal.type === "none" ? "selected" : ""
            }>без срока</option>
          </select>
        </div>
        <div class="field-group">
          <div class="field-label">Дедлайн (опционально)</div>
          <input type="date" id="eg-deadline" class="field-input" min="${today}" value="${
          goal.deadlineISO || ""
        }" />
        </div>
        <div class="field-group">
          <div class="field-label">Теги</div>
          <input type="text" id="eg-tags" class="field-input" value="${
            (goal.tags || []).join(", ") || ""
          }" />
        </div>
        <div class="field-group">
          <div class="field-label">Микроцели</div>
          <div id="eg-subtasks-container"></div>
          <button class="btn btn-small btn-outline" type="button" id="eg-add-subtask">+ микроцель</button>
          <div class="helper-text">можно удалить лишние шаги или добавить новые</div>
        </div>
        <button class="btn btn-primary" id="eg-save">сохранить изменения</button>
      `
      );

      const container = document.getElementById("eg-subtasks-container");
      const addBtn = document.getElementById("eg-add-subtask");

      function addRow(sub) {
        const row = document.createElement("div");
        row.className = "field-row subtask-row";
        row.dataset.subId = sub?.id || "";
        row.innerHTML = `
          <input type="text" class="field-input eg-subtitle" placeholder="шаг" value="${
            sub?.title || ""
          }" />
          <button type="button" class="btn btn-small btn-outline eg-remove-sub">×</button>
        `;
        container.appendChild(row);
      }

      subtasks.forEach((s) => addRow(s));

      addBtn.addEventListener("click", () => addRow(null));

      container.addEventListener("click", (e) => {
        const btn = e.target.closest(".eg-remove-sub");
        if (!btn) return;
        const row = btn.closest(".subtask-row");
        if (row) row.remove();
      });

      document.getElementById("eg-title").focus();

      document.getElementById("eg-save").addEventListener("click", () => {
        const title = document.getElementById("eg-title").value.trim();
        if (!title) return;
        const description = document.getElementById("eg-desc").value.trim();
        const type = document.getElementById("eg-type").value;
        const deadlineISO =
          document.getElementById("eg-deadline").value || null;
        const tags = parseTags(document.getElementById("eg-tags").value);

        const rows = container.querySelectorAll(".subtask-row");
        const existingSubs = goal.subtasks || [];
        const newSubs = Array.from(rows)
          .map((row) => {
            const id = row.dataset.subId;
            const title = row.querySelector(".eg-subtitle").value.trim();
            if (!title) return null;
            const existing = existingSubs.find((s) => s.id === id);
            if (existing) {
              return { ...existing, title };
            }
            return { id: uuid(), title, done: false };
          })
          .filter(Boolean);

        goal.title = title;
        goal.description = description;
        goal.type = type;
        goal.deadlineISO = deadlineISO;
        goal.tags = tags;
        goal.subtasks = newSubs;

        saveState();
        closeSheet();
      });
    }

    // allocations sheets
    function openAllocationSheet(goal, goalType) {
      openSheet(
        "Распределить деньги",
        `
        <div class="field-group">
          <div class="field-label">Цель</div>
          <div class="muted">${goal.title}</div>
        </div>
        <div class="field-group">
          <div class="field-label">Сумма, ₽</div>
          <input type="number" id="alloc-amount" class="field-input" inputmode="decimal" />
          <div class="helper-text">доступно на руках: ${state.balance.toLocaleString(
            "ru-RU"
          )} ₽</div>
        </div>
        <button class="btn btn-primary" id="alloc-save">выделить</button>
      `
      );

      document.getElementById("alloc-amount").focus();

      document.getElementById("alloc-save").addEventListener("click", () => {
        const amountVal = parseFloat(
          document.getElementById("alloc-amount").value.replace(",", ".")
        );
        if (!amountVal || amountVal <= 0) return;
        const amount = Math.round(amountVal);
        if (amount > state.balance) {
          // мягко, без алертов браузера
          return;
        }
        state.allocations.push({
          id: uuid(),
          goalType: goalType === "short" ? "short" : "monthly",
          goalId: goal.id,
          amount,
          dateISO: todayISO()
        });
        state.balance -= amount;
        saveState();
        closeSheet();
      });
    }

    function openUndoAllocationSheet(goal, goalType) {
      const goalTypeFixed = goalType === "short" ? "short" : "monthly";
      const list = allocationsFor(goalTypeFixed, goal.id);
      openSheet(
        "Отменить распределение",
        `
        <div class="field-group">
          <div class="field-label">Цель</div>
          <div class="muted">${goal.title}</div>
        </div>
        <div class="field-group">
          <div class="field-label">История распределений</div>
          <div id="undo-alloc-list"></div>
          <div class="helper-text">можно отменить конкретные выделения, деньги вернутся на баланс</div>
        </div>
      `
      );

      const listEl = document.getElementById("undo-alloc-list");

      function renderList() {
        const current = allocationsFor(goalTypeFixed, goal.id);
        if (!current.length) {
          listEl.innerHTML = `<div class="empty">распределений нет</div>`;
          return;
        }
        const sorted = [...current].sort((a, b) =>
          a.dateISO < b.dateISO ? 1 : -1
        );
        listEl.innerHTML = sorted
          .map(
            (a) => `
          <div class="tx-item">
            <div class="tx-main">
              <span>${formatDate(a.dateISO)}</span>
              <span class="tx-amount income">${a.amount.toLocaleString(
                "ru-RU"
              )} ₽</span>
            </div>
            <div class="tx-meta">
              <span>распределение</span>
              <button class="btn btn-small btn-outline" data-del-alloc="${a.id}">отменить</button>
            </div>
          </div>
        `
          )
          .join("");
      }

      renderList();

      listEl.addEventListener("click", (e) => {
        const btn = e.target.closest("[data-del-alloc]");
        if (!btn) return;
        const id = btn.getAttribute("data-del-alloc");
        const alloc = (state.allocations || []).find((a) => a.id === id);
        if (!alloc) return;
        state.allocations = state.allocations.filter((a) => a.id !== id);
        state.balance += alloc.amount || 0;
        saveState();
        renderList();
      });
    }

    // ====== BACKUP SHEET (EXPORT / IMPORT) ======

    function openBackupSheet() {
      const json = JSON.stringify(state, null, 2);
      openSheet(
        "Экспорт / импорт данных",
        `
        <div class="field-group">
          <div class="field-label">Экспорт (копия текущего состояния)</div>
          <textarea id="backup-export" class="mono" readonly>${json}</textarea>
          <div class="helper-text">можешь скопировать это в заметки / файл, чтобы потом восстановить</div>
          <button class="btn btn-primary" id="backup-copy">скопировать</button>
        </div>
        <div class="field-group">
          <div class="field-label">Импорт</div>
          <textarea id="backup-import" class="mono" placeholder="вставь сюда ранее сохранённый JSON и нажми &quot;импортировать&quot;"></textarea>
          <div class="helper-text">внимание: при импорте текущее состояние будет заменено на загруженное</div>
        </div>
        <button class="btn btn-ghost" id="backup-apply">импортировать</button>
      `
      );

      const exportEl = document.getElementById("backup-export");
      const importEl = document.getElementById("backup-import");
      const copyBtn = document.getElementById("backup-copy");
      const applyBtn = document.getElementById("backup-apply");

      copyBtn.addEventListener("click", async () => {
        try {
          if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(exportEl.value);
          } else {
            exportEl.focus();
            exportEl.select();
          }
        } catch (e) {
          console.error("clipboard error", e);
        }
      });

      applyBtn.addEventListener("click", () => {
        const raw = importEl.value.trim();
        if (!raw) return;
        let parsed;
        try {
          parsed = JSON.parse(raw);
        } catch (e) {
          alert("Некорректный JSON, проверь данные.");
          return;
        }
        if (!parsed || typeof parsed !== "object") {
          alert("Структура данных некорректна.");
          return;
        }
        if (!confirm("Текущее состояние будет перезаписано. Продолжить?")) {
          return;
        }
        state = { ...structuredClone(defaultState), ...parsed };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        state = loadState();
        render();
        closeSheet();
      });
    }

    // ====== NAV TABS INIT & HEADER BTN ======

    document.querySelectorAll(".nav-tab").forEach((tab) => {
      tab.addEventListener("click", () => {
        const t = tab.getAttribute("data-tab");
        if (t === activeTab) return;
        activeTab = t;
        document
          .querySelectorAll(".nav-tab")
          .forEach((node) => node.classList.remove("active"));
        tab.classList.add("active");
        render();
      });
    });

    const backupBtn = document.getElementById("btn-backup");
    if (backupBtn) {
      backupBtn.addEventListener("click", () => openBackupSheet());
    }

    // ====== INITIAL RENDER ======
    render();
  </script>
</body>
</html>