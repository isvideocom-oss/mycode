<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Core Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #050816;
      --bg-elevated: #0b1220;
      --card: #111827;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.15);
      --accent-strong: #16a34a;
      --danger: #f97373;
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --border-soft: #1f2937;
      --tag-bg: #111827;
      --tag-border: #1f2937;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      font-family: -apple-system, system-ui, BlinkMacSystemFont, "SF Pro Text",
        sans-serif;
      background: radial-gradient(circle at top, #0b1120 0, #020617 45%, #000 100%);
      color: var(--text-main);
      display: flex;
      justify-content: center;
    }

    body.light-theme {
      --bg: #f3f4f6;
      --bg-elevated: #e5e7eb;
      --card: #ffffff;
      --accent: #16a34a;
      --accent-soft: rgba(22, 163, 74, 0.12);
      --accent-strong: #15803d;
      --danger: #dc2626;
      --text-main: #0f172a;
      --text-muted: #6b7280;
      --border-soft: #d1d5db;
      --tag-bg: #f9fafb;
      --tag-border: #e5e7eb;
      background: radial-gradient(circle at top, #e5e7eb 0, #f3f4f6 45%, #e5e7eb 100%);
      color: var(--text-main);
    }

    .app {
      width: 100%;
      max-width: 480px;
      min-height: 100vh;
      padding: 16px 12px 24px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      gap: 8px;
    }

    .app-title {
      font-weight: 700;
      letter-spacing: 0.03em;
      font-size: 18px;
    }

    .app-subtitle {
      font-size: 11px;
      color: var(--text-muted);
    }

    .app-actions {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .nav-tabs {
      display: flex;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 999px;
      padding: 4px;
      border: 1px solid var(--border-soft);
      margin-bottom: 8px;
    }

    body.light-theme .nav-tabs {
      background: rgba(243, 244, 246, 0.9);
    }

    .nav-tab {
      flex: 1;
      padding: 8px 0;
      border-radius: 999px;
      text-align: center;
      font-size: 13px;
      cursor: pointer;
      user-select: none;
      transition: background 0.15s ease, color 0.15s ease;
      color: var(--text-muted);
    }

    .nav-tab.active {
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: #0b1120;
      font-weight: 600;
    }

    .content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding-bottom: 16px;
    }

    .card {
      background: linear-gradient(145deg, var(--card), var(--card));
      border-radius: 18px;
      padding: 14px 14px 12px;
      border: 1px solid var(--border-soft);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.6);
    }

    body.light-theme .card {
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      gap: 8px;
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      padding: 3px 7px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
    }

    .card-subtitle {
      font-size: 11px;
      color: var(--text-muted);
    }

    .balance-value {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .balance-label {
      font-size: 11px;
      color: var(--text-muted);
    }

    .btn-row {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      margin-bottom: 4px;
      flex-wrap: wrap;
    }

    .btn {
      flex: 1;
      border-radius: 999px;
      padding: 8px 10px;
      border: 1px solid var(--border-soft);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-main);
      font-size: 12px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      user-select: none;
      transition: background 0.12s ease, border-color 0.12s ease,
        transform 0.05s ease;
    }

    body.light-theme .btn {
      background: #f9fafb;
    }

    .btn:active {
      transform: scale(0.98);
      background: #020617;
    }

    body.light-theme .btn:active {
      background: #e5e7eb;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      border-color: transparent;
      color: #020617;
      font-weight: 600;
    }

    .btn-ghost {
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-main);
    }

    body.light-theme .btn-ghost {
      background: #f3f4f6;
    }

    .btn-small {
      padding: 4px 8px;
      font-size: 11px;
      border-radius: 999px;
      flex: 0;
    }

    .btn-outline {
      border-color: var(--border-soft);
      background: transparent;
      color: var(--text-muted);
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid var(--tag-border);
      background: var(--tag-bg);
      font-size: 10px;
      color: var(--text-muted);
    }

    .tag-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--accent);
    }

    .section-title {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .section-subtitle {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .list {
      max-height: 180px;
      overflow-y: auto;
      padding-right: 2px;
      margin: 0;
    }

    .list::-webkit-scrollbar {
      width: 3px;
    }

    .list::-webkit-scrollbar-thumb {
      background: #1f2937;
      border-radius: 999px;
    }

    .tx-item,
    .payment-item {
      padding: 6px 0;
      border-bottom: 1px dashed rgba(31, 41, 55, 0.9);
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .tx-main {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      gap: 8px;
    }

    .tx-amount {
      font-weight: 600;
      white-space: nowrap;
    }

    .tx-amount.income {
      color: var(--accent);
    }

    .tx-amount.expense {
      color: var(--danger);
    }

    .tx-meta {
      font-size: 10px;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .muted {
      color: var(--text-muted);
      font-size: 11px;
    }

    .empty {
      font-size: 11px;
      color: var(--text-muted);
      font-style: italic;
      margin-top: 4px;
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 2px;
    }

    .chip {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid var(--border-soft);
      color: var(--text-muted);
    }

    body.light-theme .chip {
      background: #f9fafb;
    }

    .pill-small {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(34, 197, 94, 0.12);
      color: var(--accent);
    }

    /* Круговой прогресс для целей */

    .circle-progress {
      --progress: 0;
      width: 26px;
      height: 26px;
      border-radius: 999px;
      background:
        radial-gradient(farthest-side, var(--bg) 68%, transparent 70%),
        conic-gradient(var(--accent) calc(var(--progress) * 1%), #111827 0);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
      font-weight: 500;
      color: var(--text-main);
      flex-shrink: 0;
    }

    body.light-theme .circle-progress {
      background:
        radial-gradient(farthest-side, #ffffff 68%, transparent 70%),
        conic-gradient(var(--accent) calc(var(--progress) * 1%), #e5e7eb 0);
    }

    /* Forms (bottom sheet) */

    .sheet-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.65);
      backdrop-filter: blur(8px);
      display: none;
      justify-content: flex-end;
      z-index: 30;
    }

    .sheet-backdrop.visible {
      display: flex;
    }

    .sheet {
      width: 100%;
      max-width: 480px;
      background: var(--bg);
      border-radius: 18px 18px 0 0;
      border-top: 1px solid var(--border-soft);
      padding: 10px 14px 14px;
      box-shadow: 0 -22px 40px rgba(0, 0, 0, 0.8);
    }

    .sheet-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .sheet-title {
      font-size: 14px;
      font-weight: 600;
    }

    .sheet-close {
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-muted);
      font-size: 11px;
      padding: 4px 8px;
      cursor: pointer;
    }

    body.light-theme .sheet-close {
      background: #f9fafb;
    }

    .field-group {
      margin-bottom: 8px;
    }

    .field-label {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 3px;
    }

    .field-input,
    .field-textarea,
    .field-select {
      width: 100%;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-main);
      padding: 7px 9px;
      font-size: 12px;
      outline: none;
    }

    body.light-theme .field-input,
    body.light-theme .field-textarea,
    body.light-theme .field-select {
      background: #f9fafb;
    }

    .field-input:focus,
    .field-textarea:focus,
    .field-select:focus {
      border-color: var(--accent);
    }

    .field-textarea {
      min-height: 48px;
      resize: vertical;
    }

    .field-row {
      display: flex;
      gap: 8px;
    }

    .helper-text {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    /* Short goal schedule */

    .schedule-list {
      max-height: 200px;
      overflow-y: auto;
      padding-right: 2px;
      margin-top: 4px;
    }

    .schedule-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 4px 0;
      border-bottom: 1px dashed rgba(31, 41, 55, 0.9);
      font-size: 11px;
      gap: 6px;
    }

    .sched-left {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .sched-date {
      font-weight: 500;
    }

    .sched-plan {
      color: var(--text-muted);
      font-size: 10px;
    }

    .sched-status {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-muted);
      white-space: nowrap;
    }

    .sched-status.done {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(34, 197, 94, 0.1);
    }

    .sched-status.skipped {
      border-color: var(--danger);
      color: var(--danger);
      background: rgba(248, 113, 113, 0.08);
    }

    .sched-btn-row {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .sched-btn {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-main);
      cursor: pointer;
      white-space: nowrap;
    }

    body.light-theme .sched-btn {
      background: #f9fafb;
    }

    .sched-btn-primary {
      border-color: var(--accent);
      color: var(--accent);
    }

    /* Goals lists / containers */

    .goal-type-pill {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-muted);
      white-space: nowrap;
    }

    body.light-theme .goal-type-pill {
      background: #f9fafb;
    }

    .goal-type-pill[data-type="day"] {
      color: #f97316;
      border-color: #f97316;
      background: rgba(248, 148, 62, 0.08);
    }

    .goal-type-pill[data-type="week"] {
      color: #38bdf8;
      border-color: #38bdf8;
      background: rgba(56, 189, 248, 0.08);
    }

    .goal-type-pill[data-type="month"] {
      color: #a855f7;
      border-color: #a855f7;
      background: rgba(168, 85, 247, 0.08);
    }

    .goal-type-pill[data-type="none"] {
      color: var(--text-muted);
    }

    .badge-link {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(34, 197, 94, 0.08);
      color: var(--accent);
      border: 1px solid rgba(34, 197, 94, 0.3);
      white-space: nowrap;
    }

    .small-inline {
      font-size: 10px;
      color: var(--text-muted);
    }

    .mono {
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      width: 100%;
      min-height: 90px;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-main);
      padding: 6px 8px;
      resize: vertical;
    }

    body.light-theme .mono {
      background: #f9fafb;
    }

    .mono:focus {
      border-color: var(--accent);
      outline: none;
    }

    /* Analytics */

    .analytics-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px 10px;
      margin-top: 4px;
    }

    .analytics-item {
      font-size: 11px;
      color: var(--text-muted);
    }

    .analytics-label {
      font-size: 10px;
      color: var(--text-muted);
    }

    .analytics-value {
      font-size: 12px;
      color: var(--text-main);
      font-weight: 500;
    }

    .day-row {
      margin-bottom: 6px;
    }

    .day-main {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
    }

    .day-label {
      color: var(--text-main);
    }

    .day-net {
      font-weight: 500;
    }

    .day-bar {
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: #020617;
      overflow: hidden;
      margin: 3px 0;
    }

    body.light-theme .day-bar {
      background: #e5e7eb;
    }

    .day-bar-fill {
      height: 100%;
      float: left;
    }

    .day-bar-fill.done {
      background: var(--accent-strong);
    }

    .day-bar-fill.skipped {
      background: var(--danger);
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: #020617;
      overflow: hidden;
      margin: 4px 0;
    }

    body.light-theme .progress-bar {
      background: #e5e7eb;
    }

    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent-strong));
    }

    /* Subtasks */

    .subtask-list {
      list-style: none;
      padding-left: 0;
      margin: 4px 0 0;
    }

    .subtask-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .subtask-item label {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    .subtask-toggle {
      accent-color: var(--accent);
    }

    /* Calendar for non-working dates */

    .calendar-chip {
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-muted);
      cursor: pointer;
    }

    body.light-theme .calendar-chip {
      background: #f9fafb;
    }

    .calendar-chip.selected {
      border-color: var(--danger);
      color: var(--danger);
      background: rgba(248, 113, 113, 0.12);
    }

    /* Weekly groups and goal "boxes" */

    .week-group {
      border-radius: 14px;
      border: 1px solid var(--border-soft);
      padding: 8px 10px;
      margin-bottom: 8px;
      background: rgba(15, 23, 42, 0.5);
    }

    body.light-theme .week-group {
      background: #f9fafb;
    }

    .week-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 12px;
      cursor: pointer;
      user-select: none;
    }

    .week-toggle {
      font-size: 14px;
      opacity: 0.7;
    }

    .week-body {
      margin-top: 6px;
    }

    .goal-box {
      border-radius: 14px;
      border: 1px solid var(--border-soft);
      padding: 8px 10px;
      margin-bottom: 6px;
      background: rgba(15, 23, 42, 0.8);
    }

    body.light-theme .goal-box {
      background: #ffffff;
    }

    .goal-box.done {
      opacity: 0.5;
    }

    .goal-box-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      font-size: 12px;
    }

    .goal-main-title {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .goal-main-title label {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    .goal-done-toggle {
      accent-color: var(--accent);
    }

    /* Достижения */

    .achievement-list {
      margin-top: 4px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .achievement-item {
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      background: rgba(15, 23, 42, 0.6);
      font-size: 11px;
    }

    body.light-theme .achievement-item {
      background: #f9fafb;
    }

    .achievement-title {
      font-weight: 500;
      margin-bottom: 2px;
    }

    .achievement-text {
      font-size: 10px;
      color: var(--text-muted);
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="app-header">
      <div>
        <div class="app-title">Core Tracker</div>
        <div class="app-subtitle">финансы · цели · дисциплина</div>
      </div>
      <div class="app-actions">
        <button class="btn btn-small btn-outline" id="btn-backup">экспорт / импорт</button>
        <button class="btn btn-small btn-outline" id="btn-settings">⚙</button>
      </div>
    </header>

    <nav class="nav-tabs">
      <div class="nav-tab active" data-tab="finance">Финансы</div>
      <div class="nav-tab" data-tab="goals">Цели</div>
      <div class="nav-tab" data-tab="analytics">Аналитика</div>
    </nav>

    <main class="content" id="content"></main>
  </div>

  <!-- Bottom sheets (modals) -->
  <div class="sheet-backdrop" id="sheet-backdrop">
    <div class="sheet" id="sheet">
      <div class="sheet-header">
        <div class="sheet-title" id="sheet-title"></div>
        <button class="sheet-close" id="sheet-close">закрыть</button>
      </div>
      <div id="sheet-body"></div>
    </div>
  </div>

  <script>
    // ====== STATE & STORAGE ======

    const STORAGE_KEY = "core_tracker_state_v1";
    const THEME_KEY = "core_tracker_theme_mode"; // auto | dark | light

    const defaultState = {
      balance: 0,
      transactions: [], // {id, type, amount, note, tags[], dateISO}
      monthlyPayments: [], // {id,title,amount,dayOfMonth,description,tags[],priority,reserved}
      shortGoals: [], // {id,title,amount,totalAmount,remaining,deadlineISO,createdISO,nonWorkingDates[],schedule:[{dateISO,planned,status}],tags[],priority,manualSaved}
      goals: [] // {id,title,description,type,createdISO,deadlineISO|null,tags[],linkedShortGoalId|null,subtasks:[],done:false}
    };

    let state = loadState();
    let themeMode = loadThemeMode(); // 'auto' | 'dark' | 'light'

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return structuredClone(defaultState);
        const parsed = JSON.parse(raw);
        const merged = { ...structuredClone(defaultState), ...parsed };

        merged.shortGoals = (merged.shortGoals || []).map((g) => ({
          nonWorkingDates: [],
          priority: false,
          manualSaved: 0,
          ...g
        }));
        merged.monthlyPayments = (merged.monthlyPayments || []).map((p) => ({
          priority: false,
          reserved: 0,
          ...p
        }));
        merged.goals = (merged.goals || []).map((g) => ({
          subtasks: [],
          done: false,
          ...g
        }));
        return merged;
      } catch (e) {
        console.error("Failed to load state", e);
        return structuredClone(defaultState);
      }
    }

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      render();
    }

    function loadThemeMode() {
      try {
        const val = localStorage.getItem(THEME_KEY);
        if (val === "dark" || val === "light" || val === "auto") return val;
      } catch (e) {}
      return "auto";
    }

    function saveThemeMode(mode) {
      themeMode = mode;
      localStorage.setItem(THEME_KEY, mode);
      applyTheme();
    }

    function systemPrefersDark() {
      return (
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches
      );
    }

    function applyTheme() {
      let effective = themeMode;
      if (effective === "auto") {
        effective = systemPrefersDark() ? "dark" : "light";
      }
      document.body.classList.toggle("light-theme", effective === "light");
    }

    applyTheme();

    // ====== UTILITIES ======

    function uuid() {
      return Math.random().toString(36).slice(2) + Date.now().toString(36);
    }

    function formatDate(dateISO) {
      const d = new Date(dateISO);
      if (Number.isNaN(d.getTime())) return "";
      const day = String(d.getDate()).padStart(2, "0");
      const month = String(d.getMonth() + 1).padStart(2, "0");
      return `${day}.${month}`;
    }

    function weekdayShort(dateISO) {
      const d = new Date(dateISO);
      const day = d.getDay(); // 0-6
      const map = ["вс", "пн", "вт", "ср", "чт", "пт", "сб"];
      return map[day] || "";
    }

    function todayISO() {
      return new Date().toISOString().slice(0, 10);
    }

    function parseTags(str) {
      if (!str) return [];
      return str
        .split(",")
        .map((t) => t.trim())
        .filter(Boolean);
    }

    function tagsToHTML(tags) {
      if (!tags || !tags.length) return "";
      return tags.map((t) => `<span class="chip">#${t}</span>`).join("");
    }

    function compareDateISO(a, b) {
      if (a < b) return -1;
      if (a > b) return 1;
      return 0;
    }

    function addDaysISO(dateISO, days) {
      const d = new Date(dateISO);
      d.setDate(d.getDate() + days);
      return d.toISOString().slice(0, 10);
    }

    function getWeekKey(dateISO) {
      const d = new Date(dateISO);
      const year = d.getFullYear();
      const oneJan = new Date(year, 0, 1);
      const diff = d - oneJan;
      const day = Math.floor(diff / (1000 * 60 * 60 * 24)) + oneJan.getDay();
      const week = Math.floor(day / 7) + 1;
      return `${year}-W${String(week).padStart(2, "0")}`;
    }

    function weekLabelFromKey(key) {
      const [yearPart, weekPart] = key.split("-W");
      const year = parseInt(yearPart, 10) || new Date().getFullYear();
      const week = parseInt(weekPart, 10) || 1;
      const firstJan = new Date(year, 0, 1);
      const start = new Date(firstJan.getTime() + (week - 1) * 7 * 24 * 60 * 60 * 1000);
      const end = new Date(start.getTime() + 6 * 24 * 60 * 60 * 1000);
      const startLabel = `${String(start.getDate()).padStart(2, "0")}.${String(
        start.getMonth() + 1
      ).padStart(2, "0")}`;
      const endLabel = `${String(end.getDate()).padStart(2, "0")}.${String(
        end.getMonth() + 1
      ).padStart(2, "0")}`;
      return `Неделя ${startLabel}–${endLabel}`;
    }

    // schedule generator
    function generateSchedule(createdISO, deadlineISO, totalAmount, nonWorkingDates) {
      const skipSet = new Set(nonWorkingDates || []);
      const scheduleDates = [];
      let cursor = createdISO;
      while (compareDateISO(cursor, deadlineISO) <= 0) {
        if (!skipSet.has(cursor)) {
          scheduleDates.push(cursor);
        }
        cursor = addDaysISO(cursor, 1);
      }
      const workDaysCount = scheduleDates.length || 1;
      const perDayRaw = totalAmount / workDaysCount;
      const perDay = Math.floor(perDayRaw);
      const remainder = Math.round(totalAmount - perDay * workDaysCount);

      return scheduleDates.map((d, idx) => ({
        dateISO: d,
        planned: perDay + (idx === 0 ? remainder : 0),
        status: "pending"
      }));
    }

    // ====== ANALYTICS HELPERS ======

    function computeFinanceAnalytics() {
      const today = todayISO();
      const [y, m] = today.split("-");
      const monthPrefix = `${y}-${m}`;
      const txMonth = state.transactions.filter((tx) =>
        tx.dateISO && tx.dateISO.startsWith(monthPrefix)
      );

      let monthIncome = 0;
      let monthExpense = 0;
      const tagStats = {};

      txMonth.forEach((tx) => {
        const sign = tx.type === "income" ? 1 : -1;
        if (tx.type === "income") monthIncome += tx.amount;
        else monthExpense += tx.amount;
        (tx.tags || []).forEach((tag) => {
          if (!tagStats[tag]) tagStats[tag] = 0;
          tagStats[tag] += sign * tx.amount;
        });
      });

      const tagEntries = Object.entries(tagStats).sort(
        (a, b) => Math.abs(b[1]) - Math.abs(a[1])
      );
      const topTags = tagEntries.slice(0, 3).map(([tag, val]) => ({
        tag,
        value: val
      }));

      const todayDate = new Date(today);
      const todayDay = todayDate.getDate();
      const upcomingPayments = state.monthlyPayments.filter((p) => {
        // простой вариант — как было, по дням месяца
        return p.dayOfMonth >= todayDay && p.dayOfMonth <= todayDay + 3;
      });

      const allShort = state.shortGoals.length;
      const completedShort = state.shortGoals.filter((g) => g.remaining <= 0)
        .length;
      const activeShort = allShort - completedShort;

      // текущие задачи по фин. целям на сегодня
      let tasksTodayCount = 0;
      let tasksTodayPlanned = 0;
      state.shortGoals.forEach((g) => {
        (g.schedule || []).forEach((d) => {
          if (d.dateISO === today && d.status === "pending") {
            tasksTodayCount += 1;
            tasksTodayPlanned += d.planned || 0;
          }
        });
      });

      // дни с транзакциями — серия
      const txDaysSet = new Set(
        state.transactions.map((tx) => tx.dateISO).filter(Boolean)
      );
      let currentStreak = 0;
      let cursor = today;
      for (let i = 0; i < 60; i++) {
        if (txDaysSet.has(cursor)) {
          currentStreak += 1;
          cursor = addDaysISO(cursor, -1);
        } else {
          break;
        }
      }
      const totalActiveDays = txDaysSet.size;

      let streakText = "можно начать серию с сегодняшнего дня";
      if (currentStreak >= 7) {
        streakText = "огонь: неделя без провалов по деньгам";
      } else if (currentStreak >= 3) {
        streakText = "есть серия: держишь ритм, не сбавляй";
      } else if (currentStreak >= 1) {
        streakText = "старт есть: важен не идеал, а продолжение";
      }

      // последние 7 дней
      const lastDays = [];
      for (let offset = 6; offset >= 0; offset--) {
        const dateISO = addDaysISO(today, -offset);
        const txDay = state.transactions.filter((tx) => tx.dateISO === dateISO);
        let net = 0;
        txDay.forEach((tx) => {
          net += tx.type === "income" ? tx.amount : -tx.amount;
        });

        let tasksTotal = 0;
        let tasksDone = 0;
        let tasksSkipped = 0;
        state.shortGoals.forEach((g) => {
          (g.schedule || []).forEach((d) => {
            if (d.dateISO === dateISO) {
              tasksTotal += 1;
              if (d.status === "done") tasksDone += 1;
              if (d.status === "skipped") tasksSkipped += 1;
            }
          });
        });

        lastDays.push({
          dateISO,
          net,
          tasksTotal,
          tasksDone,
          tasksSkipped
        });
      }

      return {
        monthIncome,
        monthExpense,
        monthNet: monthIncome - monthExpense,
        hasMonthData: txMonth.length > 0,
        topTags,
        upcomingPaymentsCount: upcomingPayments.length,
        allShort,
        completedShort,
        activeShort,
        tasksTodayCount,
        tasksTodayPlanned,
        currentStreak,
        totalActiveDays,
        streakText,
        lastDays
      };
    }

    function computeGoalsAnalytics() {
      const goalsByType = state.goals.reduce(
        (acc, g) => {
          acc[g.type] = (acc[g.type] || 0) + 1;
          return acc;
        },
        { day: 0, week: 0, month: 0, none: 0 }
      );

      let totalSubtasks = 0;
      let doneSubtasks = 0;
      state.goals.forEach((g) => {
        const subs = g.subtasks || [];
        totalSubtasks += subs.length;
        doneSubtasks += subs.filter((s) => s.done).length;
      });

      const progressSubtasks =
        totalSubtasks > 0 ? Math.round((doneSubtasks / totalSubtasks) * 100) : 0;

      const recentGoals = [...state.goals]
        .sort((a, b) => (a.createdISO < b.createdISO ? 1 : -1))
        .slice(0, 5)
        .map((g) => {
          const subs = g.subtasks || [];
          const done = subs.filter((s) => s.done).length;
          return {
            id: g.id,
            title: g.title,
            type: g.type,
            createdISO: g.createdISO,
            deadlineISO: g.deadlineISO,
            subtasksTotal: subs.length,
            subtasksDone: done
          };
        });

      return {
        goalsByType,
        totalSubtasks,
        doneSubtasks,
        progressSubtasks,
        recentGoals
      };
    }

    function computeAchievements() {
      const fin = computeFinanceAnalytics();
      const goals = computeGoalsAnalytics();
      const achievements = [];

      if (state.transactions.length >= 1) {
        achievements.push({
          id: "first_tx",
          title: "Первый шаг",
          text: "Ты добавил первую финансовую операцию. Дальше будет проще."
        });
      }

      if (fin.currentStreak >= 3) {
        achievements.push({
          id: "streak3",
          title: "Серия 3 дня",
          text: "Три дня подряд ты следишь за деньгами. Уже лучше, чем вчера."
        });
      }

      if (fin.currentStreak >= 7) {
        achievements.push({
          id: "streak7",
          title: "Недельный спринт",
          text: "Неделя учёта без провалов. Это уже стиль жизни."
        });
      }

      if (fin.completedShort >= 1) {
        achievements.push({
          id: "short1",
          title: "Первая цель закрыта",
          text: "Ты полностью закрыл одну краткосрочную финансовую цель."
        });
      }

      const doneGoalsCount = state.goals.filter((g) => g.done).length;
      if (doneGoalsCount >= 1) {
        achievements.push({
          id: "goal1",
          title: "Цель выполнена",
          text: "Хотя бы одну задачу ты довёл до конца. Это важно."
        });
      }

      if (goals.doneSubtasks >= 5) {
        achievements.push({
          id: "micro5",
          title: "Микрошаги",
          text: "Больше 5 микроцелей закрыто. Мелочи складываются в результат."
        });
      }

      return achievements;
    }

    // ====== RENDER ROOT ======

    let activeTab = "finance";
    let analyticsMode = "finance"; // finance | goals
    const contentEl = document.getElementById("content");

    const expandedWeeks = {};

    function render() {
      if (activeTab === "finance") {
        renderFinance();
      } else if (activeTab === "goals") {
        renderGoals();
      } else if (activeTab === "analytics") {
        renderAnalytics();
      }
    }

    // ====== RENDER FINANCE TAB ======

    function renderFinance() {
      contentEl.innerHTML = "";

      const today = todayISO();
      const todayDate = new Date(today);

      const balanceCard = document.createElement("section");
      balanceCard.className = "card";
      balanceCard.innerHTML = `
        <div class="card-header">
          <div>
            <div class="card-title">
              Баланс
              <span class="pill">
                <span class="tag-dot"></span>
                на руках
              </span>
            </div>
            <div class="card-subtitle">ежедневный учёт доходов и расходов</div>
          </div>
          <button class="btn btn-small btn-outline" id="btn-set-balance">править</button>
        </div>

        <div class="field-group" style="margin-bottom:6px;">
          <div class="field-label">На руках сейчас</div>
          <div class="balance-value">${state.balance.toLocaleString("ru-RU")} ₽</div>
          <div class="balance-label">баланс можно изменить вручную или через операции</div>
        </div>

        <div class="section-title">
          <span>Операции</span>
        </div>
        <div class="btn-row" style="margin-top:4px;">
          <button class="btn btn-primary" id="btn-add-income">+ доход</button>
          <button class="btn btn-ghost" id="btn-add-expense">− расход</button>
        </div>
        <div class="list" id="tx-list"></div>

        <div class="section-title" style="margin-top:8px;">
          <span>Свободные → цели</span>
          <span class="small-inline">распределение денег на фин. задачи</span>
        </div>
        <div class="list" id="free-list"></div>
      `;
      contentEl.appendChild(balanceCard);

      const txListEl = balanceCard.querySelector("#tx-list");
      if (!state.transactions.length) {
        txListEl.innerHTML = `<div class="empty">операций пока нет</div>`;
      } else {
        const sortedTx = [...state.transactions].sort((a, b) =>
          a.dateISO < b.dateISO ? 1 : -1
        );
        txListEl.innerHTML = sortedTx
          .map((tx) => {
            return `
            <div class="tx-item">
              <div class="tx-main">
                <span>${tx.note || "(без описания)"}</span>
                <span class="tx-amount ${tx.type}">${
              tx.type === "income" ? "+" : "−"
            }${tx.amount.toLocaleString("ru-RU")} ₽</span>
              </div>
              <div class="tx-meta">
                <span>${formatDate(tx.dateISO)}</span>
                <span>${tx.tags && tx.tags.length ? tx.tags.join(", ") : ""}</span>
              </div>
              <div class="chip-row">
                <button class="btn btn-small btn-outline" data-delete-tx="${tx.id}">удалить</button>
              </div>
            </div>
          `;
          })
          .join("");
      }

      // блок "Свободные → цели"
      const freeListEl = balanceCard.querySelector("#free-list");
      const freeItems = [];

      // ежемесячные
      state.monthlyPayments.forEach((p) => {
        const reserved = p.reserved || 0;
        const total = p.amount;
        const remaining = Math.max(0, total - reserved);
        const progress = total > 0 ? Math.round((reserved / total) * 100) : 0;
        freeItems.push({
          id: p.id,
          type: "monthly",
          title: `Ежемесячная · ${p.title}`,
          collected: reserved,
          total,
          remaining,
          progress
        });
      });

      // краткосрочные
      state.shortGoals.forEach((g) => {
        const total = g.totalAmount || g.amount || 0;
        const remaining = Math.max(0, g.remaining ?? total);
        const collected = Math.max(0, total - remaining);
        const progress = total > 0 ? Math.round((collected / total) * 100) : 0;
        freeItems.push({
          id: g.id,
          type: "short",
          title: `Краткосрочная · ${g.title}`,
          collected,
          total,
          remaining,
          progress
        });
      });

      if (!freeItems.length) {
        freeListEl.innerHTML = `<div class="empty">нет финансовых целей для распределения</div>`;
      } else {
        freeListEl.innerHTML = freeItems
          .map((item) => {
            return `
              <div class="tx-item">
                <div class="tx-main">
                  <div style="display:flex;align-items:center;gap:8px;">
                    <div class="circle-progress" style="--progress:${item.progress};">
                      <span>${item.progress}</span>
                    </div>
                    <span>${item.title}</span>
                  </div>
                  <span class="tx-amount income">${item.collected.toLocaleString("ru-RU")} ₽</span>
                </div>
                <div class="tx-meta">
                  <span>собрано / нужно: ${item.collected.toLocaleString("ru-RU")} / ${item.total.toLocaleString("ru-RU")} ₽</span>
                  <span>осталось: ${item.remaining.toLocaleString("ru-RU")} ₽</span>
                </div>
                <div class="chip-row">
                  <button class="btn btn-small btn-outline" data-alloc-id="${item.id}" data-alloc-type="${item.type}">распределить</button>
                  <button class="btn btn-small btn-outline" data-alloc-cancel-id="${item.id}" data-alloc-type="${item.type}">отменить</button>
                </div>
              </div>
            `;
          })
          .join("");
      }

      // Monthly payments
      const paymentsCard = document.createElement("section");
      paymentsCard.className = "card";
      paymentsCard.innerHTML = `
        <div class="card-header">
          <div>
            <div class="card-title">Ежемесячные платежи</div>
            <div class="card-subtitle">подписки, квартира, обязательства</div>
          </div>
          <button class="btn btn-small btn-outline" id="btn-add-monthly">+ добавить</button>
        </div>
        <div class="list" id="payments-list"></div>
      `;
      contentEl.appendChild(paymentsCard);

      const paymentsListEl = paymentsCard.querySelector("#payments-list");
      if (!state.monthlyPayments.length) {
        paymentsListEl.innerHTML =
          '<div class="empty">пока нет ежемесячных целей</div>';
      } else {
        const sorted = [...state.monthlyPayments].sort((a, b) => {
          if (!!b.priority !== !!a.priority) return b.priority ? 1 : -1;
          if (b.amount !== a.amount) return b.amount - a.amount;
          return a.dayOfMonth - b.dayOfMonth;
        });
        paymentsListEl.innerHTML = sorted
          .map((p) => {
            let dueDate = new Date(todayDate.getFullYear(), todayDate.getMonth(), p.dayOfMonth);
            if (dueDate < todayDate) {
              dueDate = new Date(todayDate.getFullYear(), todayDate.getMonth() + 1, p.dayOfMonth);
            }
            const diffMs = dueDate - todayDate;
            const diffDays = Math.round(diffMs / (1000 * 60 * 60 * 24));
            const diffLabel =
              diffDays === 0
                ? "сегодня"
                : diffDays > 0
                ? `через ${diffDays} дн.`
                : "";
            const reserved = p.reserved || 0;
            const total = p.amount;
            const remaining = Math.max(0, total - reserved);
            const progress = total > 0 ? Math.round((reserved / total) * 100) : 0;
            return `
            <div class="payment-item">
              <div class="tx-main">
                <div style="display:flex;align-items:center;gap:8px;">
                  <div class="circle-progress" style="--progress:${progress};">
                    <span>${progress}</span>
                  </div>
                  <span>${p.title}</span>
                </div>
                <span class="tx-amount expense">${p.amount.toLocaleString(
                  "ru-RU"
                )} ₽</span>
              </div>
              <div class="tx-meta">
                <span>${p.dayOfMonth}-го числа${
              diffLabel ? ", " + diffLabel : ""
            }</span>
                <span>собрано: ${reserved.toLocaleString("ru-RU")} ₽</span>
              </div>
              ${
                p.description
                  ? `<div class="muted">${p.description}</div>`
                  : ""
              }
              <div class="chip-row">
                ${
                  p.priority
                    ? '<span class="pill-small">приоритет</span>'
                    : ""
                }
                ${tagsToHTML(p.tags)}
                <button class="btn btn-small btn-outline" data-delete-monthly="${
                  p.id
                }">удалить</button>
              </div>
            </div>
          `;
          })
          .join("");
      }

      // Short financial goals
      const goalsCard = document.createElement("section");
      goalsCard.className = "card";
      goalsCard.innerHTML = `
        <div class="card-header">
          <div>
            <div class="card-title">Краткосрочные фин. цели</div>
            <div class="card-subtitle">накопить к дате, расписание по дням</div>
          </div>
          <button class="btn btn-small btn-outline" id="btn-add-short-goal">+ цель</button>
        </div>
        <div class="list" id="short-goals-list"></div>
      `;
      contentEl.appendChild(goalsCard);

      const shortListEl = goalsCard.querySelector("#short-goals-list");
      if (!state.shortGoals.length) {
        shortListEl.innerHTML =
          '<div class="empty">краткосрочных целей пока нет</div>';
      } else {
        const sorted = [...state.shortGoals].sort((a, b) => {
          if (!!b.priority !== !!a.priority) return b.priority ? 1 : -1;
          const cmpDeadline = compareDateISO(a.deadlineISO, b.deadlineISO);
          if (cmpDeadline !== 0) return cmpDeadline;
          return a.createdISO < b.createdISO ? 1 : -1;
        });
        shortListEl.innerHTML = sorted
          .map((g) => {
            const daysLeft =
              (new Date(g.deadlineISO) - todayDate) /
              (1000 * 60 * 60 * 24);
            const pendingCount = g.schedule.filter(
              (d) => d.status === "pending"
            ).length;
            const perDay =
              pendingCount > 0 ? g.remaining / pendingCount : 0;

            const total = g.totalAmount || g.amount || 0;
            const remaining = Math.max(0, g.remaining ?? total);
            const collected = Math.max(0, total - remaining);
            const progress = total > 0 ? Math.round((collected / total) * 100) : 0;

            return `
            <div class="goal-item">
              <div class="tx-main">
                <div style="display:flex;align-items:center;gap:8px;">
                  <div class="circle-progress" style="--progress:${progress};">
                    <span>${progress}</span>
                  </div>
                  <span>${g.title}</span>
                </div>
                <span class="tx-amount income">${g.remaining.toLocaleString(
                  "ru-RU"
                )} ₽</span>
              </div>
              <div class="tx-meta">
                <span>дедлайн: ${formatDate(g.deadlineISO)}</span>
                <span>${
                  daysLeft >= 0
                    ? `осталось ~${Math.ceil(daysLeft)} дн`
                    : "дедлайн прошёл"
                }</span>
              </div>
              <div class="chip-row">
                <span class="pill-small">план в день ~ ${perDay.toFixed(
                  0
                )} ₽</span>
                ${
                  g.priority
                    ? '<span class="pill-small">приоритет</span>'
                    : ""
                }
                <button class="btn btn-small btn-outline" data-open-goal="${
                  g.id
                }">расписание</button>
                <button class="btn btn-small btn-outline" data-delete-short="${
                  g.id
                }">удалить</button>
              </div>
              <div class="chip-row">
                ${tagsToHTML(g.tags)}
              </div>
            </div>
          `;
          })
          .join("");
      }

      // handlers
      balanceCard
        .querySelector("#btn-add-income")
        .addEventListener("click", () => openTxSheet("income"));
      balanceCard
        .querySelector("#btn-add-expense")
        .addEventListener("click", () => openTxSheet("expense"));
      balanceCard
        .querySelector("#btn-set-balance")
        .addEventListener("click", () => openBalanceSheet());

      txListEl.addEventListener("click", (e) => {
        const btn = e.target.closest("[data-delete-tx]");
        if (!btn) return;
        const id = btn.getAttribute("data-delete-tx");
        const tx = state.transactions.find((t) => t.id === id);
        if (!tx) return;
        if (!confirm("Удалить эту транзакцию и откатить баланс?")) return;
        if (tx.type === "income") {
          state.balance -= tx.amount;
        } else {
          state.balance += tx.amount;
        }
        state.transactions = state.transactions.filter((t) => t.id !== id);
        saveState();
      });

      freeListEl.addEventListener("click", (e) => {
        const allocBtn = e.target.closest("[data-alloc-id]");
        if (allocBtn) {
          const id = allocBtn.getAttribute("data-alloc-id");
          const type = allocBtn.getAttribute("data-alloc-type");
          openAllocationSheet(type, id);
          return;
        }
        const cancelBtn = e.target.closest("[data-alloc-cancel-id]");
        if (cancelBtn) {
          const id = cancelBtn.getAttribute("data-alloc-cancel-id");
          const type = cancelBtn.getAttribute("data-alloc-type");
          cancelAllocation(type, id);
          return;
        }
      });

      paymentsCard
        .querySelector("#btn-add-monthly")
        .addEventListener("click", () => openMonthlySheet());
      paymentsCard.addEventListener("click", (e) => {
        const btn = e.target.closest("[data-delete-monthly]");
        if (!btn) return;
        const id = btn.getAttribute("data-delete-monthly");
        if (!id) return;
        if (!confirm("Удалить этот платёж?")) return;
        state.monthlyPayments = state.monthlyPayments.filter((p) => p.id !== id);
        saveState();
      });

      goalsCard
        .querySelector("#btn-add-short-goal")
        .addEventListener("click", () => openShortGoalSheet());
      goalsCard.addEventListener("click", (e) => {
        const openBtn = e.target.closest("[data-open-goal]");
        if (openBtn) {
          const id = openBtn.getAttribute("data-open-goal");
          const goal = state.shortGoals.find((g) => g.id === id);
          if (goal) openShortGoalScheduleSheet(goal);
          return;
        }
        const delBtn = e.target.closest("[data-delete-short]");
        if (delBtn) {
          const id = delBtn.getAttribute("data-delete-short");
          if (!id) return;
          if (!confirm("Удалить эту краткосрочную цель?")) return;
          state.shortGoals = state.shortGoals.filter((g) => g.id !== id);
          state.goals.forEach((goal) => {
            if (goal.linkedShortGoalId === id) {
              goal.linkedShortGoalId = null;
            }
          });
          saveState();
        }
      });
    }

    function openAllocationSheet(type, id) {
      const today = todayISO();
      let title = "";
      let maxForGoal = 0;

      if (type === "monthly") {
        const p = state.monthlyPayments.find((x) => x.id === id);
        if (!p) return;
        title = `Распределить на "${p.title}"`;
        maxForGoal = Math.max(0, p.amount - (p.reserved || 0));
      } else if (type === "short") {
        const g = state.shortGoals.find((x) => x.id === id);
        if (!g) return;
        const total = g.totalAmount || g.amount || 0;
        const remaining = Math.max(0, g.remaining ?? total);
        title = `Распределить на "${g.title}"`;
        maxForGoal = remaining;
      }

      const maxFromBalance = Math.max(0, state.balance);
      const hardMax = Math.min(maxFromGoal, maxFromBalance);

      if (hardMax <= 0) {
        openSheet("Распределение", `
          <div class="field-group">
            <div class="field-label">Нельзя распределить</div>
            <div class="helper-text">либо баланс на руках нулевой, либо по цели уже всё собрано.</div>
          </div>
        `);
        return;
      }

      openSheet(title, `
        <div class="field-group">
          <div class="field-label">Сумма, ₽</div>
          <input type="number" id="alloc-amount" class="field-input" inputmode="decimal" />
          <div class="helper-text">на руках: ${state.balance.toLocaleString("ru-RU")} ₽, максимум на эту цель: ${hardMax.toLocaleString("ru-RU")} ₽</div>
        </div>
        <button class="btn btn-primary" id="alloc-save">распределить</button>
      `);

      document.getElementById("alloc-amount").focus();

      document.getElementById("alloc-save").addEventListener("click", () => {
        const raw = document.getElementById("alloc-amount").value.replace(",", ".");
        const val = Math.round(parseFloat(raw));
        if (!val || val <= 0) return;
        if (val > hardMax) return;

        if (type === "monthly") {
          const p = state.monthlyPayments.find((x) => x.id === id);
          if (!p) return;
          p.reserved = (p.reserved || 0) + val;
          state.balance -= val;
        } else if (type === "short") {
          const g = state.shortGoals.find((x) => x.id === id);
          if (!g) return;
          g.manualSaved = (g.manualSaved || 0) + val;
          g.remaining = Math.max(0, (g.remaining ?? g.totalAmount) - val);
          state.balance -= val;
        }

        saveState();
        closeSheet();
      });
    }

    function cancelAllocation(type, id) {
      if (type === "monthly") {
        const p = state.monthlyPayments.find((x) => x.id === id);
        if (!p) return;
        const reserved = p.reserved || 0;
        if (!reserved) return;
        if (!confirm("Отменить распределение по этой ежемесячной цели?")) return;
        state.balance += reserved;
        p.reserved = 0;
      } else if (type === "short") {
        const g = state.shortGoals.find((x) => x.id === id);
        if (!g) return;
        const manual = g.manualSaved || 0;
        if (!manual) return;
        if (!confirm("Отменить распределение свободных денег по этой цели?")) return;
        state.balance += manual;
        const total = g.totalAmount || g.amount || 0;
        g.remaining = Math.min(total, (g.remaining ?? total) + manual);
        g.manualSaved = 0;
      }
      saveState();
    }

    // ====== RENDER GOALS TAB ======

    function renderGoals() {
      contentEl.innerHTML = "";

      const goalsCard = document.createElement("section");
      goalsCard.className = "card";
      goalsCard.innerHTML = `
        <div class="card-header">
          <div>
            <div class="card-title">Задачи и цели</div>
            <div class="card-subtitle">день · неделя · месяц · без срока</div>
          </div>
          <button class="btn btn-small btn-outline" id="btn-add-goal">+ цель</button>
        </div>
        <div class="section-title">
          <span>По неделям</span>
        </div>
        <div id="goals-groups"></div>
      `;
      contentEl.appendChild(goalsCard);

      const container = goalsCard.querySelector("#goals-groups");
      if (!state.goals.length) {
        container.innerHTML = `<div class="empty">целей пока нет</div>`;
      } else {
        const sorted = [...state.goals].sort((a, b) => {
          return a.createdISO < b.createdISO ? 1 : -1;
        });

        const groups = {};
        sorted.forEach((g) => {
          const key = getWeekKey(g.createdISO || todayISO());
          if (!groups[key]) groups[key] = [];
          groups[key].push(g);
        });

        const keys = Object.keys(groups).sort((a, b) => (a < b ? 1 : -1));

        container.innerHTML = "";

        keys.forEach((key, idx) => {
          if (expandedWeeks[key] === undefined) {
            expandedWeeks[key] = idx === 0;
          }
          const groupEl = document.createElement("div");
          groupEl.className = "week-group";
          const label = weekLabelFromKey(key);
          groupEl.innerHTML = `
            <div class="week-header" data-week-key="${key}">
              <span>${label}</span>
              <span class="week-toggle">${expandedWeeks[key] ? "▾" : "▸"}</span>
            </div>
            <div class="week-body" style="display:${expandedWeeks[key] ? "block" : "none"}"></div>
          `;
          const body = groupEl.querySelector(".week-body");
          groups[key].forEach((g) => {
            const subs = g.subtasks || [];
            const doneSubs = subs.filter((s) => s.done).length;
            const allSubsDone = subs.length > 0 && doneSubs === subs.length;
            if (allSubsDone && !g.done) {
              g.done = true;
            }

            let goalProgress = 0;
            if (subs.length) {
              goalProgress = Math.round((doneSubs / subs.length) * 100);
            } else {
              goalProgress = g.done ? 100 : 0;
            }

            const goalBox = document.createElement("div");
            goalBox.className = "goal-box" + (g.done ? " done" : "");
            goalBox.innerHTML = `
              <div class="goal-box-header">
                <div class="goal-main-title">
                  <label>
                    <input type="checkbox"
                      class="goal-done-toggle"
                      data-goal-id="${g.id}"
                      ${g.done ? "checked" : ""} />
                    <span>${g.title}</span>
                  </label>
                  <div class="circle-progress" style="--progress:${goalProgress};">
                    <span>${goalProgress}</span>
                  </div>
                </div>
                <span class="goal-type-pill" data-type="${g.type}">
                  ${
                    g.type === "day"
                      ? "день"
                      : g.type === "week"
                      ? "неделя"
                      : g.type === "month"
                      ? "месяц"
                      : "без срока"
                  }
                </span>
              </div>
              <div class="tx-meta">
                <span>создано: ${formatDate(g.createdISO)}</span>
                <span>${g.deadlineISO ? "до " + formatDate(g.deadlineISO) : ""}</span>
              </div>
              ${
                g.linkedShortGoalId
                  ? `<div class="chip-row"><span class="badge-link">есть финансовая цель</span></div>`
                  : ""
              }
              ${g.description ? `<div class="muted">${g.description}</div>` : ""}
              ${
                subs.length
                  ? `<ul class="subtask-list">
                      ${subs
                        .map(
                          (s) => `
                        <li class="subtask-item">
                          <label>
                            <input type="checkbox"
                              class="subtask-toggle"
                              data-goal-id="${g.id}"
                              data-subtask-id="${s.id}"
                              ${s.done ? "checked" : ""} />
                            <span>${s.title}</span>
                          </label>
                        </li>`
                        )
                        .join("")}
                    </ul>`
                  : ""
              }
              <div class="chip-row">
                ${tagsToHTML(g.tags)}
                <button class="btn btn-small btn-outline" data-edit-goal="${g.id}">изменить</button>
                <button class="btn btn-small btn-outline" data-delete-goal="${g.id}">удалить</button>
              </div>
            `;
            body.appendChild(goalBox);
          });

          container.appendChild(groupEl);
        });

        container.addEventListener("click", (e) => {
          const header = e.target.closest(".week-header");
          if (header) {
            const key = header.getAttribute("data-week-key");
            if (!key) return;
            expandedWeeks[key] = !expandedWeeks[key];
            renderGoals();
            return;
          }

          const delBtn = e.target.closest("[data-delete-goal]");
          if (delBtn) {
            const id = delBtn.getAttribute("data-delete-goal");
            if (!id) return;
            if (!confirm("Удалить эту цель?")) return;
            const goal = state.goals.find((g) => g.id === id);
            const linkedId = goal ? goal.linkedShortGoalId : null;
            state.goals = state.goals.filter((g) => g.id !== id);
            if (linkedId) {
              state.shortGoals = state.shortGoals.filter(
                (sg) => sg.id !== linkedId
              );
            }
            saveState();
            return;
          }

          const editBtn = e.target.closest("[data-edit-goal]");
          if (editBtn) {
            const id = editBtn.getAttribute("data-edit-goal");
            const goal = state.goals.find((g) => g.id === id);
            if (goal) openEditGoalSheet(goal);
            return;
          }
        });

        container.addEventListener("change", (e) => {
          const goalToggle = e.target.closest(".goal-done-toggle");
          if (goalToggle) {
            const id = goalToggle.getAttribute("data-goal-id");
            const goal = state.goals.find((g) => g.id === id);
            if (!goal) return;
            goal.done = goalToggle.checked;
            saveState();
            return;
          }
          const subToggle = e.target.closest(".subtask-toggle");
          if (subToggle) {
            const goalId = subToggle.getAttribute("data-goal-id");
            const subId = subToggle.getAttribute("data-subtask-id");
            const goal = state.goals.find((g) => g.id === goalId);
            if (!goal) return;
            const sub = (goal.subtasks || []).find((s) => s.id === subId);
            if (!sub) return;
            sub.done = subToggle.checked;
            const subs = goal.subtasks || [];
            const allDone = subs.length > 0 && subs.every((s) => s.done);
            if (allDone) {
              goal.done = true;
            }
            saveState();
            return;
          }
        });
      }

      goalsCard
        .querySelector("#btn-add-goal")
        .addEventListener("click", () => openGoalSheet());
    }

    // ====== RENDER ANALYTICS TAB ======

    function renderAnalytics() {
      contentEl.innerHTML = "";

      const card = document.createElement("section");
      card.className = "card";
      card.innerHTML = `
        <div class="card-header">
          <div>
            <div class="card-title">Аналитика</div>
            <div class="card-subtitle">визуальный срез по финансам и целям</div>
          </div>
          <div class="btn-row" style="gap:4px;margin:0;">
            <button class="btn btn-small ${
              analyticsMode === "finance" ? "btn-primary" : "btn-outline"
            }" data-analytics-mode="finance">финансы</button>
            <button class="btn btn-small ${
              analyticsMode === "goals" ? "btn-primary" : "btn-outline"
            }" data-analytics-mode="goals">цели</button>
          </div>
        </div>
        <div id="analytics-body"></div>
      `;
      contentEl.appendChild(card);

      const body = card.querySelector("#analytics-body");
      if (analyticsMode === "finance") {
        renderFinanceAnalytics(body);
      } else {
        renderGoalsAnalytics(body);
      }

      // блок достижений
      const ach = computeAchievements();
      const wrap = document.createElement("div");
      wrap.innerHTML = `
        <div class="section-title" style="margin-top:8px;">
          <span>Достижения</span>
        </div>
      `;
      const achList = document.createElement("div");
      achList.className = "achievement-list";
      if (!ach.length) {
        achList.innerHTML = `<div class="empty">достижения появятся, когда начнёшь пользоваться трекером активнее</div>`;
      } else {
        achList.innerHTML = ach
          .map(
            (a) => `
          <div class="achievement-item">
            <div class="achievement-title">${a.title}</div>
            <div class="achievement-text">${a.text}</div>
          </div>
        `
          )
          .join("");
      }
      wrap.appendChild(achList);
      body.appendChild(wrap);

      card.querySelectorAll("[data-analytics-mode]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const mode = btn.getAttribute("data-analytics-mode");
          if (mode && mode !== analyticsMode) {
            analyticsMode = mode;
            renderAnalytics();
          }
        });
      });
    }

    function renderFinanceAnalytics(container) {
      const a = computeFinanceAnalytics();

      let html = "";

      html += `
        <div class="section-title">
          <span>Текущий месяц</span>
        </div>
      `;

      if (a.hasMonthData) {
        html += `
          <div class="analytics-grid">
            <div class="analytics-item">
              <div class="analytics-label">доход</div>
              <div class="analytics-value">+${a.monthIncome.toLocaleString(
                "ru-RU"
              )} ₽</div>
            </div>
            <div class="analytics-item">
              <div class="analytics-label">расход</div>
              <div class="analytics-value">−${a.monthExpense.toLocaleString(
                "ru-RU"
              )} ₽</div>
            </div>
            <div class="analytics-item">
              <div class="analytics-label">итог месяца</div>
              <div class="analytics-value">${(a.monthNet >= 0 ? "+" : "−") +
                Math.abs(a.monthNet).toLocaleString("ru-RU")} ₽</div>
            </div>
            <div class="analytics-item">
              <div class="analytics-label">активные дни</div>
              <div class="analytics-value">${a.totalActiveDays}</div>
            </div>
          </div>
        `;
      } else {
        html += `<div class="empty">в этом месяце пока нет данных по операциям</div>`;
      }

      html += `
        <div class="section-title" style="margin-top:8px;">
          <span>Сегодня и ближайшие дни</span>
        </div>
        <div class="analytics-grid">
          <div class="analytics-item">
            <div class="analytics-label">задачи по целям на сегодня</div>
            <div class="analytics-value">${a.tasksTodayCount}</div>
            <div class="helper-text">${
              a.tasksTodayCount
                ? "план на сегодня ~ " +
                  a.tasksTodayPlanned.toLocaleString("ru-RU") +
                  " ₽"
                : "на сегодня нет запланированных сумм по целям"
            }</div>
          </div>
          <div class="analytics-item">
            <div class="analytics-label">платежи в ближайшие 3 дня</div>
            <div class="analytics-value">${a.upcomingPaymentsCount}</div>
          </div>
        </div>
        <div class="section-title" style="margin-top:8px;">
          <span>Краткосрочные цели</span>
        </div>
        <div class="analytics-grid">
          <div class="analytics-item">
            <div class="analytics-label">фин. цели</div>
            <div class="analytics-value">${a.activeShort} активных / ${
        a.allShort
      }</div>
          </div>
          <div class="analytics-item">
            <div class="analytics-label">серия по деньгам</div>
            <div class="analytics-value">${a.currentStreak} дн.</div>
            <div class="helper-text">${a.streakText}</div>
          </div>
        </div>
        <div class="section-title" style="margin-top:8px;">
          <span>Последние 7 дней</span>
        </div>
      `;

      if (!a.lastDays.length) {
        html += `<div class="empty">нет данных по дням</div>`;
      } else {
        html += a.lastDays
          .map((d) => {
            const total = d.tasksTotal || 0;
            const donePerc = total ? Math.round((d.tasksDone / total) * 100) : 0;
            const skipPerc = total
              ? Math.round((d.tasksSkipped / total) * 100)
              : 0;
            const netLabel =
              d.net === 0
                ? "0 ₽"
                : (d.net > 0 ? "+" : "−") +
                  Math.abs(d.net).toLocaleString("ru-RU") +
                  " ₽";
            return `
              <div class="day-row">
                <div class="day-main">
                  <span class="day-label">${formatDate(d.dateISO)}</span>
                  <span class="day-net">${netLabel}</span>
                </div>
                <div class="day-bar">
                  <div class="day-bar-fill done" style="width:${donePerc}%;"></div>
                  <div class="day-bar-fill skipped" style="width:${skipPerc}%;"></div>
                </div>
                <div class="small-inline">
                  целей: ${total}, сделано: ${d.tasksDone}, пропущено: ${
              d.tasksSkipped
            }
                </div>
              </div>
            `;
          })
          .join("");
      }

      html += `
        <div class="section-title" style="margin-top:8px;">
          <span>Теги</span>
        </div>
      `;

      if (a.topTags.length) {
        html += `<div class="chip-row">`;
        html += a.topTags
          .map(
            (t) => `
          <span class="chip">#${t.tag} · ${
              t.value >= 0 ? "+" : "−"
            }${Math.abs(t.value).toLocaleString("ru-RU")} ₽</span>
        `
          )
          .join("");
        html += `</div>`;
      } else {
        html += `<div class="empty">ещё нет статистики по тегам</div>`;
      }

      container.innerHTML = html;
    }

    function renderGoalsAnalytics(container) {
      const a = computeGoalsAnalytics();

      let html = `
        <div class="section-title">
          <span>Общий срез</span>
        </div>
        <div class="analytics-grid">
          <div class="analytics-item">
            <div class="analytics-label">цели по типам</div>
            <div class="analytics-value">
              д: ${a.goalsByType.day} · н: ${a.goalsByType.week} · м: ${
        a.goalsByType.month
      } · б/с: ${a.goalsByType.none}
            </div>
          </div>
          <div class="analytics-item">
            <div class="analytics-label">микроцели всего</div>
            <div class="analytics-value">${a.totalSubtasks}</div>
          </div>
        </div>
        <div class="section-title" style="margin-top:8px;">
          <span>Прогресс по микроцелям</span>
        </div>
      `;

      if (a.totalSubtasks === 0) {
        html += `<div class="empty">микроцели пока не созданы</div>`;
      } else {
        html += `
          <div class="progress-bar">
            <div class="progress-bar-fill" style="width:${a.progressSubtasks}%;"></div>
          </div>
          <div class="small-inline">
            выполнено ${a.doneSubtasks} из ${a.totalSubtasks} (${a.progressSubtasks}%)
          </div>
        `;
      }

      html += `
        <div class="section-title" style="margin-top:8px;">
          <span>Последние цели</span>
        </div>
      `;

      if (!a.recentGoals.length) {
        html += `<div class="empty">целей пока нет</div>`;
      } else {
        html += a.recentGoals
          .map((g) => {
            let goalProgress = 0;
            if (g.subtasksTotal) {
              goalProgress = Math.round((g.subtasksDone / g.subtasksTotal) * 100);
            }
            return `
            <div class="goal-item">
              <div class="tx-main">
                <div style="display:flex;align-items:center;gap:8px;">
                  <div class="circle-progress" style="--progress:${goalProgress};">
                    <span>${goalProgress}</span>
                  </div>
                  <span>${g.title}</span>
                </div>
                <span class="goal-type-pill" data-type="${g.type}">
                  ${
                    g.type === "day"
                      ? "день"
                      : g.type === "week"
                      ? "неделя"
                      : g.type === "month"
                      ? "месяц"
                      : "без срока"
                  }
                </span>
              </div>
              <div class="tx-meta">
                <span>создано: ${formatDate(g.createdISO)}</span>
                <span>${
                  g.deadlineISO ? "до " + formatDate(g.deadlineISO) : ""
                }</span>
              </div>
              <div class="small-inline">
                микроцели: ${g.subtasksDone} / ${g.subtasksTotal}
              </div>
            </div>
          `;
          })
          .join("");
      }

      container.innerHTML = html;
    }

    // ====== SETTINGS SHEET ======

    function openSettingsSheet() {
      openSheet(
        "Настройки",
        `
        <div class="field-group">
          <div class="field-label">Тема</div>
          <select id="theme-select" class="field-select">
            <option value="auto">авто (по системе)</option>
            <option value="dark">тёмная</option>
            <option value="light">светлая</option>
          </select>
        </div>
        <div class="field-group">
          <div class="field-label">Данные</div>
          <button class="btn btn-ghost" id="btn-clear-all">очистить все данные</button>
          <div class="helper-text">удалит все финансы, цели и историю приложения (кроме темы)</div>
        </div>
      `
      );

      const themeSelect = document.getElementById("theme-select");
      themeSelect.value = themeMode;
      themeSelect.addEventListener("change", () => {
        saveThemeMode(themeSelect.value);
      });

      document
        .getElementById("btn-clear-all")
        .addEventListener("click", () => {
          if (
            !confirm(
              "Точно очистить все данные? Это удалит все цели, финансы и историю."
            )
          )
            return;
          localStorage.removeItem(STORAGE_KEY);
          state = loadState();
          render();
        });
    }

    // ====== SHEET (MODAL) UTILS ======

    const backdropEl = document.getElementById("sheet-backdrop");
    const sheetTitleEl = document.getElementById("sheet-title");
    const sheetBodyEl = document.getElementById("sheet-body");
    const sheetCloseBtn = document.getElementById("sheet-close");

    sheetCloseBtn.addEventListener("click", closeSheet);
    backdropEl.addEventListener("click", (e) => {
      if (e.target === backdropEl) closeSheet();
    });

    function openSheet(title, innerHTML) {
      sheetTitleEl.textContent = title;
      sheetBodyEl.innerHTML = innerHTML;
      backdropEl.classList.add("visible");
    }

    function closeSheet() {
      backdropEl.classList.remove("visible");
      sheetBodyEl.innerHTML = "";
    }

    // ====== SHEETS IMPLEMENTATION ======

    function openTxSheet(type) {
      openSheet(type === "income" ? "Добавить доход" : "Добавить расход", `
        <div class="field-group">
          <div class="field-label">Сумма</div>
          <input type="number" id="tx-amount" class="field-input" inputmode="decimal" />
        </div>
        <div class="field-group">
          <div class="field-label">Описание</div>
          <input type="text" id="tx-note" class="field-input" placeholder="зарплата, еда, транспорт..." />
        </div>
        <div class="field-group">
          <div class="field-label">Теги</div>
          <input type="text" id="tx-tags" class="field-input" placeholder="через запятую: работа, быт..." />
          <div class="helper-text">для удобной группировки (например: квартира, еда, психолог)</div>
        </div>
        <div class="field-group">
          <div class="field-label">Дата</div>
          <input type="date" id="tx-date" class="field-input" value="${todayISO()}" />
        </div>
        <button class="btn btn-primary" id="tx-save">сохранить</button>
      `);

      document.getElementById("tx-amount").focus();

      document.getElementById("tx-save").addEventListener("click", () => {
        const amountVal = parseFloat(
          document.getElementById("tx-amount").value.replace(",", ".")
        );
        if (!amountVal || amountVal <= 0) return;
        const note = document.getElementById("tx-note").value.trim();
        const tags = parseTags(document.getElementById("tx-tags").value);
        const dateISO = document.getElementById("tx-date").value || todayISO();

        const tx = {
          id: uuid(),
          type,
          amount: Math.round(amountVal),
          note,
          tags,
          dateISO
        };

        state.transactions.push(tx);
        if (type === "income") {
          state.balance += tx.amount;
        } else {
          state.balance -= tx.amount;
        }

        saveState();
        closeSheet();
      });
    }

    function openBalanceSheet() {
      openSheet(
        "Настроить баланс",
        `
        <div class="field-group">
          <div class="field-label">Баланс на руках, ₽</div>
          <input type="number" id="bal-value" class="field-input" inputmode="decimal" value="${state.balance}" />
          <div class="helper-text">это не создаст транзакцию, просто обновит цифру баланса</div>
        </div>
        <button class="btn btn-primary" id="bal-save">сохранить</button>
      `
      );

      document.getElementById("bal-value").focus();

      document.getElementById("bal-save").addEventListener("click", () => {
        const val = parseFloat(
          document.getElementById("bal-value").value.replace(",", ".")
        );
        if (Number.isNaN(val)) return;
        state.balance = Math.round(val);
        saveState();
        closeSheet();
      });
    }

    function openMonthlySheet() {
      openSheet(
        "Добавить ежемесячный платёж",
        `
        <div class="field-group">
          <div class="field-label">Название</div>
          <input type="text" id="mp-title" class="field-input" placeholder="квартира, подписка, аделина..." />
        </div>
        <div class="field-group field-row">
          <div style="flex:1">
            <div class="field-label">Сумма, ₽</div>
            <input type="number" id="mp-amount" class="field-input" inputmode="decimal" />
          </div>
          <div style="width:40%">
            <div class="field-label">День месяца</div>
            <input type="number" id="mp-day" class="field-input" min="1" max="31" />
          </div>
        </div>
        <div class="field-group">
          <div class="field-label">Описание</div>
          <input type="text" id="mp-desc" class="field-input" placeholder="комментарий (опционально)" />
        </div>
        <div class="field-group">
          <label class="field-label">
            <input type="checkbox" id="mp-priority" />
            высокий приоритет
          </label>
        </div>
        <div class="field-group">
          <div class="field-label">Теги</div>
          <input type="text" id="mp-tags" class="field-input" placeholder="жильё, подписки..." />
        </div>
        <button class="btn btn-primary" id="mp-save">сохранить</button>
      `
      );

      document.getElementById("mp-title").focus();

      document.getElementById("mp-save").addEventListener("click", () => {
        const title = document.getElementById("mp-title").value.trim();
        if (!title) return;
        const amountVal = parseFloat(
          document.getElementById("mp-amount").value.replace(",", ".")
        );
        if (!amountVal || amountVal <= 0) return;
        const day = parseInt(document.getElementById("mp-day").value, 10);
        if (!day || day < 1 || day > 31) return;
        const description = document
          .getElementById("mp-desc")
          .value.trim();
        const tags = parseTags(document.getElementById("mp-tags").value);
        const priority = document.getElementById("mp-priority").checked;

        state.monthlyPayments.push({
          id: uuid(),
          title,
          amount: Math.round(amountVal),
          dayOfMonth: day,
          description,
          tags,
          priority,
          reserved: 0
        });

        saveState();
        closeSheet();
      });
    }

    function openShortGoalSheet(prefill = {}) {
      const today = todayISO();
      openSheet(
        "Краткосрочная финансовая цель",
        `
        <div class="field-group">
          <div class="field-label">Название цели</div>
          <input type="text" id="sg-title" class="field-input" placeholder="кроссовки, техника, поездка..." value="${
            prefill.title || ""
          }" />
        </div>
        <div class="field-group field-row">
          <div style="flex:1">
            <div class="field-label">Сумма, ₽</div>
            <input type="number" id="sg-amount" class="field-input" inputmode="decimal" value="${
              prefill.amount || ""
            }" />
          </div>
          <div style="flex:1">
            <div class="field-label">Дедлайн</div>
            <input type="date" id="sg-deadline" class="field-input" min="${today}" value="${
          prefill.deadlineISO || today
        }" />
          </div>
        </div>
        <div class="field-group">
          <label class="field-label">
            <input type="checkbox" id="sg-priority" />
            высокий приоритет
          </label>
        </div>
        <div class="field-group">
          <div class="field-label">Дни без заработка (календарь)</div>
          <div class="helper-text">отметь даты между сегодня и дедлайном, когда точно не будешь работать</div>
          <div class="chip-row" id="sg-calendar"></div>
        </div>
        <div class="field-group">
          <div class="field-label">Теги</div>
          <input type="text" id="sg-tags" class="field-input" placeholder="одежда, техника, отдых..." />
        </div>
        <button class="btn btn-primary" id="sg-save">создать цель и расписание</button>
      `
      );

      const deadlineEl = document.getElementById("sg-deadline");
      const calendarEl = document.getElementById("sg-calendar");
      const nonWorkingDates = new Set();

      function rebuildCalendar() {
        const deadlineISO = deadlineEl.value || today;
        calendarEl.innerHTML = "";
        let cursor = today;
        while (compareDateISO(cursor, deadlineISO) <= 0) {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className =
            "chip calendar-chip" +
            (nonWorkingDates.has(cursor) ? " selected" : "");
          btn.textContent = `${formatDate(cursor)} ${weekdayShort(cursor)}`;
          btn.dataset.date = cursor;
          btn.addEventListener("click", () => {
            if (nonWorkingDates.has(cursor)) {
              nonWorkingDates.delete(cursor);
              btn.classList.remove("selected");
            } else {
              nonWorkingDates.add(cursor);
              btn.classList.add("selected");
            }
          });
          calendarEl.appendChild(btn);
          cursor = addDaysISO(cursor, 1);
        }
      }

      deadlineEl.addEventListener("change", rebuildCalendar);
      rebuildCalendar();

      document.getElementById("sg-title").focus();

      document.getElementById("sg-save").addEventListener("click", () => {
        const title = document.getElementById("sg-title").value.trim();
        if (!title) return;
        const amountVal = parseFloat(
          document.getElementById("sg-amount").value.replace(",", ".")
        );
        if (!amountVal || amountVal <= 0) return;
        const deadlineISO =
          document.getElementById("sg-deadline").value || today;
        const tags = parseTags(document.getElementById("sg-tags").value);
        const nonWorkingDatesArr = Array.from(nonWorkingDates);
        const priority = document.getElementById("sg-priority").checked;

        const createdISO = today;
        const total = Math.round(amountVal);
        const schedule = generateSchedule(
          createdISO,
          deadlineISO,
          total,
          nonWorkingDatesArr
        );

        const goal = {
          id: uuid(),
          title,
          amount: total,
          totalAmount: total,
          remaining: total,
          deadlineISO,
          createdISO,
          nonWorkingDates: nonWorkingDatesArr,
          schedule,
          tags,
          priority,
          manualSaved: 0
        };

        state.shortGoals.push(goal);
        saveState();
        closeSheet();
      });
    }

    function openShortGoalScheduleSheet(goal) {
      const pendingCount = goal.schedule.filter(
        (d) => d.status === "pending"
      ).length;
      openSheet(
        `Цель: ${goal.title}`,
        `
        <div class="field-group">
          <div class="field-label">Остаток</div>
          <div class="balance-value" style="font-size:18px;">${goal.remaining.toLocaleString(
            "ru-RU"
          )} ₽</div>
          <div class="helper-text">дедлайн: ${formatDate(
            goal.deadlineISO
          )}, рабочих дней впереди: ${pendingCount}</div>
        </div>
        <div class="section-title">
          <span>Расписание по дням</span>
        </div>
        <div class="schedule-list" id="sched-list"></div>
      `
      );

      const listEl = document.getElementById("sched-list");

      function updateHeader() {
        sheetBodyEl
          .querySelector(".balance-value")
          .innerHTML = `${goal.remaining.toLocaleString("ru-RU")} ₽`;
      }

      function renderScheduleListLocal() {
        const sorted = [...goal.schedule].sort((a, b) =>
          compareDateISO(a.dateISO, b.dateISO)
        );
        listEl.innerHTML = sorted
          .map((d) => {
            const statusLabel =
              d.status === "done"
                ? "выполнено"
                : d.status === "skipped"
                ? "пропущено"
                : "ожидание";
            return `
          <div class="schedule-item">
            <div class="sched-left">
              <span class="sched-date">${formatDate(d.dateISO)} ${weekdayShort(d.dateISO)}</span>
              <span class="sched-plan">план: ${d.planned.toLocaleString(
                "ru-RU"
              )} ₽</span>
              <span class="sched-status ${d.status}">${statusLabel}</span>
            </div>
            <div class="sched-btn-row">
              <button class="sched-btn sched-btn-primary" data-action="done" data-date="${
                d.dateISO
              }">сделал</button>
              <button class="sched-btn" data-action="skip" data-date="${
                d.dateISO
              }">пропустить</button>
              <button class="sched-btn" data-action="reset" data-date="${
                d.dateISO
              }">сбросить</button>
            </div>
          </div>
        `;
          })
          .join("");
      }

      function updateEntryStatus(entry, newStatus) {
        const prev = entry.status || "pending";
        if (prev === newStatus) return;

        if (prev === "done") {
          goal.remaining += entry.planned;
        }

        if (newStatus === "done") {
          goal.remaining = Math.max(0, goal.remaining - entry.planned);
        }

        entry.status = newStatus;
      }

      renderScheduleListLocal();

      listEl.addEventListener("click", (e) => {
        const btn = e.target.closest("[data-action]");
        if (!btn) return;
        const action = btn.getAttribute("data-action");
        const dateISO = btn.getAttribute("data-date");
        if (!dateISO) return;

        const entry = goal.schedule.find((d) => d.dateISO === dateISO);
        if (!entry) return;

        if (action === "done") {
          updateEntryStatus(entry, "done");
        } else if (action === "skip") {
          updateEntryStatus(entry, "skipped");
        } else if (action === "reset") {
          updateEntryStatus(entry, "pending");
        }

        saveState();
        renderScheduleListLocal();
        updateHeader();
      });
    }

    function openGoalSheet() {
      const today = todayISO();
      openSheet(
        "Новая цель/задача",
        `
        <div class="field-group">
          <div class="field-label">Название</div>
          <input type="text" id="g-title" class="field-input" placeholder="что именно хочешь сделать" />
        </div>
        <div class="field-group">
          <div class="field-label">Описание</div>
          <textarea id="g-desc" class="field-textarea" placeholder="детали, если нужно"></textarea>
        </div>
        <div class="field-group">
          <div class="field-label">Тип</div>
          <select id="g-type" class="field-select">
            <option value="day">на день</option>
            <option value="week">на неделю</option>
            <option value="month">на месяц</option>
            <option value="none">без срока</option>
          </select>
        </div>
        <div class="field-group">
          <div class="field-label">Дедлайн (опционально)</div>
          <input type="date" id="g-deadline" class="field-input" min="${today}" />
        </div>
        <div class="field-group">
          <div class="field-label">Теги</div>
          <input type="text" id="g-tags" class="field-input" placeholder="спорт, работа, развитие..." />
        </div>
        <div class="field-group">
          <label class="field-label">
            <input type="checkbox" id="g-has-fin" />
            есть финансовый расход
          </label>
          <div class="helper-text">если включишь, создастся ещё и финансовая цель в разделе "Финансы"</div>
        </div>
        <div id="g-fin-block" style="display:none;">
          <div class="field-group field-row">
            <div style="flex:1">
              <div class="field-label">Сумма, ₽</div>
              <input type="number" id="g-fin-amount" class="field-input" inputmode="decimal" />
            </div>
            <div style="flex:1">
              <div class="field-label">Дедлайн (финансовый)</div>
              <input type="date" id="g-fin-deadline" class="field-input" min="${today}" />
            </div>
          </div>
          <div class="field-group">
            <label class="field-label">
              <input type="checkbox" id="g-fin-priority" />
              высокий приоритет фин. цели
            </label>
          </div>
        </div>
        <div class="field-group">
          <div class="field-label">Микроцели (опционально)</div>
          <div id="subtasks-container"></div>
          <button class="btn btn-small btn-outline" type="button" id="add-subtask">+ микроцель</button>
          <div class="helper-text">можно разбить цель на несколько маленьких шагов</div>
        </div>
        <button class="btn btn-primary" id="g-save">создать</button>
      `
      );

      const hasFinEl = document.getElementById("g-has-fin");
      const finBlockEl = document.getElementById("g-fin-block");
      hasFinEl.addEventListener("change", () => {
        finBlockEl.style.display = hasFinEl.checked ? "block" : "none";
      });

      const subtasksContainer = document.getElementById("subtasks-container");
      const addSubBtn = document.getElementById("add-subtask");

      function addSubtaskRow(value = "") {
        const row = document.createElement("div");
        row.className = "field-row subtask-row";
        row.innerHTML = `
          <input type="text" class="field-input subtask-title" placeholder="например: записаться, собрать документы..." value="${value}" />
        `;
        subtasksContainer.appendChild(row);
      }

      addSubBtn.addEventListener("click", () => addSubtaskRow());

      document.getElementById("g-title").focus();

      document.getElementById("g-save").addEventListener("click", () => {
        const title = document.getElementById("g-title").value.trim();
        if (!title) return;
        const description = document
          .getElementById("g-desc")
          .value.trim();
        const type = document.getElementById("g-type").value;
        const deadlineISO =
          document.getElementById("g-deadline").value || null;
        const tags = parseTags(document.getElementById("g-tags").value);
        const hasFin = hasFinEl.checked;

        const subInputs = subtasksContainer.querySelectorAll(".subtask-title");
        const subtasks = Array.from(subInputs)
          .map((inp) => inp.value.trim())
          .filter(Boolean)
          .map((t) => ({
            id: uuid(),
            title: t,
            done: false
          }));

        let linkedShortGoalId = null;

        if (hasFin) {
          const finAmountVal = parseFloat(
            document
              .getElementById("g-fin-amount")
              .value.replace(",", ".")
          );
          const finDeadline =
            document.getElementById("g-fin-deadline").value || deadlineISO;
          const finPriority = document.getElementById("g-fin-priority").checked;
          if (!finAmountVal || finAmountVal <= 0 || !finDeadline) {
            return;
          }

          const createdISO = today;
          const total = Math.round(finAmountVal);
          const nonWorkingDates = [];
          const schedule = generateSchedule(
            createdISO,
            finDeadline,
            total,
            nonWorkingDates
          );

          const sg = {
            id: uuid(),
            title: title + " (фин.)",
            amount: total,
            totalAmount: total,
            remaining: total,
            deadlineISO: finDeadline,
            createdISO,
            nonWorkingDates,
            schedule,
            tags,
            priority: finPriority,
            manualSaved: 0
          };
          state.shortGoals.push(sg);
          linkedShortGoalId = sg.id;
        }

        const goal = {
          id: uuid(),
          title,
          description,
          type,
          createdISO: today,
          deadlineISO,
          tags,
          linkedShortGoalId,
          subtasks,
          done: false
        };

        state.goals.push(goal);
        saveState();
        closeSheet();
      });
    }

    function openEditGoalSheet(goal) {
      const today = todayISO();
      openSheet(
        "Редактировать цель",
        `
        <div class="field-group">
          <div class="field-label">Название</div>
          <input type="text" id="eg-title" class="field-input" value="${goal.title}" />
        </div>
        <div class="field-group">
          <div class="field-label">Описание</div>
          <textarea id="eg-desc" class="field-textarea">${goal.description || ""}</textarea>
        </div>
        <div class="field-group">
          <div class="field-label">Тип</div>
          <select id="eg-type" class="field-select">
            <option value="day">на день</option>
            <option value="week">на неделю</option>
            <option value="month">на месяц</option>
            <option value="none">без срока</option>
          </select>
        </div>
        <div class="field-group">
          <div class="field-label">Дедлайн (опционально)</div>
          <input type="date" id="eg-deadline" class="field-input" min="${today}" />
        </div>
        <div class="field-group">
          <div class="field-label">Теги</div>
          <input type="text" id="eg-tags" class="field-input" value="${(goal.tags || []).join(", ")}" />
        </div>
        <div class="field-group">
          <div class="field-label">Микроцели</div>
          <div id="eg-subtasks-container"></div>
          <button class="btn btn-small btn-outline" type="button" id="eg-add-subtask">+ микроцель</button>
          <div class="helper-text">можно удалить ненужные или добавить новые</div>
        </div>
        <button class="btn btn-primary" id="eg-save">сохранить</button>
      `
      );

      const typeSelect = document.getElementById("eg-type");
      typeSelect.value = goal.type || "none";

      const deadlineInput = document.getElementById("eg-deadline");
      if (goal.deadlineISO) {
        deadlineInput.value = goal.deadlineISO;
      }

      const subtasksContainer = document.getElementById("eg-subtasks-container");
      const addSubBtn = document.getElementById("eg-add-subtask");

      function addSubtaskRow(sub) {
        const row = document.createElement("div");
        row.className = "field-row subtask-row";
        row.dataset.id = sub?.id || "";
        row.innerHTML = `
          <input type="text" class="field-input eg-subtask-title" value="${sub ? sub.title : ""}" />
          <button type="button" class="btn btn-small btn-outline eg-subtask-remove">×</button>
        `;
        subtasksContainer.appendChild(row);
      }

      (goal.subtasks || []).forEach((s) => addSubtaskRow(s));

      addSubBtn.addEventListener("click", () => addSubtaskRow(null));

      subtasksContainer.addEventListener("click", (e) => {
        const rm = e.target.closest(".eg-subtask-remove");
        if (!rm) return;
        const row = rm.closest(".subtask-row");
        if (row) row.remove();
      });

      document.getElementById("eg-save").addEventListener("click", () => {
        const title = document.getElementById("eg-title").value.trim();
        if (!title) return;
        const description = document.getElementById("eg-desc").value.trim();
        const type = document.getElementById("eg-type").value;
        const deadlineISO = deadlineInput.value || null;
        const tags = parseTags(document.getElementById("eg-tags").value);

        const oldSubs = goal.subtasks || [];
        const rows = subtasksContainer.querySelectorAll(".subtask-row");
        const newSubs = [];
        rows.forEach((row) => {
          const id = row.dataset.id || uuid();
          const titleEl = row.querySelector(".eg-subtask-title");
          const text = (titleEl.value || "").trim();
          if (!text) return;
          const old = oldSubs.find((s) => s.id === id);
          newSubs.push({
            id,
            title: text,
            done: old ? old.done : false
          });
        });

        goal.title = title;
        goal.description = description;
        goal.type = type;
        goal.deadlineISO = deadlineISO;
        goal.tags = tags;
        goal.subtasks = newSubs;

        if (goal.subtasks.length && goal.subtasks.every((s) => s.done)) {
          goal.done = true;
        }

        saveState();
        closeSheet();
      });
    }

    // ====== BACKUP SHEET (EXPORT / IMPORT) ======

    function openBackupSheet() {
      const json = JSON.stringify(state, null, 2);
      openSheet(
        "Экспорт / импорт данных",
        `
        <div class="field-group">
          <div class="field-label">Экспорт (копия текущего состояния)</div>
          <textarea id="backup-export" class="mono" readonly>${json}</textarea>
          <div class="helper-text">можешь скопировать это в заметки / файл, чтобы потом восстановить</div>
          <button class="btn btn-primary" id="backup-copy">скопировать</button>
        </div>
        <div class="field-group">
          <div class="field-label">Импорт</div>
          <textarea id="backup-import" class="mono" placeholder="вставь сюда ранее сохранённый JSON и нажми &quot;импортировать&quot;"></textarea>
          <div class="helper-text">внимание: при импорте текущее состояние будет заменено на загруженное</div>
        </div>
        <button class="btn btn-ghost" id="backup-apply">импортировать</button>
      `
      );

      const exportEl = document.getElementById("backup-export");
      const importEl = document.getElementById("backup-import");
      const copyBtn = document.getElementById("backup-copy");
      const applyBtn = document.getElementById("backup-apply");

      copyBtn.addEventListener("click", async () => {
        try {
          if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(exportEl.value);
          } else {
            exportEl.focus();
            exportEl.select();
          }
        } catch (e) {
          console.error("clipboard error", e);
        }
      });

      applyBtn.addEventListener("click", () => {
        const raw = importEl.value.trim();
        if (!raw) return;
        let parsed;
        try {
          parsed = JSON.parse(raw);
        } catch (e) {
          alert("Некорректный JSON, проверь данные.");
          return;
        }
        if (!parsed || typeof parsed !== "object") {
          alert("Структура данных некорректна.");
          return;
        }
        if (!confirm("Текущее состояние будет перезаписано. Продолжить?")) {
          return;
        }
        state = { ...structuredClone(defaultState), ...parsed };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        state = loadState();
        render();
        closeSheet();
      });
    }

    // ====== NAV TABS INIT & HEADER BTNS ======

    document.querySelectorAll(".nav-tab").forEach((tab) => {
      tab.addEventListener("click", () => {
        const t = tab.getAttribute("data-tab");
        if (t === activeTab) return;
        activeTab = t;
        document
          .querySelectorAll(".nav-tab")
          .forEach((node) => node.classList.remove("active"));
        tab.classList.add("active");
        render();
      });
    });

    const backupBtn = document.getElementById("btn-backup");
    if (backupBtn) {
      backupBtn.addEventListener("click", () => openBackupSheet());
    }

    const settingsBtn = document.getElementById("btn-settings");
    if (settingsBtn) {
      settingsBtn.addEventListener("click", () => openSettingsSheet());
    }

    // ====== INITIAL RENDER ======
    render();
  </script>
</body>
</html>