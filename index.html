<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Core Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #020617;
      --bg-elevated: #020617;
      --card: #020617;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.12);
      --accent-strong: #16a34a;
      --danger: #f97373;
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --border-soft: #1f2937;
      --tag-bg: #020617;
      --tag-border: #1f2937;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      font-family: -apple-system, system-ui, BlinkMacSystemFont, "SF Pro Text",
        sans-serif;
      background: radial-gradient(circle at top, #0b1120 0, #020617 45%, #000 100%);
      color: var(--text-main);
      display: flex;
      justify-content: center;
    }

    body.light-theme {
      --bg: #f3f4f6;
      --bg-elevated: #e5e7eb;
      --card: #ffffff;
      --accent: #16a34a;
      --accent-soft: rgba(22, 163, 74, 0.12);
      --accent-strong: #15803d;
      --danger: #dc2626;
      --text-main: #0f172a;
      --text-muted: #6b7280;
      --border-soft: #d1d5db;
      --tag-bg: #f9fafb;
      --tag-border: #e5e7eb;
      background: radial-gradient(circle at top, #e5e7eb 0, #f3f4f6 45%, #e5e7eb 100%);
      color: var(--text-main);
    }

    .app {
      width: 100%;
      max-width: 480px;
      min-height: 100vh;
      padding: 16px 12px 24px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      gap: 8px;
    }

    .app-title {
      font-weight: 700;
      letter-spacing: 0.03em;
      font-size: 18px;
    }

    .app-subtitle {
      font-size: 11px;
      color: var(--text-muted);
    }

    .header-actions {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .icon-btn {
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: rgba(15, 23, 42, 0.9);
      padding: 6px 8px;
      font-size: 14px;
      cursor: pointer;
      color: var(--text-muted);
    }

    body.light-theme .icon-btn {
      background: #f9fafb;
    }

    .nav-tabs {
      display: flex;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 999px;
      padding: 4px;
      border: 1px solid var(--border-soft);
      margin-bottom: 8px;
    }

    body.light-theme .nav-tabs {
      background: rgba(243, 244, 246, 0.9);
    }

    .nav-tab {
      flex: 1;
      padding: 8px 0;
      border-radius: 999px;
      text-align: center;
      font-size: 13px;
      cursor: pointer;
      user-select: none;
      color: var(--text-muted);
      transition: background 0.15s ease, color 0.15s ease;
    }

    .nav-tab.active {
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: #020617;
      font-weight: 600;
    }

    .content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .card {
      background: var(--card);
      border-radius: 18px;
      padding: 14px 14px 12px;
      border: 1px solid var(--border-soft);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.6);
    }

    body.light-theme .card {
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      gap: 8px;
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .card-subtitle {
      font-size: 11px;
      color: var(--text-muted);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      padding: 3px 7px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid var(--tag-border);
      background: var(--tag-bg);
      font-size: 10px;
      color: var(--text-muted);
    }

    .tag-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--accent);
    }

    .btn-row {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    .btn {
      flex: 1;
      border-radius: 999px;
      padding: 8px 10px;
      border: 1px solid var(--border-soft);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-main);
      font-size: 12px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      user-select: none;
      transition: background 0.12s ease, border-color 0.12s ease,
        transform 0.05s ease;
    }

    body.light-theme .btn {
      background: #f9fafb;
    }

    .btn:active {
      transform: scale(0.97);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      border-color: transparent;
      color: #020617;
      font-weight: 600;
    }

    .btn-ghost {
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-main);
    }

    .btn-small {
      flex: 0;
      padding: 4px 8px;
      font-size: 11px;
    }

    .btn-outline {
      background: transparent;
      color: var(--text-muted);
    }

    .section-title {
      font-size: 12px;
      font-weight: 600;
      margin-top: 4px;
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }

    .section-subtitle {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .balance-value {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .balance-label {
      font-size: 11px;
      color: var(--text-muted);
    }

    .muted {
      font-size: 11px;
      color: var(--text-muted);
    }

    .empty {
      font-size: 11px;
      color: var(--text-muted);
      font-style: italic;
      margin-top: 4px;
    }

    .list {
      max-height: 180px;
      overflow-y: auto;
      padding-right: 2px;
    }

    .list::-webkit-scrollbar {
      width: 3px;
    }

    .list::-webkit-scrollbar-thumb {
      background: #1f2937;
      border-radius: 999px;
    }

    .tx-item {
      padding: 6px 0;
      border-bottom: 1px dashed rgba(31, 41, 55, 0.9);
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .tx-main {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      font-size: 12px;
    }

    .tx-amount {
      font-weight: 600;
      white-space: nowrap;
    }

    .tx-amount.income {
      color: var(--accent);
    }

    .tx-amount.expense {
      color: var(--danger);
    }

    .tx-meta {
      font-size: 10px;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 3px;
    }

    .chip {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-muted);
    }

    body.light-theme .chip {
      background: #f9fafb;
    }

    .pill-small {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
    }

    .field-group {
      margin-bottom: 8px;
    }

    .field-label {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 3px;
    }

    .field-input,
    .field-textarea,
    .field-select {
      width: 100%;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-main);
      padding: 7px 9px;
      font-size: 12px;
      outline: none;
    }

    body.light-theme .field-input,
    body.light-theme .field-textarea,
    body.light-theme .field-select {
      background: #f9fafb;
    }

    .field-input:focus,
    .field-textarea:focus,
    .field-select:focus {
      border-color: var(--accent);
    }

    .field-textarea {
      min-height: 60px;
      resize: vertical;
    }

    .field-row {
      display: flex;
      gap: 8px;
    }

    .helper-text {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    /* bottom sheet */

    .sheet-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.7);
      backdrop-filter: blur(8px);
      display: none;
      justify-content: flex-end;
      z-index: 30;
    }

    .sheet-backdrop.visible {
      display: flex;
    }

    .sheet {
      width: 100%;
      max-width: 480px;
      background: var(--bg);
      border-radius: 18px 18px 0 0;
      border-top: 1px solid var(--border-soft);
      padding: 10px 14px 14px;
      box-shadow: 0 -22px 40px rgba(0, 0, 0, 0.8);
    }

    .sheet-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .sheet-title {
      font-size: 14px;
      font-weight: 600;
    }

    .sheet-close {
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-muted);
      font-size: 11px;
      padding: 4px 8px;
      cursor: pointer;
    }

    body.light-theme .sheet-close {
      background: #f9fafb;
    }

    /* schedule */

    .schedule-list {
      max-height: 220px;
      overflow-y: auto;
      padding-right: 2px;
    }

    .schedule-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      padding: 4px 0;
      border-bottom: 1px dashed rgba(31, 41, 55, 0.9);
      font-size: 11px;
    }

    .sched-left {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .sched-date {
      font-weight: 500;
    }

    .sched-plan {
      color: var(--text-muted);
      font-size: 10px;
    }

    .sched-status {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-muted);
      white-space: nowrap;
    }

    .sched-status.done {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(34, 197, 94, 0.08);
    }

    .sched-status.skipped {
      border-color: var(--danger);
      color: var(--danger);
      background: rgba(248, 113, 113, 0.08);
    }

    .sched-btn-row {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .sched-btn {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-main);
      cursor: pointer;
      white-space: nowrap;
    }

    body.light-theme .sched-btn {
      background: #f9fafb;
    }

    .sched-btn-primary {
      border-color: var(--accent);
      color: var(--accent);
    }

    .calendar-chip {
      font-size: 10px;
      padding: 3px 6px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-muted);
      cursor: pointer;
    }

    body.light-theme .calendar-chip {
      background: #f9fafb;
    }

    .calendar-chip.selected {
      border-color: var(--danger);
      color: var(--danger);
      background: rgba(248, 113, 113, 0.1);
    }

    /* goals */

    .goal-type-pill {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-muted);
      white-space: nowrap;
    }

    body.light-theme .goal-type-pill {
      background: #f9fafb;
    }

    .goal-type-pill[data-type="day"] {
      color: #f97316;
      border-color: #f97316;
      background: rgba(248, 148, 62, 0.08);
    }

    .goal-type-pill[data-type="week"] {
      color: #38bdf8;
      border-color: #38bdf8;
      background: rgba(56, 189, 248, 0.08);
    }

    .goal-type-pill[data-type="month"] {
      color: #a855f7;
      border-color: #a855f7;
      background: rgba(168, 85, 247, 0.08);
    }

    .goal-type-pill[data-type="none"] {
      color: var(--text-muted);
    }

    .goals-group {
      margin-bottom: 10px;
    }

    .goal-box {
      border-radius: 14px;
      border: 1px solid var(--border-soft);
      padding: 8px 10px;
      margin-bottom: 6px;
      background: rgba(15, 23, 42, 0.9);
    }

    body.light-theme .goal-box {
      background: #ffffff;
    }

    .goal-box.done {
      opacity: 0.6;
    }

    .goal-box-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      font-size: 12px;
    }

    .goal-main {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .goal-title-text {
      font-weight: 500;
    }

    .goal-actions {
      display: flex;
      gap: 4px;
      align-items: center;
    }

    .subtask-list {
      list-style: none;
      padding: 0;
      margin: 4px 0 0;
    }

    .subtask-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .subtask-toggle {
      accent-color: var(--accent);
    }

    .small-inline {
      font-size: 10px;
      color: var(--text-muted);
    }

    /* progress circle */

    .progress-circle {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: conic-gradient(
        var(--accent) 0deg,
        var(--accent) 0deg,
        #020617 0deg
      );
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: var(--text-main);
      flex-shrink: 0;
    }

    body.light-theme .progress-circle {
      background-color: #e5e7eb;
    }

    .progress-circle-inner {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: var(--card);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* analytics */

    .analytics-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 4px;
    }

    .analytics-item {
      font-size: 11px;
    }

    .analytics-label {
      font-size: 10px;
      color: var(--text-muted);
    }

    .analytics-value {
      font-size: 13px;
      font-weight: 500;
    }

    .day-row {
      margin-bottom: 6px;
    }

    .day-main {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
    }

    .day-bar {
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: #020617;
      overflow: hidden;
      margin-top: 3px;
    }

    body.light-theme .day-bar {
      background: #e5e7eb;
    }

    .day-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent-strong));
    }

    /* achievements */

    .badge {
      border-radius: 14px;
      border: 1px solid var(--border-soft);
      padding: 8px 10px;
      margin-bottom: 6px;
      background: rgba(15, 23, 42, 0.9);
      font-size: 11px;
    }

    body.light-theme .badge {
      background: #ffffff;
    }

    .badge-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .badge-title {
      font-size: 12px;
      font-weight: 500;
    }

    .badge-level {
      font-size: 11px;
      color: var(--accent);
    }

    /* mono area */

    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      width: 100%;
      min-height: 80px;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-main);
      padding: 6px 8px;
      resize: vertical;
    }

    body.light-theme .mono {
      background: #f9fafb;
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="app-header">
      <div>
        <div class="app-title">Core Tracker</div>
        <div class="app-subtitle">финансы · цели · дисциплина</div>
      </div>
      <div class="header-actions">
        <button class="icon-btn" id="btn-settings">⚙</button>
      </div>
    </header>

    <nav class="nav-tabs">
      <div class="nav-tab active" data-tab="finance">Финансы</div>
      <div class="nav-tab" data-tab="goals">Цели</div>
      <div class="nav-tab" data-tab="analytics">Аналитика</div>
      <div class="nav-tab" data-tab="achievements">Достижения</div>
    </nav>

    <main class="content" id="content"></main>
  </div>

  <!-- bottom sheet -->
  <div class="sheet-backdrop" id="sheet-backdrop">
    <div class="sheet" id="sheet">
      <div class="sheet-header">
        <div class="sheet-title" id="sheet-title"></div>
        <button class="sheet-close" id="sheet-close">закрыть</button>
      </div>
      <div id="sheet-body"></div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "core_tracker_state_v2";
    const THEME_KEY = "core_tracker_theme_mode_v2";

    const defaultState = {
      balance: 0,
      transactions: [], // {id,type,amount,note,tags,dateISO}
      monthlyPayments: [], // {id,title,amount,dayOfMonth,description,tags,priority,allocated}
      shortGoals: [], // {id,title,totalAmount,remaining,deadlineISO,createdISO,schedule[],tags}
      goals: [], // active goals
      goalHistory: [], // archived goals
      expenseTemplates: [], // {id,title,amount}
      tagConfig: [] // {id,name,icon,color}
    };

    let state = loadState();
    let themeMode = loadThemeMode();
    let activeTab = "finance";
    let analyticsMode = "finance";

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return structuredClone(defaultState);
        const parsed = JSON.parse(raw);
        const merged = { ...structuredClone(defaultState), ...parsed };
        merged.monthlyPayments = (merged.monthlyPayments || []).map((p) => ({
          allocated: 0,
          priority: false,
          ...p
        }));
        merged.shortGoals = (merged.shortGoals || []).map((g) => ({
          schedule: [],
          ...g
        }));
        merged.goals = (merged.goals || []).map((g) => ({
          subtasks: [],
          done: false,
          ...g
        }));
        merged.goalHistory = merged.goalHistory || [];
        merged.expenseTemplates = merged.expenseTemplates || [];
        merged.tagConfig = merged.tagConfig || [];
        return merged;
      } catch (e) {
        console.error(e);
        return structuredClone(defaultState);
      }
    }

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      render();
    }

    function loadThemeMode() {
      try {
        const raw = localStorage.getItem(THEME_KEY);
        if (raw === "dark" || raw === "light" || raw === "auto") return raw;
      } catch {}
      return "auto";
    }

    function saveThemeMode(mode) {
      themeMode = mode;
      localStorage.setItem(THEME_KEY, mode);
      applyTheme();
    }

    function systemPrefersDark() {
      return (
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches
      );
    }

    function applyTheme() {
      let effective = themeMode;
      if (effective === "auto") {
        effective = systemPrefersDark() ? "dark" : "light";
      }
      document.body.classList.toggle("light-theme", effective === "light");
    }

    applyTheme();

    function uuid() {
      return Math.random().toString(36).slice(2) + Date.now().toString(36);
    }

    function todayISO() {
      return new Date().toISOString().slice(0, 10);
    }

    function formatDate(dateISO) {
      if (!dateISO) return "";
      const d = new Date(dateISO);
      if (Number.isNaN(d.getTime())) return "";
      const dd = String(d.getDate()).padStart(2, "0");
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      return `${dd}.${mm}`;
    }

    function weekdayShort(dateISO) {
      const d = new Date(dateISO);
      const map = ["вс", "пн", "вт", "ср", "чт", "пт", "сб"];
      return map[d.getDay()];
    }

    function compareISO(a, b) {
      if (a < b) return -1;
      if (a > b) return 1;
      return 0;
    }

    function addDaysISO(dateISO, days) {
      const d = new Date(dateISO);
      d.setDate(d.getDate() + days);
      return d.toISOString().slice(0, 10);
    }

    function parseTags(str) {
      if (!str) return [];
      return str
        .split(",")
        .map((t) => t.trim())
        .filter(Boolean);
    }

    function tagsToHTML(tags) {
      if (!tags || !tags.length) return "";
      return (
        `<div class="chip-row">` +
        tags
          .map((t) => {
            const conf = state.tagConfig.find((c) => c.name === t);
            const icon = conf?.icon || "";
            return `<span class="chip">${icon ? icon + " " : ""}#${t}</span>`;
          })
          .join("") +
        `</div>`
      );
    }

    function progressCircleHTML(pct) {
      const clamped = Math.max(0, Math.min(100, Math.round(pct || 0)));
      const deg = (clamped / 100) * 360;
      return `
        <div class="progress-circle" style="background:conic-gradient(var(--accent) 0deg,var(--accent) ${deg}deg,#020617 ${deg}deg);">
          <div class="progress-circle-inner">${clamped}%</div>
        </div>
      `;
    }

    // bottom sheet

    const backdropEl = document.getElementById("sheet-backdrop");
    const sheetTitleEl = document.getElementById("sheet-title");
    const sheetBodyEl = document.getElementById("sheet-body");
    const sheetCloseBtn = document.getElementById("sheet-close");

    sheetCloseBtn.addEventListener("click", closeSheet);
    backdropEl.addEventListener("click", (e) => {
      if (e.target === backdropEl) closeSheet();
    });

    function openSheet(title, innerHTML) {
      sheetTitleEl.textContent = title;
      sheetBodyEl.innerHTML = innerHTML;
      backdropEl.classList.add("visible");
    }

    function closeSheet() {
      backdropEl.classList.remove("visible");
      sheetBodyEl.innerHTML = "";
    }

    // nav

    const contentEl = document.getElementById("content");

    document.querySelectorAll(".nav-tab").forEach((tab) => {
      tab.addEventListener("click", () => {
        const t = tab.getAttribute("data-tab");
        if (t === activeTab) return;
        activeTab = t;
        document
          .querySelectorAll(".nav-tab")
          .forEach((n) => n.classList.remove("active"));
        tab.classList.add("active");
        render();
      });
    });

    // SETTINGS BUTTON

    document.getElementById("btn-settings").addEventListener("click", () => {
      openSettingsSheet();
    });

    // RENDER ROOT

    function render() {
      if (activeTab === "finance") renderFinance();
      else if (activeTab === "goals") renderGoals();
      else if (activeTab === "analytics") renderAnalytics();
      else renderAchievements();
    }

    // ===== FINANCE TAB =====

    function expectedBalanceFromTx() {
      let total = 0;
      for (const tx of state.transactions) {
        total += tx.type === "income" ? tx.amount : -tx.amount;
      }
      return total;
    }

    function renderFinance() {
      contentEl.innerHTML = "";

      const untracked = state.balance - expectedBalanceFromTx();

      // balance card
      const balanceCard = document.createElement("section");
      balanceCard.className = "card";
      balanceCard.innerHTML = `
        <div class="card-header">
          <div>
            <div class="card-title">
              Баланс
              <span class="pill">
                <span class="tag-dot"></span>
                на руках
              </span>
            </div>
            <div class="card-subtitle">реальный баланс без магии</div>
          </div>
          <button class="btn btn-small btn-outline" id="btn-set-balance">править</button>
        </div>
        <div class="balance-value">${state.balance.toLocaleString(
          "ru-RU"
        )} ₽</div>
        <div class="balance-label">текущий баланс на руках</div>
        ${
          untracked !== 0
            ? `<div class="helper-text">неучтённая сумма: ${untracked > 0 ? "+" : "−"}${Math.abs(
                untracked
              ).toLocaleString(
                "ru-RU"
              )} ₽ (значит, не все доходы/расходы записаны)</div>`
            : ""
        }
        <div class="btn-row">
          <button class="btn btn-primary" id="btn-add-income">+ доход</button>
          <button class="btn btn-ghost" id="btn-add-expense">− расход</button>
        </div>
        <div class="section-title">
          <span>История операций</span>
        </div>
        <div class="list" id="tx-list"></div>
      `;
      contentEl.appendChild(balanceCard);

      const txListEl = balanceCard.querySelector("#tx-list");
      if (!state.transactions.length) {
        txListEl.innerHTML = `<div class="empty">операций пока нет</div>`;
      } else {
        const sorted = [...state.transactions].sort((a, b) =>
          a.dateISO < b.dateISO ? 1 : -1
        );
        txListEl.innerHTML = sorted
          .map((tx) => {
            return `
            <div class="tx-item" data-tx-id="${tx.id}">
              <div class="tx-main">
                <span>${tx.note || "(без описания)"}</span>
                <span class="tx-amount ${tx.type}">${
              tx.type === "income" ? "+" : "−"
            }${tx.amount.toLocaleString("ru-RU")} ₽</span>
              </div>
              <div class="tx-meta">
                <span>${formatDate(tx.dateISO)}</span>
                <span>
                  <button class="btn btn-small btn-outline" data-edit-tx="${
                    tx.id
                  }">изменить</button>
                  <button class="btn btn-small btn-outline" data-del-tx="${
                    tx.id
                  }">удалить</button>
                </span>
              </div>
              ${tagsToHTML(tx.tags)}
            </div>
          `;
          })
          .join("");
      }

      // free money (allocation to monthly)
      const freeCard = document.createElement("section");
      freeCard.className = "card";
      freeCard.innerHTML = `
        <div class="card-header">
          <div>
            <div class="card-title">Свободные деньги</div>
            <div class="card-subtitle">распределение на ежемесячные платежи</div>
          </div>
        </div>
        <div class="section-subtitle">
          ежемесячные цели получают прогресс отсюда, баланс на руках не трогаем автоматически
        </div>
        <div class="list" id="free-list"></div>
      `;
      contentEl.appendChild(freeCard);

      const freeListEl = freeCard.querySelector("#free-list");
      if (!state.monthlyPayments.length) {
        freeListEl.innerHTML =
          '<div class="empty">пока нет ежемесячных целей</div>';
      } else {
        const sorted = [...state.monthlyPayments].sort((a, b) => {
          if (!!b.priority !== !!a.priority) return b.priority ? 1 : -1;
          if (b.amount !== a.amount) return b.amount - a.amount;
          return a.dayOfMonth - b.dayOfMonth;
        });
        freeListEl.innerHTML = sorted
          .map((p) => {
            const collectPct =
              p.amount > 0 ? Math.round((p.allocated || 0) / p.amount * 100) : 0;
            return `
            <div class="tx-item" data-mp-id="${p.id}">
              <div class="tx-main">
                <span>${p.title}</span>
                <span class="tx-amount expense">${p.amount.toLocaleString(
                  "ru-RU"
                )} ₽</span>
              </div>
              <div class="tx-meta">
                <span>${p.dayOfMonth}-го числа</span>
                <span>${
                  p.priority
                    ? '<span class="pill-small">приоритет</span>'
                    : ""
                }</span>
              </div>
              <div class="chip-row">
                ${progressCircleHTML(collectPct)}
                <span class="small-inline">собрано ${(
                  p.allocated || 0
                ).toLocaleString("ru-RU")} ₽ · осталось ${(Math.max(
              0,
              p.amount - (p.allocated || 0)
            )).toLocaleString("ru-RU")} ₽</span>
              </div>
              <div class="btn-row" style="margin-top:6px;">
                <button class="btn btn-small btn-ghost" data-alloc="${
                  p.id
                }">выделить</button>
                <button class="btn btn-small btn-outline" data-unalloc="${
                  p.id
                }">отменить</button>
              </div>
            </div>
          `;
          })
          .join("");
      }

      // monthly payments card (info)
      const paymentsCard = document.createElement("section");
      paymentsCard.className = "card";
      paymentsCard.innerHTML = `
        <div class="card-header">
          <div>
            <div class="card-title">Ежемесячные цели</div>
            <div class="card-subtitle">подписки, квартира, обязательства</div>
          </div>
          <button class="btn btn-small btn-outline" id="btn-add-monthly">+ цель</button>
        </div>
        <div class="list" id="mp-list"></div>
      `;
      contentEl.appendChild(paymentsCard);

      const mpListEl = paymentsCard.querySelector("#mp-list");
      if (!state.monthlyPayments.length) {
        mpListEl.innerHTML = `<div class="empty">ежемесячных целей пока нет</div>`;
      } else {
        const sorted = [...state.monthlyPayments].sort((a, b) => {
          if (!!b.priority !== !!a.priority) return b.priority ? 1 : -1;
          if (b.amount !== a.amount) return b.amount - a.amount;
          return a.dayOfMonth - b.dayOfMonth;
        });
        mpListEl.innerHTML = sorted
          .map((p) => {
            const pct =
              p.amount > 0 ? Math.round((p.allocated || 0) / p.amount * 100) : 0;
            return `
            <div class="tx-item">
              <div class="tx-main">
                <span>${p.title}</span>
                <span class="tx-amount expense">${p.amount.toLocaleString(
                  "ru-RU"
                )} ₽</span>
              </div>
              <div class="tx-meta">
                <span>оплата ${p.dayOfMonth}-го числа</span>
              </div>
              <div class="chip-row">
                ${progressCircleHTML(pct)}
                ${
                  p.priority
                    ? '<span class="pill-small">приоритет</span>'
                    : ""
                }
                <button class="btn btn-small btn-outline" data-del-mp="${
                  p.id
                }">удалить</button>
              </div>
              ${p.description ? `<div class="muted">${p.description}</div>` : ""}
              ${tagsToHTML(p.tags)}
            </div>
          `;
          })
          .join("");
      }

      // short financial goals
      const shortCard = document.createElement("section");
      shortCard.className = "card";
      shortCard.innerHTML = `
        <div class="card-header">
          <div>
            <div class="card-title">Финансовые цели</div>
            <div class="card-subtitle">краткосрочные накопления по расписанию</div>
          </div>
          <button class="btn btn-small btn-outline" id="btn-add-short-goal">+ цель</button>
        </div>
        <div class="list" id="short-list"></div>
      `;
      contentEl.appendChild(shortCard);

      const shortListEl = shortCard.querySelector("#short-list");
      if (!state.shortGoals.length) {
        shortListEl.innerHTML = `<div class="empty">финансовых целей пока нет</div>`;
      } else {
        const sorted = [...state.shortGoals].sort((a, b) =>
          compareISO(a.deadlineISO, b.deadlineISO)
        );
        const today = todayISO();
        shortListEl.innerHTML = sorted
          .map((g) => {
            const doneSum = g.schedule
              .filter((d) => d.status === "done")
              .reduce((acc, d) => acc + (d.planned || 0), 0);
            const pct =
              g.totalAmount > 0
                ? Math.round((doneSum / g.totalAmount) * 100)
                : 0;
            const daysLeft =
              (new Date(g.deadlineISO) - new Date(today)) /
              (1000 * 60 * 60 * 24);
            return `
            <div class="tx-item" data-sg-id="${g.id}">
              <div class="tx-main">
                <span>${g.title}</span>
                <span class="tx-amount income">${g.totalAmount.toLocaleString(
                  "ru-RU"
                )} ₽</span>
              </div>
              <div class="tx-meta">
                <span>дедлайн: ${formatDate(g.deadlineISO)}</span>
                <span>${
                  daysLeft >= 0
                    ? "осталось ~" + Math.ceil(daysLeft) + " дн."
                    : "дедлайн прошёл"
                }</span>
              </div>
              <div class="chip-row">
                ${progressCircleHTML(pct)}
                <span class="small-inline">осталось ${Math.max(
                  0,
                  g.totalAmount - doneSum
                ).toLocaleString("ru-RU")} ₽</span>
                <button class="btn btn-small btn-outline" data-open-sched="${
                  g.id
                }">расписание</button>
                <button class="btn btn-small btn-outline" data-del-sg="${
                  g.id
                }">удалить</button>
              </div>
              ${tagsToHTML(g.tags)}
            </div>
          `;
          })
          .join("");
      }

      // handlers
      balanceCard
        .querySelector("#btn-add-income")
        .addEventListener("click", () => openIncomeSheet());
      balanceCard
        .querySelector("#btn-add-expense")
        .addEventListener("click", () => openExpenseSheet());
      balanceCard
        .querySelector("#btn-set-balance")
        .addEventListener("click", () => openBalanceSheet());

      txListEl.addEventListener("click", (e) => {
        const del = e.target.closest("[data-del-tx]");
        if (del) {
          const id = del.getAttribute("data-del-tx");
          const tx = state.transactions.find((t) => t.id === id);
          if (!tx) return;
          if (!confirm("Удалить эту операцию?")) return;
          if (tx.type === "income") state.balance -= tx.amount;
          else state.balance += tx.amount;
          state.transactions = state.transactions.filter((t) => t.id !== id);
          saveState();
          return;
        }
        const edit = e.target.closest("[data-edit-tx]");
        if (edit) {
          const id = edit.getAttribute("data-edit-tx");
          const tx = state.transactions.find((t) => t.id === id);
          if (!tx) return;
          openEditTxSheet(tx);
        }
      });

      freeListEl.addEventListener("click", (e) => {
        const allocBtn = e.target.closest("[data-alloc]");
        const unallocBtn = e.target.closest("[data-unalloc]");
        if (allocBtn) {
          const id = allocBtn.getAttribute("data-alloc");
          const p = state.monthlyPayments.find((x) => x.id === id);
          if (!p) return;
          openAllocSheet(p);
          return;
        }
        if (unallocBtn) {
          const id = unallocBtn.getAttribute("data-unalloc");
          const p = state.monthlyPayments.find((x) => x.id === id);
          if (!p) return;
          if (!confirm("Отменить всё распределение по этой цели?")) return;
          p.allocated = 0;
          saveState();
        }
      });

      paymentsCard
        .querySelector("#btn-add-monthly")
        .addEventListener("click", () => openMonthlySheet());
      mpListEl.addEventListener("click", (e) => {
        const del = e.target.closest("[data-del-mp]");
        if (!del) return;
        const id = del.getAttribute("data-del-mp");
        if (!confirm("Удалить эту ежемесячную цель?")) return;
        state.monthlyPayments = state.monthlyPayments.filter(
          (p) => p.id !== id
        );
        saveState();
      });

      shortCard
        .querySelector("#btn-add-short-goal")
        .addEventListener("click", () => openShortGoalSheet());
      shortListEl.addEventListener("click", (e) => {
        const open = e.target.closest("[data-open-sched]");
        const del = e.target.closest("[data-del-sg]");
        if (open) {
          const id = open.getAttribute("data-open-sched");
          const g = state.shortGoals.find((x) => x.id === id);
          if (!g) return;
          openSchedSheet(g);
        }
        if (del) {
          const id = del.getAttribute("data-del-sg");
          if (!confirm("Удалить эту финансовую цель?")) return;
          state.shortGoals = state.shortGoals.filter((g) => g.id !== id);
          saveState();
        }
      });
    }

    // sheets: finance

    function openIncomeSheet() {
      openSheet(
        "Добавить доход",
        `
        <div class="field-group">
          <div class="field-label">Сумма</div>
          <input type="number" id="inc-amount" class="field-input" inputmode="decimal" />
        </div>
        <div class="field-group">
          <div class="field-label">Описание (опционально)</div>
          <input type="text" id="inc-note" class="field-input" />
        </div>
        <div class="field-group">
          <div class="field-label">Теги</div>
          <input type="text" id="inc-tags" class="field-input" placeholder="через запятую" />
        </div>
        <div class="field-group">
          <div class="field-label">Дата</div>
          <input type="date" id="inc-date" class="field-input" value="${todayISO()}" />
        </div>
        <button class="btn btn-primary" id="inc-save">сохранить</button>
      `
      );
      const amountEl = document.getElementById("inc-amount");
      amountEl.focus();
      document.getElementById("inc-save").addEventListener("click", () => {
        const val = parseFloat(amountEl.value.replace(",", "."));
        if (!val || val <= 0) return;
        const note = document.getElementById("inc-note").value.trim();
        const tags = parseTags(
          document.getElementById("inc-tags").value.trim()
        );
        const dateISO =
          document.getElementById("inc-date").value || todayISO();
        const tx = {
          id: uuid(),
          type: "income",
          amount: Math.round(val),
          note,
          tags,
          dateISO
        };
        state.transactions.push(tx);
        state.balance += tx.amount;
        saveState();
        closeSheet();
      });
    }

    function openExpenseSheet() {
      const templatesHTML = state.expenseTemplates.length
        ? `
        <div class="field-group">
          <div class="field-label">Шаблоны</div>
          <div class="chip-row" id="tmpl-row">
            ${state.expenseTemplates
              .map(
                (t) =>
                  `<button class="chip" data-tmpl-id="${t.id}">${t.title} · ${t.amount.toLocaleString(
                    "ru-RU"
                  )} ₽</button>`
              )
              .join("")}
          </div>
        </div>
        `
        : "";

      openSheet(
        "Добавить расход",
        `
        <div class="field-group">
          <div class="field-label">Сумма</div>
          <input type="number" id="exp-amount" class="field-input" inputmode="decimal" />
          <div class="helper-text">только сумма, детали можно добавить позже из истории</div>
        </div>
        ${templatesHTML}
        <button class="btn btn-primary" id="exp-save">сохранить</button>
      `
      );
      const amountEl = document.getElementById("exp-amount");
      amountEl.focus();

      const tmplRow = document.getElementById("tmpl-row");
      if (tmplRow) {
        tmplRow.addEventListener("click", (e) => {
          const chip = e.target.closest("[data-tmpl-id]");
          if (!chip) return;
          const id = chip.getAttribute("data-tmpl-id");
          const tmpl = state.expenseTemplates.find((t) => t.id === id);
          if (!tmpl) return;
          amountEl.value = tmpl.amount;
        });
      }

      document.getElementById("exp-save").addEventListener("click", () => {
        const val = parseFloat(amountEl.value.replace(",", "."));
        if (!val || val <= 0) return;
        const tx = {
          id: uuid(),
          type: "expense",
          amount: Math.round(val),
          note: "",
          tags: [],
          dateISO: todayISO()
        };
        state.transactions.push(tx);
        state.balance -= tx.amount;
        saveState();
        closeSheet();
      });
    }

    function openEditTxSheet(tx) {
      openSheet(
        "Редактировать операцию",
        `
        <div class="field-group">
          <div class="field-label">Сумма</div>
          <input type="number" id="tx-amount" class="field-input" inputmode="decimal" value="${tx.amount}" />
        </div>
        <div class="field-group">
          <div class="field-label">Описание</div>
          <input type="text" id="tx-note" class="field-input" value="${tx.note || ""}" />
        </div>
        <div class="field-group">
          <div class="field-label">Теги</div>
          <input type="text" id="tx-tags" class="field-input" value="${(tx.tags || []).join(
            ", "
          )}" />
        </div>
        <div class="field-group">
          <div class="field-label">Дата</div>
          <input type="date" id="tx-date" class="field-input" value="${tx.dateISO}" />
        </div>
        <button class="btn btn-primary" id="tx-save">сохранить</button>
      `
      );
      document.getElementById("tx-amount").focus();
      document.getElementById("tx-save").addEventListener("click", () => {
        const newAmount = parseFloat(
          document.getElementById("tx-amount").value.replace(",", ".")
        );
        if (!newAmount || newAmount <= 0) return;
        const prevAmount = tx.amount;
        if (newAmount !== prevAmount) {
          const diff = Math.round(newAmount) - prevAmount;
          if (tx.type === "income") state.balance += diff;
          else state.balance -= diff;
          tx.amount = Math.round(newAmount);
        }
        tx.note = document.getElementById("tx-note").value.trim();
        tx.tags = parseTags(
          document.getElementById("tx-tags").value.trim()
        );
        tx.dateISO =
          document.getElementById("tx-date").value || tx.dateISO;
        saveState();
        closeSheet();
      });
    }

    function openBalanceSheet() {
      openSheet(
        "Настроить баланс",
        `
        <div class="field-group">
          <div class="field-label">Баланс на руках, ₽</div>
          <input type="number" id="bal-val" class="field-input" inputmode="decimal" value="${state.balance}" />
          <div class="helper-text">баланс обновится, операции не изменятся</div>
        </div>
        <button class="btn btn-primary" id="bal-save">сохранить</button>
      `
      );
      const inp = document.getElementById("bal-val");
      inp.focus();
      document.getElementById("bal-save").addEventListener("click", () => {
        const val = parseFloat(inp.value.replace(",", "."));
        if (Number.isNaN(val)) return;
        state.balance = Math.round(val);
        saveState();
        closeSheet();
      });
    }

    function openMonthlySheet() {
      openSheet(
        "Новая ежемесячная цель",
        `
        <div class="field-group">
          <div class="field-label">Название</div>
          <input type="text" id="mp-title" class="field-input" />
        </div>
        <div class="field-group field-row">
          <div style="flex:1;">
            <div class="field-label">Сумма, ₽</div>
            <input type="number" id="mp-amount" class="field-input" inputmode="decimal" />
          </div>
          <div style="flex:1;">
            <div class="field-label">День месяца</div>
            <input type="number" id="mp-day" class="field-input" min="1" max="31" />
          </div>
        </div>
        <div class="field-group">
          <div class="field-label">Описание (опционально)</div>
          <input type="text" id="mp-desc" class="field-input" />
        </div>
        <div class="field-group">
          <label class="field-label">
            <input type="checkbox" id="mp-priority" />
            высокий приоритет
          </label>
        </div>
        <div class="field-group">
          <div class="field-label">Теги</div>
          <input type="text" id="mp-tags" class="field-input" placeholder="через запятую" />
        </div>
        <button class="btn btn-primary" id="mp-save">создать</button>
      `
      );
      document.getElementById("mp-title").focus();
      document.getElementById("mp-save").addEventListener("click", () => {
        const title = document.getElementById("mp-title").value.trim();
        if (!title) return;
        const amountVal = parseFloat(
          document.getElementById("mp-amount").value.replace(",", ".")
        );
        if (!amountVal || amountVal <= 0) return;
        const day = parseInt(
          document.getElementById("mp-day").value,
          10
        );
        if (!day || day < 1 || day > 31) return;
        const desc = document.getElementById("mp-desc").value.trim();
        const priority = document.getElementById("mp-priority").checked;
        const tags = parseTags(
          document.getElementById("mp-tags").value.trim()
        );
        state.monthlyPayments.push({
          id: uuid(),
          title,
          amount: Math.round(amountVal),
          dayOfMonth: day,
          description: desc,
          priority,
          tags,
          allocated: 0
        });
        saveState();
        closeSheet();
      });
    }

    function openShortGoalSheet() {
      const today = todayISO();
      openSheet(
        "Новая финансовая цель",
        `
        <div class="field-group">
          <div class="field-label">Название</div>
          <input type="text" id="sg-title" class="field-input" />
        </div>
        <div class="field-group field-row">
          <div style="flex:1;">
            <div class="field-label">Сумма, ₽</div>
            <input type="number" id="sg-amount" class="field-input" inputmode="decimal" />
          </div>
          <div style="flex:1;">
            <div class="field-label">Дедлайн</div>
            <input type="date" id="sg-deadline" class="field-input" min="${today}" value="${today}" />
          </div>
        </div>
        <div class="field-group">
          <div class="field-label">Дни без заработка</div>
          <div class="helper-text">отметь даты между сегодня и дедлайном, когда точно не будешь работать</div>
          <div class="chip-row" id="sg-calendar"></div>
        </div>
        <div class="field-group">
          <div class="field-label">Теги</div>
          <input type="text" id="sg-tags" class="field-input" placeholder="через запятую" />
        </div>
        <button class="btn btn-primary" id="sg-save">создать</button>
      `
      );

      const calEl = document.getElementById("sg-calendar");
      const deadlineEl = document.getElementById("sg-deadline");
      const nonWorking = new Set();

      function rebuildCalendar() {
        const deadline = deadlineEl.value || today;
        calEl.innerHTML = "";
        let cursor = today;
        while (compareISO(cursor, deadline) <= 0) {
          const dLabel = formatDate(cursor);
          const w = weekdayShort(cursor);
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className =
            "calendar-chip" + (nonWorking.has(cursor) ? " selected" : "");
          btn.textContent = `${dLabel} (${w})`;
          btn.dataset.date = cursor;
          btn.addEventListener("click", () => {
            if (nonWorking.has(cursor)) {
              nonWorking.delete(cursor);
              btn.classList.remove("selected");
            } else {
              nonWorking.add(cursor);
              btn.classList.add("selected");
            }
          });
          calEl.appendChild(btn);
          cursor = addDaysISO(cursor, 1);
        }
      }

      deadlineEl.addEventListener("change", rebuildCalendar);
      rebuildCalendar();

      document.getElementById("sg-title").focus();

      document.getElementById("sg-save").addEventListener("click", () => {
        const title = document.getElementById("sg-title").value.trim();
        if (!title) return;
        const amountVal = parseFloat(
          document.getElementById("sg-amount").value.replace(",", ".")
        );
        if (!amountVal || amountVal <= 0) return;
        const deadline = deadlineEl.value || today;
        const tags = parseTags(
          document.getElementById("sg-tags").value.trim()
        );
        const nonWorkingArr = Array.from(nonWorking);
        const goal = createScheduleForShortGoal(
          title,
          Math.round(amountVal),
          today,
          deadline,
          nonWorkingArr,
          tags
        );
        state.shortGoals.push(goal);
        saveState();
        closeSheet();
      });
    }

    function createScheduleForShortGoal(
      title,
      totalAmount,
      createdISO,
      deadlineISO,
      nonWorkingDates,
      tags,
      existingSchedule
    ) {
      const skipSet = new Set(nonWorkingDates || []);
      const dates = [];
      let cursor = createdISO;
      while (compareISO(cursor, deadlineISO) <= 0) {
        if (!skipSet.has(cursor)) dates.push(cursor);
        cursor = addDaysISO(cursor, 1);
      }
      const workDays = dates.length || 1;
      const perDay = Math.floor(totalAmount / workDays);
      let remainder = totalAmount - perDay * workDays;

      const schedule = dates.map((date, idx) => {
        const extra = remainder > 0 ? 1 : 0;
        if (remainder > 0) remainder -= 1;
        const planned = perDay + extra;
        let prevStatus = "pending";
        if (existingSchedule) {
          const prev = existingSchedule.find((d) => d.dateISO === date);
          if (prev) prevStatus = prev.status || "pending";
        }
        return {
          dateISO: date,
          planned,
          status: prevStatus
        };
      });

      return {
        id: uuid(),
        title,
        totalAmount,
        remaining: totalAmount,
        createdISO,
        deadlineISO,
        schedule,
        tags: tags || []
      };
    }

    function recalcRemainingForShortGoal(g) {
      let doneSum = 0;
      for (const d of g.schedule) {
        if (d.status === "done") doneSum += d.planned || 0;
      }
      g.remaining = Math.max(0, g.totalAmount - doneSum);
    }

    function redistributeAfterSkip(g) {
      recalcRemainingForShortGoal(g);
      const pending = g.schedule.filter((d) => d.status === "pending");
      if (!pending.length) return;
      const remainingAmount = g.remaining;
      const perDay = Math.floor(remainingAmount / pending.length);
      let remainder = remainingAmount - perDay * pending.length;
      for (const d of g.schedule) {
        if (d.status === "pending") {
          const extra = remainder > 0 ? 1 : 0;
          if (remainder > 0) remainder -= 1;
          d.planned = perDay + extra;
        }
      }
    }

    function openSchedSheet(g) {
      recalcRemainingForShortGoal(g);
      openSheet(
        g.title,
        `
        <div class="field-group">
          <div class="field-label">Остаток</div>
          <div class="balance-value" id="sg-rem">${g.remaining.toLocaleString(
            "ru-RU"
          )} ₽</div>
          <div class="helper-text">дедлайн: ${formatDate(
            g.deadlineISO
          )}</div>
        </div>
        <div class="field-group field-row">
          <button class="btn btn-small btn-outline" id="sg-edit-deadline">изменить дедлайн</button>
          <button class="btn btn-small btn-outline" id="sg-edit-amount">изменить сумму</button>
        </div>
        <div class="section-title">
          <span>Расписание</span>
        </div>
        <div class="schedule-list" id="sched-list"></div>
      `
      );

      const listEl = document.getElementById("sched-list");
      function renderList() {
        const sorted = [...g.schedule].sort((a, b) =>
          compareISO(a.dateISO, b.dateISO)
        );
        listEl.innerHTML = sorted
          .map((d) => {
            const label =
              d.status === "done"
                ? "выполнено"
                : d.status === "skipped"
                ? "пропущено"
                : "ожидание";
            return `
            <div class="schedule-item">
              <div class="sched-left">
                <span class="sched-date">${formatDate(
                  d.dateISO
                )} (${weekdayShort(d.dateISO)})</span>
                <span class="sched-plan">план: ${d.planned.toLocaleString(
                  "ru-RU"
                )} ₽</span>
                <span class="sched-status ${d.status}">${label}</span>
              </div>
              <div class="sched-btn-row">
                <button class="sched-btn sched-btn-primary" data-act="done" data-date="${
                  d.dateISO
                }">сделал</button>
                <button class="sched-btn" data-act="skip" data-date="${
                  d.dateISO
                }">пропустить</button>
                <button class="sched-btn" data-act="reset" data-date="${
                  d.dateISO
                }">сбросить</button>
              </div>
            </div>
          `;
          })
          .join("");
      }

      function updateHeader() {
        recalcRemainingForShortGoal(g);
        document.getElementById("sg-rem").textContent =
          g.remaining.toLocaleString("ru-RU") + " ₽";
      }

      renderList();
      updateHeader();

      listEl.addEventListener("click", (e) => {
        const btn = e.target.closest("[data-act]");
        if (!btn) return;
        const act = btn.getAttribute("data-act");
        const date = btn.getAttribute("data-date");
        const item = g.schedule.find((d) => d.dateISO === date);
        if (!item) return;
        const prev = item.status || "pending";
        if (act === "done") {
          item.status = "done";
        } else if (act === "skip") {
          item.status = "skipped";
        } else if (act === "reset") {
          item.status = "pending";
        }
        // перераспределение только на skip / reset
        redistributeAfterSkip(g);
        saveState();
        renderList();
        updateHeader();
      });

      document
        .getElementById("sg-edit-deadline")
        .addEventListener("click", () => {
          const newDate = prompt(
            "Новый дедлайн (ГГГГ-ММ-ДД)",
            g.deadlineISO
          );
          if (!newDate) return;
          const d = new Date(newDate);
          if (Number.isNaN(d.getTime())) return;
          const updated = createScheduleForShortGoal(
            g.title,
            g.totalAmount,
            g.createdISO,
            newDate,
            [],
            g.tags,
            g.schedule
          );
          g.deadlineISO = updated.deadlineISO;
          g.schedule = updated.schedule;
          recalcRemainingForShortGoal(g);
          saveState();
          renderList();
          updateHeader();
        });

      document
        .getElementById("sg-edit-amount")
        .addEventListener("click", () => {
          const valStr = prompt(
            "Новая сумма цели, ₽",
            g.totalAmount
          );
          if (!valStr) return;
          const val = parseFloat(valStr.replace(",", "."));
          if (!val || val <= 0) return;
          g.totalAmount = Math.round(val);
          const updated = createScheduleForShortGoal(
            g.title,
            g.totalAmount,
            g.createdISO,
            g.deadlineISO,
            [],
            g.tags,
            g.schedule
          );
          g.schedule = updated.schedule;
          recalcRemainingForShortGoal(g);
          saveState();
          renderList();
          updateHeader();
        });
    }

    function openAllocSheet(p) {
      openSheet(
        "Распределить на " + p.title,
        `
        <div class="field-group">
          <div class="field-label">Сумма, ₽</div>
          <input type="number" id="al-amount" class="field-input" inputmode="decimal" />
          <div class="helper-text">баланс на руках не меняется автоматически, ты просто фиксируешь, сколько выделил на эту цель</div>
        </div>
        <button class="btn btn-primary" id="al-save">сохранить</button>
      `
      );
      const inp = document.getElementById("al-amount");
      inp.focus();
      document.getElementById("al-save").addEventListener("click", () => {
        const val = parseFloat(inp.value.replace(",", "."));
        if (!val || val <= 0) return;
        p.allocated = (p.allocated || 0) + Math.round(val);
        saveState();
        closeSheet();
      });
    }

    // ===== GOALS TAB =====

    function renderGoals() {
      contentEl.innerHTML = "";

      const card = document.createElement("section");
      card.className = "card";
      card.innerHTML = `
        <div class="card-header">
          <div>
            <div class="card-title">Цели</div>
            <div class="card-subtitle">дневные, недельные, месячные и без срока</div>
          </div>
          <button class="btn btn-small btn-outline" id="btn-add-goal">+ цель</button>
        </div>
        <div id="goals-body"></div>
      `;
      contentEl.appendChild(card);

      const body = card.querySelector("#goals-body");

      const types = ["day", "week", "month", "none"];
      const typeLabels = {
        day: "Дневные цели",
        week: "Недельные цели",
        month: "Месячные цели",
        none: "Цели без срока"
      };

      const goalsByType = {
        day: [],
        week: [],
        month: [],
        none: []
      };
      for (const g of state.goals) {
        goalsByType[g.type || "none"].push(g);
      }

      types.forEach((type) => {
        const list = goalsByType[type];
        if (!list.length) return;
        const group = document.createElement("div");
        group.className = "goals-group";
        group.innerHTML = `
          <div class="section-title">
            <span>${typeLabels[type]}</span>
          </div>
        `;
        const container = document.createElement("div");
        list
          .slice()
          .sort((a, b) =>
            (a.deadlineISO || "") < (b.deadlineISO || "") ? -1 : 1
          )
          .forEach((g) => {
            const subs = g.subtasks || [];
            const doneSubs = subs.filter((s) => s.done).length;
            const pct =
              subs.length > 0
                ? Math.round((doneSubs / subs.length) * 100)
                : g.done
                ? 100
                : 0;
            const box = document.createElement("div");
            box.className = "goal-box" + (g.done ? " done" : "");
            box.innerHTML = `
              <div class="goal-box-header">
                <div class="goal-main">
                  ${progressCircleHTML(pct)}
                  <div>
                    <div class="goal-title-text">${g.title}</div>
                    <div class="small-inline">
                      ${
                        g.deadlineISO
                          ? `до ${formatDate(g.deadlineISO)}`
                          : "без срока"
                      }
                    </div>
                  </div>
                </div>
                <div class="goal-actions">
                  <span class="goal-type-pill" data-type="${g.type}">
                    ${
                      g.type === "day"
                        ? "день"
                        : g.type === "week"
                        ? "неделя"
                        : g.type === "month"
                        ? "месяц"
                        : "без срока"
                    }
                  </span>
                  <button class="btn btn-small btn-outline" data-edit-goal="${
                    g.id
                  }">изменить</button>
                  <button class="btn btn-small btn-outline" data-done-goal="${
                    g.id
                  }">${g.done ? "снять" : "готово"}</button>
                  <button class="btn btn-small btn-outline" data-archive-goal="${
                    g.id
                  }">в историю</button>
                </div>
              </div>
              ${
                g.description
                  ? `<div class="muted" style="margin-top:4px;">${g.description}</div>`
                  : ""
              }
              ${
                subs.length
                  ? `
                    <ul class="subtask-list">
                      ${subs
                        .map(
                          (s) => `
                          <li class="subtask-item">
                            <label>
                              <input type="checkbox" class="subtask-toggle" data-goal-id="${
                                g.id
                              }" data-sub-id="${s.id}" ${
                            s.done ? "checked" : ""
                          } />
                              <span>${s.title}</span>
                            </label>
                          </li>
                        `
                        )
                        .join("")}
                    </ul>
                  `
                  : ""
              }
              ${tagsToHTML(g.tags)}
            `;
            container.appendChild(box);
          });
        group.appendChild(container);
        body.appendChild(group);
      });

      const history = state.goalHistory || [];
      if (history.length) {
        const histCard = document.createElement("div");
        histCard.className = "goals-group";
        histCard.innerHTML = `
          <div class="section-title">
            <span>История</span>
          </div>
          <div class="list">
            ${history
              .slice()
              .sort((a, b) =>
                (a.archivedAt || "") < (b.archivedAt || "") ? 1 : -1
              )
              .map(
                (g) => `
              <div class="tx-item">
                <div class="tx-main">
                  <span>${g.title}</span>
                  <span class="goal-type-pill" data-type="${g.type}">
                    ${
                      g.type === "day"
                        ? "день"
                        : g.type === "week"
                        ? "неделя"
                        : g.type === "month"
                        ? "месяц"
                        : "без срока"
                    }
                  </span>
                </div>
                <div class="tx-meta">
                  <span>архив: ${formatDate(g.archivedAt)}</span>
                  <span>${g.deadlineISO ? "до " + formatDate(g.deadlineISO) : ""}</span>
                </div>
              </div>
            `
              )
              .join("")}
          </div>
        `;
        body.appendChild(histCard);
      }

      card
        .querySelector("#btn-add-goal")
        .addEventListener("click", () => openGoalSheet());

      body.addEventListener("change", (e) => {
        const subToggle = e.target.closest(".subtask-toggle");
        if (subToggle) {
          const goalId = subToggle.getAttribute("data-goal-id");
          const subId = subToggle.getAttribute("data-sub-id");
          const g = state.goals.find((x) => x.id === goalId);
          if (!g) return;
          const s = (g.subtasks || []).find((x) => x.id === subId);
          if (!s) return;
          s.done = subToggle.checked;
          const subs = g.subtasks || [];
          if (subs.length && subs.every((x) => x.done)) {
            g.done = true;
          }
          saveState();
        }
      });

      body.addEventListener("click", (e) => {
        const editBtn = e.target.closest("[data-edit-goal]");
        const doneBtn = e.target.closest("[data-done-goal]");
        const archBtn = e.target.closest("[data-archive-goal]");
        if (editBtn) {
          const id = editBtn.getAttribute("data-edit-goal");
          const g = state.goals.find((x) => x.id === id);
          if (!g) return;
          openGoalEditSheet(g);
        }
        if (doneBtn) {
          const id = doneBtn.getAttribute("data-done-goal");
          const g = state.goals.find((x) => x.id === id);
          if (!g) return;
          g.done = !g.done;
          saveState();
        }
        if (archBtn) {
          const id = archBtn.getAttribute("data-archive-goal");
          const idx = state.goals.findIndex((x) => x.id === id);
          if (idx === -1) return;
          const g = state.goals[idx];
          g.archivedAt = todayISO();
          state.goalHistory.push(g);
          state.goals.splice(idx, 1);
          saveState();
        }
      });
    }

    function openGoalSheet() {
      const today = todayISO();
      openSheet(
        "Новая цель",
        `
        <div class="field-group">
          <div class="field-label">Название</div>
          <input type="text" id="g-title" class="field-input" />
        </div>
        <div class="field-group">
          <div class="field-label">Описание</div>
          <textarea id="g-desc" class="field-textarea"></textarea>
        </div>
        <div class="field-group">
          <div class="field-label">Тип</div>
          <select id="g-type" class="field-select">
            <option value="day">на день</option>
            <option value="week">на неделю</option>
            <option value="month">на месяц</option>
            <option value="none">без срока</option>
          </select>
        </div>
        <div class="field-group">
          <div class="field-label">Дедлайн (опционально)</div>
          <input type="date" id="g-deadline" class="field-input" min="${today}" />
        </div>
        <div class="field-group">
          <div class="field-label">Теги</div>
          <input type="text" id="g-tags" class="field-input" placeholder="через запятую" />
        </div>
        <div class="field-group">
          <div class="field-label">Микроцели</div>
          <div id="sub-list"></div>
          <button class="btn btn-small btn-outline" type="button" id="btn-add-sub">+ микроцель</button>
        </div>
        <button class="btn btn-primary" id="g-save">создать</button>
      `
      );
      const subList = document.getElementById("sub-list");
      function addSubRow(value) {
        const row = document.createElement("div");
        row.className = "field-row";
        row.innerHTML = `
          <input type="text" class="field-input sub-title" value="${value || ""}" placeholder="шаг" />
        `;
        subList.appendChild(row);
      }
      document
        .getElementById("btn-add-sub")
        .addEventListener("click", () => addSubRow(""));
      document.getElementById("g-title").focus();

      document.getElementById("g-save").addEventListener("click", () => {
        const title = document.getElementById("g-title").value.trim();
        if (!title) return;
        const desc = document.getElementById("g-desc").value.trim();
        const type = document.getElementById("g-type").value;
        const deadline =
          document.getElementById("g-deadline").value || null;
        const tags = parseTags(
          document.getElementById("g-tags").value.trim()
        );
        const subsInp = subList.querySelectorAll(".sub-title");
        const subs = Array.from(subsInp)
          .map((i) => i.value.trim())
          .filter(Boolean)
          .map((t) => ({ id: uuid(), title: t, done: false }));
        const goal = {
          id: uuid(),
          title,
          description: desc,
          type,
          createdISO: today,
          deadlineISO: deadline,
          tags,
          subtasks: subs,
          done: false
        };
        state.goals.push(goal);
        saveState();
        closeSheet();
      });
    }

    function openGoalEditSheet(g) {
      const today = todayISO();
      openSheet(
        "Изменить цель",
        `
        <div class="field-group">
          <div class="field-label">Название</div>
          <input type="text" id="g-title" class="field-input" value="${g.title}" />
        </div>
        <div class="field-group">
          <div class="field-label">Описание</div>
          <textarea id="g-desc" class="field-textarea">${g.description || ""}</textarea>
        </div>
        <div class="field-group">
          <div class="field-label">Тип</div>
          <select id="g-type" class="field-select">
            <option value="day">на день</option>
            <option value="week">на неделю</option>
            <option value="month">на месяц</option>
            <option value="none">без срока</option>
          </select>
        </div>
        <div class="field-group">
          <div class="field-label">Дедлайн (опционально)</div>
          <input type="date" id="g-deadline" class="field-input" min="${today}" value="${g.deadlineISO || ""}" />
        </div>
        <div class="field-group">
          <div class="field-label">Теги</div>
          <input type="text" id="g-tags" class="field-input" value="${(g.tags || []).join(
            ", "
          )}" />
        </div>
        <div class="field-group">
          <div class="field-label">Микроцели</div>
          <div id="sub-list"></div>
          <button class="btn btn-small btn-outline" type="button" id="btn-add-sub">+ микроцель</button>
        </div>
        <button class="btn btn-primary" id="g-save">сохранить</button>
      `
      );
      const typeEl = document.getElementById("g-type");
      typeEl.value = g.type || "none";
      const subList = document.getElementById("sub-list");
      (g.subtasks || []).forEach((s) => addSubRowEdit(subList, s.title, s.id));

      function addSubRowEdit(parent, value, id) {
        const row = document.createElement("div");
        row.className = "field-row";
        row.dataset.subId = id || uuid();
        row.innerHTML = `
          <input type="text" class="field-input sub-title" value="${value || ""}" />
        `;
        parent.appendChild(row);
      }

      document
        .getElementById("btn-add-sub")
        .addEventListener("click", () =>
          addSubRowEdit(subList, "", uuid())
        );

      document.getElementById("g-title").focus();

      document.getElementById("g-save").addEventListener("click", () => {
        const title = document.getElementById("g-title").value.trim();
        if (!title) return;
        g.title = title;
        g.description = document.getElementById("g-desc").value.trim();
        g.type = typeEl.value;
        g.deadlineISO =
          document.getElementById("g-deadline").value || null;
        g.tags = parseTags(
          document.getElementById("g-tags").value.trim()
        );
        const rows = subList.querySelectorAll(".field-row");
        const subs = [];
        rows.forEach((row) => {
          const val = row.querySelector(".sub-title").value.trim();
          const id = row.dataset.subId || uuid();
          if (!val) return;
          const existing = (g.subtasks || []).find((s) => s.id === id);
          subs.push({
            id,
            title: val,
            done: existing ? existing.done : false
          });
        });
        g.subtasks = subs;
        if (subs.length && subs.every((s) => s.done)) g.done = true;
        saveState();
        closeSheet();
      });
    }

    // ===== ANALYTICS TAB =====

    function renderAnalytics() {
      contentEl.innerHTML = "";

      const card = document.createElement("section");
      card.className = "card";
      card.innerHTML = `
        <div class="card-header">
          <div>
            <div class="card-title">Аналитика</div>
            <div class="card-subtitle">краткий визуальный срез</div>
          </div>
          <div class="btn-row" style="margin:0;gap:4px;">
            <button class="btn btn-small ${
              analyticsMode === "finance" ? "btn-primary" : "btn-outline"
            }" data-a-mode="finance">финансы</button>
            <button class="btn btn-small ${
              analyticsMode === "goals" ? "btn-primary" : "btn-outline"
            }" data-a-mode="goals">цели</button>
          </div>
        </div>
        <div id="analytics-body"></div>
      `;
      contentEl.appendChild(card);

      const body = card.querySelector("#analytics-body");
      if (analyticsMode === "finance") {
        renderFinanceAnalytics(body);
      } else {
        renderGoalsAnalytics(body);
      }

      card.querySelectorAll("[data-a-mode]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const m = btn.getAttribute("data-a-mode");
          if (m === analyticsMode) return;
          analyticsMode = m;
          renderAnalytics();
        });
      });
    }

    function renderFinanceAnalytics(container) {
      const today = todayISO();
      const [y, m] = today.split("-");
      const monthPrefix = `${y}-${m}`;
      const txMonth = state.transactions.filter((t) =>
        t.dateISO && t.dateISO.startsWith(monthPrefix)
      );
      let income = 0;
      let expense = 0;
      const daysMap = {};
      for (const tx of txMonth) {
        if (!daysMap[tx.dateISO]) {
          daysMap[tx.dateISO] = { income: 0, expense: 0 };
        }
        if (tx.type === "income") {
          income += tx.amount;
          daysMap[tx.dateISO].income += tx.amount;
        } else {
          expense += tx.amount;
          daysMap[tx.dateISO].expense += tx.amount;
        }
      }
      const net = income - expense;
      const last7 = [];
      for (let i = 6; i >= 0; i--) {
        const d = addDaysISO(today, -i);
        const row = daysMap[d] || { income: 0, expense: 0 };
        last7.push({ dateISO: d, ...row });
      }

      container.innerHTML = `
        <div class="section-title">
          <span>Месяц</span>
        </div>
        <div class="analytics-grid">
          <div class="analytics-item">
            <div class="analytics-label">доход</div>
            <div class="analytics-value">+${income.toLocaleString(
              "ru-RU"
            )} ₽</div>
          </div>
          <div class="analytics-item">
            <div class="analytics-label">расход</div>
            <div class="analytics-value">−${expense.toLocaleString(
              "ru-RU"
            )} ₽</div>
          </div>
          <div class="analytics-item">
            <div class="analytics-label">итог</div>
            <div class="analytics-value">${net >= 0 ? "+" : "−"}${Math.abs(
        net
      ).toLocaleString("ru-RU")} ₽</div>
          </div>
          <div class="analytics-item">
            <div class="analytics-label">операций в месяце</div>
            <div class="analytics-value">${txMonth.length}</div>
          </div>
        </div>
        <div class="section-title" style="margin-top:8px;">
          <span>Последние 7 дней</span>
        </div>
        ${last7
          .map((d) => {
            const netDay = d.income - d.expense;
            const total = d.income + d.expense || 1;
            const shareIncome = (d.income / total) * 100;
            return `
            <div class="day-row">
              <div class="day-main">
                <span>${formatDate(d.dateISO)}</span>
                <span>${netDay === 0 ? "0 ₽" : (netDay > 0 ? "+" : "−") + Math.abs(
              netDay
            ).toLocaleString("ru-RU")} ₽</span>
              </div>
              <div class="day-bar">
                <div class="day-bar-fill" style="width:${shareIncome}%;"></div>
              </div>
            </div>
          `;
          })
          .join("")}
      `;
    }

    function renderGoalsAnalytics(container) {
      const goals = state.goals;
      const total = goals.length;
      const done = goals.filter((g) => g.done).length;
      const dayGoals = goals.filter((g) => g.type === "day");
      const weekGoals = goals.filter((g) => g.type === "week");
      const monthGoals = goals.filter((g) => g.type === "month");
      const noneGoals = goals.filter((g) => g.type === "none");

      container.innerHTML = `
        <div class="section-title">
          <span>Общий прогресс</span>
        </div>
        <div class="analytics-grid">
          <div class="analytics-item">
            <div class="analytics-label">всего целей</div>
            <div class="analytics-value">${total}</div>
          </div>
          <div class="analytics-item">
            <div class="analytics-label">выполнено</div>
            <div class="analytics-value">${done}</div>
          </div>
          <div class="analytics-item">
            <div class="analytics-label">дневные/недельные</div>
            <div class="analytics-value">${dayGoals.length} / ${
        weekGoals.length
      }</div>
          </div>
          <div class="analytics-item">
            <div class="analytics-label">месячные/без срока</div>
            <div class="analytics-value">${monthGoals.length} / ${
        noneGoals.length
      }</div>
          </div>
        </div>
        <div class="section-title" style="margin-top:8px;">
          <span>Фокус на сегодня</span>
        </div>
        <div class="muted">
          дневные активные: ${
            dayGoals.filter((g) => !g.done).length
          } · недельные активные: ${
        weekGoals.filter((g) => !g.done).length
      }
        </div>
      `;
    }

    // ===== ACHIEVEMENTS TAB =====

    function renderAchievements() {
      contentEl.innerHTML = "";

      const card = document.createElement("section");
      card.className = "card";
      const stats = computeAchievementsStats();

      card.innerHTML = `
        <div class="card-header">
          <div>
            <div class="card-title">Достижения</div>
            <div class="card-subtitle">принципы, подтверждённые действиями</div>
          </div>
        </div>
        <div class="badge">
          <div class="badge-header">
            <div class="badge-title">Сделано, а не придумано</div>
            <div class="badge-level">уровень ${stats.actionLevel}</div>
          </div>
          <div class="muted">
            дни, когда были и доходы, и выполненные цели.
          </div>
        </div>
        <div class="badge">
          <div class="badge-header">
            <div class="badge-title">Позже, но сделано</div>
            <div class="badge-level">уровень ${stats.lateLevel}</div>
          </div>
          <div class="muted">
            ежемесячные цели, закрытые с задержкой, но не проваленные.
          </div>
        </div>
        <div class="badge">
          <div class="badge-header">
            <div class="badge-title">Без свидетелей, но честно</div>
            <div class="badge-level">уровень ${stats.honestLevel}</div>
          </div>
          <div class="muted">
            мануальные правки баланса с последующим выравниванием по операциям.
          </div>
        </div>
      `;
      contentEl.appendChild(card);
    }

    function computeAchievementsStats() {
      const today = todayISO();
      const last30 = [];
      for (let i = 29; i >= 0; i--) {
        last30.push(addDaysISO(today, -i));
      }
      const txByDay = {};
      for (const tx of state.transactions) {
        if (!txByDay[tx.dateISO]) txByDay[tx.dateISO] = [];
        txByDay[tx.dateISO].push(tx);
      }
      const goalsByDay = {};
      for (const g of state.goals) {
        if (!g.done) continue;
        const day = g.createdISO || today;
        if (!goalsByDay[day]) goalsByDay[day] = [];
        goalsByDay[day].push(g);
      }
      let actionDays = 0;
      last30.forEach((d) => {
        const txs = txByDay[d] || [];
        const hasIncome = txs.some((t) => t.type === "income");
        const hasGoal = (goalsByDay[d] || []).length > 0;
        if (hasIncome && hasGoal) actionDays += 1;
      });
      const untracked = Math.abs(
        state.balance - expectedBalanceFromTx()
      );
      const actionLevel =
        actionDays >= 20 ? 3 : actionDays >= 10 ? 2 : actionDays >= 3 ? 1 : 0;
      const lateLevel = 0; // можно развить отдельно, пока заглушка
      const honestLevel =
        untracked === 0 ? 2 : untracked < 500 ? 1 : 0;
      return { actionLevel, lateLevel, honestLevel };
    }

    // ===== SETTINGS SHEET =====

    function openSettingsSheet() {
      const json = JSON.stringify(state, null, 2);
      openSheet(
        "Настройки",
        `
        <div class="field-group">
          <div class="field-label">Тема</div>
          <select id="theme-select" class="field-select">
            <option value="auto">авто</option>
            <option value="dark">тёмная</option>
            <option value="light">светлая</option>
          </select>
        </div>
        <div class="field-group">
          <div class="field-label">Шаблоны расходов</div>
          <div id="tmpl-list"></div>
          <button class="btn btn-small btn-outline" id="tmpl-add">+ шаблон</button>
        </div>
        <div class="field-group">
          <div class="field-label">Теги</div>
          <div id="tag-list"></div>
          <button class="btn btn-small btn-outline" id="tag-add">+ тег</button>
        </div>
        <div class="field-group">
          <div class="field-label">Экспорт</div>
          <textarea class="mono" readonly id="export-json">${json}</textarea>
          <button class="btn btn-small btn-outline" id="export-copy">скопировать</button>
        </div>
        <div class="field-group">
          <div class="field-label">Импорт</div>
          <textarea class="mono" id="import-json" placeholder="вставь сохранённый JSON и нажми &quot;импортировать&quot;"></textarea>
          <button class="btn btn-small btn-ghost" id="import-apply">импортировать</button>
        </div>
        <div class="field-group">
          <div class="field-label">Очистка</div>
          <button class="btn btn-ghost" id="btn-clear-all">очистить все данные</button>
        </div>
      `
      );
      const themeSelect = document.getElementById("theme-select");
      themeSelect.value = themeMode;
      themeSelect.addEventListener("change", () => {
        saveThemeMode(themeSelect.value);
      });

      const tmplList = document.getElementById("tmpl-list");
      function renderTmpl() {
        if (!state.expenseTemplates.length) {
          tmplList.innerHTML = `<div class="empty">шаблонов пока нет</div>`;
        } else {
          tmplList.innerHTML = state.expenseTemplates
            .map(
              (t) => `
            <div class="tx-item">
              <div class="tx-main">
                <span>${t.title}</span>
                <span class="tx-amount expense">${t.amount.toLocaleString(
                  "ru-RU"
                )} ₽</span>
              </div>
              <div class="tx-meta">
                <button class="btn btn-small btn-outline" data-del-tmpl="${
                  t.id
                }">удалить</button>
              </div>
            </div>
          `
            )
            .join("");
        }
      }
      renderTmpl();

      tmplList.addEventListener("click", (e) => {
        const del = e.target.closest("[data-del-tmpl]");
        if (!del) return;
        const id = del.getAttribute("data-del-tmpl");
        state.expenseTemplates = state.expenseTemplates.filter(
          (t) => t.id !== id
        );
        saveState();
        renderTmpl();
      });

      document
        .getElementById("tmpl-add")
        .addEventListener("click", () => {
          const title = prompt("Название шаблона", "Транспорт");
          if (!title) return;
          const amountStr = prompt("Сумма, ₽", "74");
          if (!amountStr) return;
          const val = parseFloat(amountStr.replace(",", "."));
          if (!val || val <= 0) return;
          state.expenseTemplates.push({
            id: uuid(),
            title: title.trim(),
            amount: Math.round(val)
          });
          saveState();
          renderTmpl();
        });

      const tagList = document.getElementById("tag-list");
      function renderTags() {
        if (!state.tagConfig.length) {
          tagList.innerHTML = `<div class="empty">тегов пока нет</div>`;
        } else {
          tagList.innerHTML = state.tagConfig
            .map(
              (t) => `
            <div class="tx-item">
              <div class="tx-main">
                <span>${t.icon || ""} #${t.name}</span>
                <span class="muted">${t.color || ""}</span>
              </div>
              <div class="tx-meta">
                <button class="btn btn-small btn-outline" data-del-tag="${
                  t.id
                }">удалить</button>
              </div>
            </div>
          `
            )
            .join("");
        }
      }
      renderTags();

      tagList.addEventListener("click", (e) => {
        const del = e.target.closest("[data-del-tag]");
        if (!del) return;
        const id = del.getAttribute("data-del-tag");
        state.tagConfig = state.tagConfig.filter((t) => t.id !== id);
        saveState();
        renderTags();
      });

      document.getElementById("tag-add").addEventListener("click", () => {
        const name = prompt("Название тега (без #)", "транспорт");
        if (!name) return;
        const icon = prompt(
          "Иконка (эмодзи, опционально)",
          "🚌"
        );
        const color = prompt(
          "Цвет (например, green, #22c55e — опционально)",
          ""
        );
        state.tagConfig.push({
          id: uuid(),
          name: name.trim(),
          icon: icon || "",
          color: color || ""
        });
        saveState();
        renderTags();
      });

      document
        .getElementById("export-copy")
        .addEventListener("click", async () => {
          const area = document.getElementById("export-json");
          try {
            if (navigator.clipboard?.writeText) {
              await navigator.clipboard.writeText(area.value);
            } else {
              area.focus();
              area.select();
            }
          } catch (e) {
            area.focus();
            area.select();
          }
        });

      document
        .getElementById("import-apply")
        .addEventListener("click", () => {
          const raw = document
            .getElementById("import-json")
            .value.trim();
          if (!raw) return;
          let parsed;
          try {
            parsed = JSON.parse(raw);
          } catch (e) {
            alert("Некорректный JSON");
            return;
          }
          if (!confirm("Перезаписать текущее состояние?")) return;
          state = { ...structuredClone(defaultState), ...parsed };
          localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
          state = loadState();
          render();
          closeSheet();
        });

      document
        .getElementById("btn-clear-all")
        .addEventListener("click", () => {
          if (!confirm("Точно удалить все данные?")) return;
          localStorage.removeItem(STORAGE_KEY);
          state = loadState();
          render();
          closeSheet();
        });
    }

    // initial render
    render();
  </script>
</body>
</html>
